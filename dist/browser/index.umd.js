(function (global, factory) {
	typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('ckeditor5')) :
	typeof define === 'function' && define.amd ? define(['exports', 'ckeditor5'], factory) :
	(global = typeof globalThis !== 'undefined' ? globalThis : global || self, factory(global.AiAgent = {}, global.CKEDITOR));
})(this, (function (exports, ckeditor5) { 'use strict';

	class r{constructor(){}static getInstance(){return r.instance||(r.instance=new r),r.instance}set uiComponent(e){this._uiComponent=e;}showError(e){this._uiComponent&&(console.log("Showing error message...",e),this._uiComponent.showGptErrorToolTip(e));}showLoader(e){this._uiComponent&&this._uiComponent.showLoader(e);}hideLoader(){this._uiComponent&&this._uiComponent.hideLoader();}}const a=r.getInstance(),l={"gpt-3.5-turbo":{minOutputTokens:1,maxOutputTokens:4096,maxInputContextTokens:16385},"gpt-4o":{minOutputTokens:0,maxOutputTokens:16384,maxInputContextTokens:128e3},"gpt-4o-mini":{minOutputTokens:1,maxOutputTokens:16384,maxInputContextTokens:128e3},"kavya-m1":{minOutputTokens:0,maxOutputTokens:16384,maxInputContextTokens:128e3}},c=["en","es","hi","nl"],d=["harassment","harassment/threatening","hate","hate/threatening","self-harm","self-harm/instructions","self-harm/intent","sexual","sexual/minors","violence","violence/graphic"];class u extends ckeditor5.Plugin{constructor(e){var t;super(e),this.PLACEHOLDER_TEXT_ID="slash-placeholder",this.GPT_RESPONSE_LOADER_ID="gpt-response-loader",this.GPT_RESPONSE_ERROR_ID="gpt-error",this.showErrorDuration=5e3;const n=e.config.get("aiAgent");this.showErrorDuration=null!==(t=null==n?void 0:n.showErrorDuration)&&void 0!==t?t:5e3;}static get pluginName(){return "AiAgentUI"}static get requires(){return [ckeditor5.Widget]}init(){try{a.uiComponent=this,this.initializeUIComponents(),this.initializeUILanguage(),this.attachListener();}catch(e){console.error(e.message);}}initializeUIComponents(){const e=this.editor,t=e.t;e.model.schema.register("inline-slash",{inheritAllFrom:"$block",isInline:!0,isObject:!0,allowWhere:"$text",allowAttributes:["class"]}),e.model.schema.extend("$text",{allowIn:"inline-slash"}),e.conversion.for("upcast").elementToElement({view:{name:"inline-slash",attributes:["class"]},model:(e,{writer:t})=>t.createElement("inline-slash",{class:e.getAttribute("class")}),converterPriority:"high"}),e.conversion.for("downcast").elementToElement({model:{name:"inline-slash",attributes:["class"]},view:(e,{writer:t})=>t.createContainerElement("inline-slash",{class:e.getAttribute("class")})}),this.addPlaceholder(),this.addLoader(),this.addGptErrorToolTip(),e.ui.componentFactory.add("aiAgentButton",(o=>{const i=new ckeditor5.ButtonView(o);return i.set({label:t("Ai agent"),icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <path d="M4.00815 5.01816H19.3851V10.9145H21.1594V3.2439H2.23389V22.1694H12.3955V20.3951H4.00815V5.01816Z" fill="#222330"/>\n    <path d="M15.1908 20.046L20.9028 12.7065L22.9998 14.3385L17.2878 21.678L15.0341 22.755C14.8582 22.8391 14.6619 22.6862 14.7002 22.4951L15.1908 20.046Z" fill="#222330"/>\n    <path d="M16.1211 8.43794V15.7494H14.5753V8.43794H16.1211Z" fill="#222330"/>\n    <path fill-rule="evenodd" clip-rule="evenodd" d="M8.31458 15.7495H6.65807L9.18211 8.43804H11.1742L13.6947 15.7495H12.0382L11.4968 14.0823H8.85696L8.31458 15.7495ZM10.2067 10.1088L11.1051 12.8756H9.24951L10.1496 10.1088H10.2067Z" fill="#222330"/>\n</svg>',tooltip:!0}),i.on("execute",(()=>{this.editor.model.change((e=>{const t=this.editor.model.document.selection.getLastPosition();if(t){const n=e.createElement("inline-slash",{class:"ck-slash"});e.insertText("/",n),e.insert(n,t);const o=e.createPositionAt(n,"end");e.setSelection(o);}})),e.editing.view.focus();})),i})),e.accessibility.addKeystrokeInfos({keystrokes:[{label:t("Insert slash command (AI Agent)"),keystroke:"/"}]}),e.model.schema.register("ai-tag",{inheritAllFrom:"$block",isInline:!0,isObject:!0,allowWhere:"$block",allowAttributes:["id"]}),e.model.schema.extend("$block",{allowIn:"ai-tag"}),this.addCustomTagConversions();let o="";ckeditor5.env.isMac&&(o="Cmd + Backspace"),ckeditor5.env.isWindows&&(o="Ctrl + Backspace"),e.accessibility.addKeystrokeInfos({keystrokes:[{label:t("Cancel AI Generation"),keystroke:o}]});}addCustomTagConversions(){const e=this.editor;e.conversion.for("upcast").elementToElement({view:{name:"ai-tag",attributes:["id"]},model:(e,{writer:t})=>t.createElement("ai-tag",{id:e.getAttribute("id")})}),e.conversion.for("dataDowncast").elementToElement({model:"ai-tag",view:(e,{writer:t})=>t.createContainerElement("ai-tag",{id:e.getAttribute("id")})}),e.conversion.for("editingDowncast").elementToElement({model:"ai-tag",view:(e,{writer:t})=>{const n=t.createContainerElement("ai-tag",{id:e.getAttribute("id")});return ckeditor5.toWidget(n,t)}});}initializeUILanguage(){const e=this.editor,t=e.t,n=e.locale.contentLanguage;c.includes(n)||this.showGptErrorToolTip(t("Unsupported language code"));}attachListener(){const e=this.editor,t=e.model;t.document.on("change:data",(()=>{setTimeout((()=>{this.applyPlaceholderToCurrentLine();}),10);})),t.document.selection.on("change:range",(()=>{setTimeout((()=>{this.applyPlaceholderToCurrentLine();}),10);const t=e.model.document.getRoot();if(t){const n=e.model.createRangeIn(t),o=[];for(const e of n.getItems())e.is("element","inline-slash")&&e.isEmpty&&o.push(e);e.model.change((e=>{for(const t of o)e.remove(t);}));}})),e.editing.view.document.on("scroll",(()=>{this.hidePlaceHolder();})),document.addEventListener("scroll",(()=>{this.hidePlaceHolder();}));}applyPlaceholderToCurrentLine(){var e;const t=null===(e=this.editor.model.document.selection.getFirstPosition())||void 0===e?void 0:e.parent;t&&t.isEmpty?(this.hidePlaceHolder(),setTimeout((async()=>{if(t.is("element")){const e=await this.getRectDomOfGivenModelElement(t);e&&this.showPlaceHolder(e);}}),100)):this.hidePlaceHolder();}async getRectDomOfGivenModelElement(e){const t=this.editor,n=t.editing.mapper,o=t.editing.view,i=n.toViewElement(e);if(i){const e=o.domConverter.mapViewToDom(i);if(e)return e.getBoundingClientRect()}return null}addPlaceholder(){const e=this.editor,t=e.t,n=document.createElement("p");n.id=this.PLACEHOLDER_TEXT_ID,n.onclick=()=>{e.focus();},n.classList.add("place-holder"),n.textContent=t("Type / to request AI content"),document.body.appendChild(n);}showPlaceHolder(e){const t=document.getElementById(this.PLACEHOLDER_TEXT_ID),n=this.editor.isReadOnly;t&&e&&!n?(t.classList.add("show-place-holder"),t.style.left=`${e.left}px`,t.style.top=`${e.top}px`):t&&t.classList.remove("show-place-holder");}hidePlaceHolder(){const e=document.getElementById(this.PLACEHOLDER_TEXT_ID);e&&e.classList.remove("show-place-holder");}addLoader(){const e=document.createElement("div");e.id=this.GPT_RESPONSE_LOADER_ID,e.classList.add("gpt-loader"),document.body.appendChild(e);}showLoader(e){const t=document.getElementById(this.GPT_RESPONSE_LOADER_ID);t&&e?(t.style.left=`${e.left+10}px`,t.style.top=`${e.top+10}px`,t.classList.add("show-gpt-loader")):t&&t.classList.remove("show-gpt-loader");}hideLoader(){const e=document.getElementById(this.GPT_RESPONSE_LOADER_ID);e&&e.classList.remove("show-gpt-loader");}addGptErrorToolTip(){const e=document.createElement("p");e.id=this.GPT_RESPONSE_ERROR_ID,e.classList.add("response-error"),document.body.appendChild(e);}showGptErrorToolTip(e){var t,n,o;console.log("Showing error message...",e);const i=this.editor,s=null===(o=null===(n=null===(t=null==i?void 0:i.editing)||void 0===t?void 0:t.view)||void 0===n?void 0:n.domRoots)||void 0===o?void 0:o.get("main"),r=document.getElementById(this.GPT_RESPONSE_ERROR_ID),a=null==s?void 0:s.getBoundingClientRect();r&&a&&(r.classList.add("show-response-error"),r.textContent=e,setTimeout((()=>{this.hideGptErrorToolTip();}),this.showErrorDuration));}hideGptErrorToolTip(){const e=document.getElementById(this.GPT_RESPONSE_ERROR_ID);e&&e.classList.remove("show-response-error");}}class h extends ckeditor5.Command{constructor(e,t){super(e),this.aiAgentService=t;}refresh(){this.isEnabled=!0;}async execute(){await this.aiAgentService.handleSlashCommand();}}const m={blockQuote:"blockquote",caption:"figcaption",codeBlock:"pre",heading1:"h1",heading2:"h2",heading3:"h3",imageBlock:"img",imageInline:"img",paragraph:"p",table:"table",tableCell:"td",tableRow:"tr",$listItem:"li",horizontalLine:"hr"},p={bold:"strong",italic:"em",code:"code",strikethrough:"s",subscript:"sub",superscript:"sup",underline:"u",linkHref:"a"};function g(e){const t=e.model.schema.getDefinitions(),n=Object.keys(t).sort(),o=new Set;n.forEach((e=>{e in m&&o.add(m[e]);}));const i=t.$text;return i&&i.allowAttributes&&i.allowAttributes.forEach((e=>{e in p&&o.add(p[e]);})),o.has("li")&&(o.add("ul"),o.add("ol")),Array.from(o).sort()}var f,v={},w={endsWithChar:function(e,t){return t.length>1?t.indexOf(e.slice(-1))>-1:e.slice(-1)===t},endsWith:function(e,t){return e.slice(e.length-t.length)===t}},E={},T=["al","adj","assn","Ave","BSc","MSc","Cell","Ch","Co","cc","Corp","Dem","Dept","ed","eg","Eq","Eqs","est","est","etc","Ex","ext","Fig","fig","Figs","figs","i.e","ie","Inc","inc","Jan","Feb","Mar","Apr","Jun","Jul","Aug","Sep","Sept","Oct","Nov","Dec","jr","mi","Miss","Mrs","Mr","Ms","Mol","mt","mts","no","Nos","PhD","MD","BA","MA","MM","pl","pop","pp","Prof","Dr","pt","Ref","Refs","Rep","repr","rev","Sec","Secs","Sgt","Col","Gen","Rep","Sen","Gov","Lt","Maj","Capt","St","Sr","sr","Jr","jr","Rev","Sun","Mon","Tu","Tue","Tues","Wed","Th","Thu","Thur","Thurs","Fri","Sat","trans","Univ","Viz","Vol","vs","v"];E.setAbbreviations=function(e){f=e||T;};var b=E.isCapitalized=function(e){return /^[A-Z][a-z].*/.test(e)||y(e)};E.isSentenceStarter=function(e){return b(e)||/``|"|'/.test(e.substring(0,2))},E.isCommonAbbreviation=function(e){var t=e.replace(/[-'`~!@#$%^&*()_|+=?;:'",.<>\{\}\[\]\\\/]/gi,"");return ~f.indexOf(t)},E.isTimeAbbreviation=function(e,t){if(("a.m."===e||"p.m."===e)&&"day"===t.replace(/\W+/g,"").slice(-3).toLowerCase())return !0;return !1},E.isDottedAbbreviation=function(e){var t=e.replace(/[\(\)\[\]\{\}]/g,"").match(/(.\.)*/);return t&&t[0].length>0},E.isCustomAbbreviation=function(e){return e.length<=3||b(e)},E.isNameAbbreviation=function(e,t){return t.length>0&&(!!(e<5&&t[0].length<6&&b(t[0]))||t.filter((function(e){return /[A-Z]/.test(e.charAt(0))})).length>=3)};var y=E.isNumber=function(e,t){return t&&(e=e.slice(t-1,t+2)),!isNaN(e)};E.isPhoneNr=function(e){return e.match(/^(?:(?:\+?1\s*(?:[.-]\s*)?)?(?:\(\s*([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9])\s*\)|([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9]))\s*(?:[.-]\s*)?)?([2-9]1[02-9]|[2-9][02-9]1|[2-9][02-9]{2})\s*(?:[.-]\s*)?([0-9]{4})(?:\s*(?:#|x\.?|ext\.?|extension)\s*(\d+))?$/)},E.isURL=function(e){return e.match(/[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/)},E.isConcatenated=function(e){var t=0;if(((t=e.indexOf("."))>-1||(t=e.indexOf("!"))>-1||(t=e.indexOf("?"))>-1)&&e.charAt(t+1).match(/[a-zA-Z].*/))return [e.slice(0,t),e.slice(t+1)];return !1},E.isBoundaryChar=function(e){return "."===e||"!"===e||"?"===e};var C=function(e,t){if(("string"==typeof e||e instanceof String)&&"undefined"!=typeof document){var n=document.createElement("DIV");n.innerHTML=e,e=(n.textContent||"").trim();}else "object"==typeof e&&e.textContent&&(e=(e.textContent||"").trim());return e},A=w,x=E,P=" @~@ ",L=P.trim(),S=new RegExp("\\S",""),R=new RegExp("\\n+|[-#=_+*]{4,}","g"),k=new RegExp("\\S+|\\n","g");function O(e){return e.split("\n").map((e=>e.trim())).join("\n")}function _(e,t,n=!1,o){let i="",s=0;const r={preserve_whitespace:!0,html_boundaries:!0,allowed_tags:g(o)},a=v.sentences(e,r),l=n?a.reverse():a;for(const e of l){const o=e.length;if(!((s+o)/4<=t))break;i=n?e+i:i+e,s+=o;}return i.trim()}function I(e){if(!e||"string"!=typeof e)return 0;const t=e.trim().replace(/\s+/g," ").match(/\b\w+('\w+)?\b|[.,!?;:"(){}[\]]/g)||[];let n=0;return t.forEach((e=>{e.length>10?n+=Math.ceil(e.length/4):n+=1;})),n}function D(e,t){const n=e.split("\n");let o=0,i="";for(const e of n){const n=I(e);if(o+n>t)break;o+=n,i+=e+"\n";}return i}async function M(e){const t=e.trim();if(!/^(https?|ftp):\/\/[^\s/$.?#].[^\s]*$/i.test(t))throw new Error("Invalid URL");try{const e=`https://r.jina.ai/${t.replace(/[^\x20-\x7E]/g,"").trim()}`,n=await fetch(e.trim(),{headers:{"X-With-Generated-Alt":"true"}});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=await n.text();if(o.includes("Warning: Target URL returned error"))throw new Error(`Target URL (${t}) returned an error`);if(0===o.trim().length)throw new Error("Empty content received");return o.replace(/\(https?:\/\/[^\s]+\)/g,"").replace(/^\s*$/gm,"").trim()}catch(t){return console.error(`Failed to fetch content: ${e}`,t),a.showError("Failed to fetch URL content"),""}}v.sentences=function(e,t){if(!e||"string"!=typeof e||!e.length)return [];if(!S.test(e))return [];var n,o,i={newline_boundaries:!1,html_boundaries:!1,html_boundaries_tags:["p","div","ul","ol"],sanitize:!1,allowed_tags:!1,preserve_whitespace:!1,abbreviations:null};if("boolean"==typeof t)i.newline_boundaries=!0;else for(var s in t)i[s]=t[s];if(x.setAbbreviations(i.abbreviations),i.newline_boundaries&&(e=e.replace(R,P)),i.html_boundaries){var r="(<br\\s*\\/?>|<\\/("+i.html_boundaries_tags.join("|")+")>)",a=new RegExp(r,"g");e=e.replace(a,"$1"+P);}(i.sanitize||i.allowed_tags)&&(i.allowed_tags||(i.allowed_tags=[""]),e=C(e,{allowedTags:i.allowed_tags}));var l=0,c=0,d=[],u=[],h=[];if(!(n=i.preserve_whitespace?(o=e.split(/(<br\s*\/?>|\S+|\n+)/)).filter((function(e,t){return t%2})):e.trim().match(k))||!n.length)return [];for(var m=0,p=n.length;m<p;m++)if(l++,h.push(n[m]),~n[m].indexOf(",")&&(l=0),x.isBoundaryChar(n[m])||A.endsWithChar(n[m],"?!")||n[m]===L)(i.newline_boundaries||i.html_boundaries)&&n[m]===L&&h.pop(),u.push(h),l=0,h=[];else if((A.endsWithChar(n[m],'"')||A.endsWithChar(n[m],"”"))&&(n[m]=n[m].slice(0,-1)),A.endsWithChar(n[m],".")){if(m+1<p){if(2===n[m].length&&isNaN(n[m].charAt(0)))continue;if(x.isCommonAbbreviation(n[m]))continue;if(x.isSentenceStarter(n[m+1])){if(x.isTimeAbbreviation(n[m],n[m+1]))continue;if(x.isNameAbbreviation(l,n.slice(m,6)))continue;if(x.isNumber(n[m+1])&&x.isCustomAbbreviation(n[m]))continue}else {if(A.endsWith(n[m],".."))continue;if(x.isDottedAbbreviation(n[m]))continue;if(x.isNameAbbreviation(l,n.slice(m,5)))continue}}u.push(h),h=[],l=0;}else {if((c=n[m].indexOf("."))>-1){if(x.isNumber(n[m],c))continue;if(x.isDottedAbbreviation(n[m]))continue;if(x.isURL(n[m])||x.isPhoneNr(n[m]))continue}(d=x.isConcatenated(n[m]))&&(h.pop(),h.push(d[0]),u.push(h),l=0,(h=[]).push(d[1]));}return h.length&&u.push(h),(u=u.filter((function(e){return e.length>0}))).slice(1).reduce((function(e,t){var n=e[e.length-1];return 1===n.length&&/^.{1,2}[.]$/.test(n[0])&&!/[.]/.test(t[0])?(e.pop(),e.push(n.concat(t)),e):(e.push(t),e)}),[u[0]]).map((function(e,t){if(i.preserve_whitespace&&!i.newline_boundaries&&!i.html_boundaries){var n=2*e.length;return 0===t&&(n+=1),o.splice(0,n).join("")}return e.join(" ")}))};class N{constructor(e,t={}){var n,o,i,s;this.editor=e;const r=e.config.get("aiAgent");this.contextSize=null!==(n=r.contextSize)&&void 0!==n?n:4e3,this.promptSettings=null!==(o=r.promptSettings)&&void 0!==o?o:{},this.debugMode=null!==(i=r.debugMode)&&void 0!==i&&i,this.editorContextRatio=null!==(s=t.editorContextRatio)&&void 0!==s?s:.3;}getSystemPrompt(e=!1){var t,n;const o={responseRules:"\n            Follow these step-by-step instructions to respond to user inputs:\n            Identify the specific requirements from the TASK section.\n            Do not include any markdown syntax in the response.\n            Generate a response that seamlessly integrates with the existing content.\n            Format the response according to the HTML and structural requirements.\n            Verify that the response meets all formatting and content guidelines.\n        ",htmlFormatting:`\n            HTML Formatting Requirements:\n            Generate valid HTML snippets only.\n            Use only the following allowed tags: ${g(this.editor).join(", ")}.\n            Ensure proper tag nesting.\n            Avoid empty elements.\n            Use semantic HTML where appropriate.\n            Maintain clean, readable HTML structure.\n            Follow block-level element rules.\n            Properly close all tags.\n            No inline styles unless specified.\n            No script or style tags.\n            The first word must be a valid HTML tag.\n            Block elements must not contain other block elements.\n        `,contentStructure:"\n            Content Structure Rules:\n            Organize information logically.\n            Use appropriate paragraph breaks.\n            Maintain consistent formatting.\n            Follow document hierarchy.\n            Use appropriate list structures when needed.\n            Ensure proper content flow.\n            Respect existing document structure.\n        ",tone:"\n            Language and Tone Guidelines:\n            Match the formality level of the surrounding content.\n            Maintain a consistent voice throughout the response.\n            Use appropriate technical terminology when relevant.\n            Ensure proper grammar and punctuation.\n            Avoid overly complex sentence structures.\n            Keep the tone engaging and reader-friendly.\n            Adapt style based on content type.\n        ",inlineContent:"\n            Inline Content Specific Rules:\n            Determine content type (list, table, or inline).\n            Format according to content type.\n            Ensure seamless integration.\n            Preserve existing content flow.\n            Maintain proper nesting.\n        ",imageHandling:"\n            Image Element Requirements:\n            Every <img> must have src and alt attributes.\n            Format src URLs as: https://placehold.co/600x400?text=[alt_text].\n            Alt text must be descriptive and meaningful.\n        "};let i="";for(const[s,r]of Object.entries(o)){if("imageHandling"===s&&!g(this.editor).includes("img")||"inlineContent"===s&&!e)continue;const o=s;let a=r;(null===(t=this.promptSettings.overrides)||void 0===t?void 0:t[o])&&(a=this.promptSettings.overrides[o]),(null===(n=this.promptSettings.additions)||void 0===n?void 0:n[o])&&(a+="\n"+this.promptSettings.additions[o]),i+=O(a)+"\n\n";}return this.debugMode&&(console.group("AiAgent System Prompt Debug"),console.log("System Prompt:",i),console.groupEnd()),i}trimContext(e,t=""){var n,o,i,s,r;let a="",l="";const c=null!=t?t:e,d=null===(s=null===(i=null===(o=null===(n=this.editor)||void 0===n?void 0:n.editing)||void 0===o?void 0:o.view)||void 0===i?void 0:i.domRoots)||void 0===s?void 0:s.get("main"),u=null!==(r=null==d?void 0:d.innerText)&&void 0!==r?r:"",h=u.indexOf(c),m=u.indexOf("\n",h),p=-1!==m?m:h+c.length,g=[u.substring(0,p),u.substring(p+1)],f=Math.floor(this.contextSize*this.editorContextRatio);g.length>1&&(g[0].length<g[1].length?(a=_(g[0],f/2,!0,this.editor),l=_(g[1],f-a.length/4,!1,this.editor)):(l=_(g[1],f/2,!1,this.editor),a=_(g[0],f-l.length/4,!0,this.editor)));const v=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");a=a.trim().replace(new RegExp(v.slice(1)),"@@@cursor@@@").replace("/@@@cursor@@@","@@@cursor@@@");return `${a}\n${l}`.trim()}formatFinalPrompt(e,t,n,o){this.debugMode&&(console.group("formatFinalPrompt Debug"),console.log("Request:",e),console.log("Context:",t),console.log("MarkDownContents:",n),console.log("IsEditorEmpty:",o));const i=this.editor.locale.contentLanguage,s=[];if(s.push("<TASK>"),s.push(e),s.push("</TASK>"),(null==t?void 0:t.length)&&(s.push("\n<CONTEXT>"),s.push(t),s.push("</CONTEXT>")),null==n?void 0:n.length){s.push("\n<REFERENCE_CONTENT>");for(const e of n)s.push(`<SOURCE url="${e.url}">\n${e.content}\n</SOURCE>`);s.push("</REFERENCE_CONTENT>"),s.push("\n<REFERENCE_GUIDELINES>"),s.push(O("\n\t\t\t\tUse information from provided markdown to generate new text.\n\t\t\t\tDo not copy content verbatim.\n\t\t\t\tEnsure natural flow with existing context.\n\t\t\t\tAvoid markdown formatting in response.\n\t\t\t\tConsider whole markdown as single source.\n\t\t\t\tGenerate requested percentage of content.\n\t\t\t")),s.push("</REFERENCE_GUIDELINES>");}return s.push("\n<INSTRUCTIONS>"),s.push(`The response must follow the language code - ${i}.`),s.push("</INSTRUCTIONS>"),o||(s.push("\n<CONTEXT_REQUIREMENTS>"),s.push(O('\n\t\t\t\tReplace "@@@cursor@@@" with contextually appropriate content.\n\t\t\t\tReplace ONLY @@@cursor@@@ - surrounding text is READ-ONLY.\n\t\t\t\tNEVER copy or paraphrase context text.\n\t\t\t\tVerify zero phrase duplication.\n\t\t\t\tAnalyze the CONTEXT section thoroughly \n\t\t\t\tto understand the existing content and its style.\n\t\t\t\tGenerate a response that seamlessly integrates \n\t\t\t\twith the existing content.\n\t\t\t\tDetermine the appropriate tone and style based\n\t\t\t\ton the context. Ensure the response flows \n\t\t\t\tnaturally with the existing content.\n\n\t\t\t')),s.push("</CONTEXT_REQUIREMENTS>")),this.debugMode&&(console.group("AiAgent Final Prompt Debug"),console.log("Final Prompt:",s.join("\n")),console.groupEnd()),s.map((e=>function(e){return e.split("\n").map((e=>e.trimStart())).join("\n")}(e))).join("\n")}async generateMarkDownForUrls(e){try{const t=[];for(const n of e)try{const e=await M(n);e&&t.push({content:e,url:n,tokenCount:I(e)});}catch(e){this.debugMode&&console.error(`Failed to fetch content from ${n}:`,e),a.showError(`Failed to fetch content from ${n}`);}return this.allocateTokensToFetchedContent(this.getSystemPrompt(),t)}catch(e){return this.debugMode&&console.error("Error generating markdown content:",e),a.showError("Failed to generate markdown content"),[]}}allocateTokensToFetchedContent(e,t){var n,o,i,s,r,a;const l=null!==(a=null===(r=null===(s=null===(i=null===(o=null===(n=this.editor)||void 0===n?void 0:n.editing)||void 0===o?void 0:o.view)||void 0===i?void 0:i.domRoots)||void 0===s?void 0:s.get("main"))||void 0===r?void 0:r.innerText)&&void 0!==a?a:"",c=Math.min(Math.floor(this.contextSize*this.editorContextRatio),I(l)),d=this.contextSize-c;if(0===d||!t.length)return t;const u=Math.floor(d/t.length);return t.map((e=>({...e,content:D(e.content,u)})))}}class F{constructor(e){var t;this.editor=e,this.model=e.model,this.debugMode=null!==(t=e.config.get("aiAgent.debugMode"))&&void 0!==t&&t;}async insertSimpleHtml(e){var t;this.debugMode&&console.log("Attempting to insert simple HTML:",e);const n=this.editor.data.processor.toView(e),o=this.editor.data.toModel(n,"$root"),i=this.model.document.selection,s=this.model.document.getRoot();let r=i.getLastPosition();const a=o.getChild(o.childCount-1),l=null===(t=i.getLastPosition())||void 0===t?void 0:t.path[0],c=null==s?void 0:s.getChild(null!=l?l:0);this.model.change((e=>{if((null==c?void 0:c.is("element"))&&(r=c.isEmpty?e.createPositionAt(c,"end"):e.createPositionAfter(c)),r&&s){e.setSelection(r),this.model.insertContent(o,r);let t=null==a?void 0:a.getAttribute("listItemId");if((null==a?void 0:a.is("element"))&&(t=t||"table"===a.name),t&&a){const t=e.createElement("paragraph");e.insert(t,e.createPositionAfter(a)),e.setSelection(t,"in");}else a&&e.setSelection(e.createPositionAfter(a));}})),await new Promise((e=>setTimeout(e,100)));}async insertAsText(e,t,n=!1,o=!1){const i=this.editor.data.processor.toView(e.outerHTML),s=this.editor.data.toModel(i,"$root"),r=Array.from(s.getChildren()),a=this.model.document.getRoot();for(const[e,o]of r.entries())if(o.is("element")){const i=0===e?t:void 0;n?await this.insertElementAsStream(o,i):await this.batchInsertOfElement(o,i);}o&&this.model.change((e=>{const t=this.model.document.selection.getLastPosition(),n=null==t?void 0:t.path[0];if(a&&null!=n){const t=e.createElement("paragraph");e.insert(t,a,n+1),e.setSelection(t,"in");}}));}async batchInsertOfElement(e,t){var n;const o=this.model.document.selection,i=this.model.document.getRoot();let s=t;if(!t){const e=null===(n=o.getFirstPosition())||void 0===n?void 0:n.path[0],t=null==i?void 0:i.getChild(null!=e?e:0);(null==t?void 0:t.is("element"))&&(s=t.isEmpty?this.model.createPositionAt(t,"end"):this.model.createPositionAfter(t));}this.model.change((t=>{this.model.insertContent(e,s),t.setSelection(e,"end");}));}async insertElementAsStream(e,t){const n=this.model.document.selection,o=this.model.document.getRoot(),i=n.getLastPosition();let s,r=t;if(t){const e=null==i?void 0:i.parent;(null==e?void 0:e.is("element"))&&(s=e);}else {const t=null==i?void 0:i.path[0],n=null==o?void 0:o.getChild(null!=t?t:0);(null==n?void 0:n.is("element"))&&(r=n.isEmpty?this.model.createPositionAt(n,"end"):this.model.createPositionAfter(n)),this.model.change((t=>{s=t.createElement(e.name);for(const[t,n]of e.getAttributes())s._setAttribute(t,n);this.model.insertContent(s,r),r&&t.setSelection(s,"end");}));}const a=Array.from(e.getChildren()).filter((e=>e.is("$text")));for(const e of a){if(!e.is("$text"))continue;const t=Array.from(e.getAttributes()),n=e._data;for(const e of n)await new Promise((n=>{this.model.change((n=>{const o=this.editor.model.document.selection.getLastPosition(),i=o.getShiftedBy(1).offset===(null==o?void 0:o.parent.maxOffset);n.insertText(e,t,s,i?"end":null==o?void 0:o.offset),n.setSelection(this.editor.model.document.selection.getLastPosition());})),setTimeout(n,5);}));}t||this.model.change((e=>{e.setSelection(s,"end");}));}isCompleteHtmlChunk(e){if((e.match(/<[^/][^>]*>/g)||[]).length!==(e.match(/<\/[^>]+>/g)||[]).length)return !1;if(e.includes("<")&&!e.includes(">"))return !1;const t=e.trim();return !(!t.startsWith("<")||!t.endsWith(">"))}}class H{constructor(e){var t,n,o,i,s,r,a,l,c;this.aiAgentFeatureLockId=Symbol("ai-agent-feature"),this.buffer="",this.openTags=[],this.isInlineInsertion=!1,this.abortGeneration=!1,this.disableFlags=[],this.editor=e,this.promptHelper=new N(e),this.htmlParser=new F(e);const d=e.config.get("aiAgent");this.aiModel=d.model,this.apiKey=d.apiKey,this.endpointUrl=d.endpointUrl,this.temperature=d.temperature,this.timeOutDuration=null!==(t=d.timeOutDuration)&&void 0!==t?t:45e3,this.maxTokens=null!==(n=d.maxOutputTokens)&&void 0!==n?n:d.maxTokens,this.retryAttempts=d.retryAttempts,this.stopSequences=d.stopSequences,this.streamContent=null===(o=d.streamContent)||void 0===o||o,this.moderationKey=null!==(s=null===(i=d.moderation)||void 0===i?void 0:i.key)&&void 0!==s?s:"",this.moderationEnable=null!==(a=null===(r=d.moderation)||void 0===r?void 0:r.enable)&&void 0!==a&&a,this.disableFlags=null!==(c=null===(l=d.moderation)||void 0===l?void 0:l.disableFlags)&&void 0!==c?c:[];}async handleSlashCommand(){const e=this.editor,t=e.model,n=e.editing.mapper,o=e.editing.view,i=t.document.getRoot();let s,r,l;const c=t.document.selection.getLastPosition();if(c&&i){l=c.parent;const e="inline-slash"===l.name?l:void 0,a=n.toViewElement(l);if(r=a?o.domConverter.mapViewToDom(a):void 0,e){this.isInlineInsertion=!0;const n=e.getPath(),l=null==c?void 0:c.path,d=t.createPositionFromPath(i,n),u=t.createPositionFromPath(i,l),h=t.createRange(d,u);r=(null==a?void 0:a.parent)?o.domConverter.mapViewToDom(a.parent):void 0,s="";for(const e of h.getItems())e.is("$textProxy")&&(s+=e.data.trim());}else r&&(s=null==r?void 0:r.innerText);}if(this.moderationEnable){if(!await this.moderateContent(null!=s?s:""))return}try{const e=window.getSelection(),t=(null==e?void 0:e.getRangeAt(0)).getBoundingClientRect();a.showLoader(t);const n=await this.generateGptPromptBasedOnUserPrompt(null!=s?s:"",null==r?void 0:r.innerText);l&&n&&await this.fetchAndProcessGptResponse(n,l);}catch(e){throw console.error("Error handling slash command:",e),e}finally{this.isInlineInsertion=!1,a.hideLoader();}}async moderateContent(e){var t;if(!this.moderationKey)return !0;const n=this.editor.t,o=new AbortController,i=setTimeout((()=>o.abort()),this.timeOutDuration);try{const s=await fetch("https://api.openai.com/v1/moderations",{method:"POST",headers:{Authorization:`Bearer ${this.moderationKey}`,"Content-Type":"application/json"},body:JSON.stringify({input:e}),signal:o.signal});if(clearTimeout(i),!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const r=await s.json();if(!(null===(t=null==r?void 0:r.results)||void 0===t?void 0:t[0]))throw new Error("Invalid moderation response format");const l=d.filter((e=>!this.disableFlags.includes(e)));if(r.results[0].flagged){let e=!1;const t=r.results[0].categories;for(let n=0;n<l.length;n++){const o=l[n];if(l.includes(o)&&t[o]){e=!0;break}}if(e)return a.showError(n("I'm sorry, but I cannot assist with that request.")),!1}return !0}catch(e){return console.error("Moderation error:",e),e instanceof TypeError?a.showError(n("Network error during content moderation")):e instanceof DOMException&&"AbortError"===e.name?a.showError(n("Content moderation timed out")):a.showError(n("Error in content moderation")),!0}finally{clearTimeout(i);}}async fetchAndProcessGptResponse(e,t,n=this.retryAttempts){var o,i,s;console.log("Starting fetchAndProcessGptResponse");const r=this.editor,l=r.t,c=new AbortController,d=setTimeout((()=>c.abort()),this.timeOutDuration);let u="",h="";const m=`ai-${(new Date).getTime()}`;try{const n=await fetch(this.endpointUrl,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.aiModel,messages:[{role:"system",content:this.promptHelper.getSystemPrompt(this.isInlineInsertion)},{role:"user",content:e}],temperature:this.temperature,max_tokens:this.maxTokens,stop:this.stopSequences,stream:!0}),signal:c.signal});if(clearTimeout(d),!n.ok)throw new Error("Fetch failed");a.hideLoader();const s=n.body.getReader(),l=new TextDecoder("utf-8");this.clearParentContent(t);let p=!0;for(this.cancelGenerationButton(m,c),r.model.change((e=>{var t;const n=r.model.document.selection.getLastPosition();if(n){const o=e.createElement("ai-tag",{id:m}),i=n.parent;i&&("tableCell"===(null===(t=i.parent)||void 0===t?void 0:t.name)||"bulleted"===i.getAttribute("listType"))&&(p=!1);let s="";for(const e of i.getChildren())e.is("$text")&&(s+=e.data);const r=s?e.createPositionAfter(i):e.createPositionBefore(i);e.insert(o,p?r:n);const a=e.createPositionAt(o,"end");e.setSelection(a);}})),console.log("Starting to process response");;){const{done:e,value:t}=await s.read();if(e){console.log("Finished reading response");break}let n;for(u+=l.decode(t,{stream:!0});-1!==(n=u.indexOf("\n"));){const e=u.slice(0,n).trim();if(u=u.slice(n+1),e.startsWith("data: ")){const t=e.slice(5).trim();if("[DONE]"===t){console.log("Received [DONE] signal");break}try{const e=null===(i=null===(o=JSON.parse(t).choices[0])||void 0===o?void 0:o.delta)||void 0===i?void 0:i.content;null!=e&&(h+=e),await this.updateContent(h,m,p);}catch(e){console.warn("Error parsing JSON:",e);}}}}this.processCompleted(m);}catch(o){if(this.abortGeneration)return;console.error("Error in fetchAndProcessGptResponse:",o);const i=((null==o?void 0:o.message)||"").trim()||((null==o?void 0:o.name)||"").trim(),r=["AbortError","ReadableStream not supported","AiAgent: Fetch failed"].includes(i);if(n>0&&r)return console.warn(`Retrying... (${n} attempts left)`),await this.fetchAndProcessGptResponse(e,t,n-1);let c;if("ReadableStream not supported"===((null==o?void 0:o.name)||(null===(s=null==o?void 0:o.message)||void 0===s?void 0:s.trim())))c=l("Browser does not support readable streams");else c=l("We couldn't connect to the AI. Please check your internet");a.showError(c);}finally{this.editor.disableReadOnlyMode(this.aiAgentFeatureLockId);}}cancelGenerationButton(e,t){const o=this.editor,i=o.t,r=new ckeditor5.ButtonView;let a=i("Cancel Generation");if(ckeditor5.env.isMac&&(a=i("⌘ + ⌫ Cancel Generation")),ckeditor5.env.isWindows&&(a=i("Ctrl + ⌫ Cancel Generation")),r.set({label:a,withText:!0,class:"ck-cancel-request-button"}),r.on("execute",(()=>{this.abortGeneration=!0,t.abort(),this.processCompleted(e);})),r.render(),o.keystrokes.set("Ctrl+Backspace",((n,o)=>{(n.ctrlKey||n.metaKey)&&(this.abortGeneration=!0,t.abort(),this.processCompleted(e)),o();})),o.ui.view.element&&r.element){const e=o.ui.view.element.querySelector(".ck-sticky-panel__content .ck-toolbar__items");e&&e.append(r.element);}setTimeout((()=>r.set({class:"ck-cancel-request-button visible"})),2e3);}processCompleted(e){const t=this.editor;if(t.ui.view.element){const e=t.ui.view.element.querySelector(".ck-cancel-request-button");e&&e.remove();}let n=t.getData().replace(`<ai-tag id="${e}">`,"");n=n.replace("</ai-tag>",""),t.setData(n);}async updateContent(e,t,n){const o=this.editor;o.model.change((i=>{const s=o.model.document.getRoot();let r=null;if(s){for(const e of s.getChildren()){const o=e;if(n){if(o.is("element","ai-tag")&&o.getAttribute("id")===t){r=o;break}}else for(const e of o.getChildren())if(e.is("element","ai-tag")&&e.getAttribute("id")===t){r=e;break}}if(r){const t=o.model.createRangeIn(r);i.remove(t);const n=o.data.processor.toView(e),s=o.data.toModel(n);i.insert(s,r,"end");}}})),await new Promise((e=>setTimeout(e)));}async processContent(e){try{if(console.log("--- Start of processContent ---"),console.log("Processing content:",e,this.isInlineInsertion),this.isInlineInsertion){const t=this.editor.model.document.selection.getLastPosition(),n=document.createElement("div");n.innerHTML=e,await this.htmlParser.insertAsText(n||"",null!=t?t:void 0,this.streamContent);}else this.streamContent?await this.proceedHtmlResponse(e):await this.htmlParser.insertSimpleHtml(e);console.log("--- End of processContent ---");}catch(e){console.error(e);}}async proceedHtmlResponse(e){const t=document.createElement("div");t.innerHTML=e;for(const e of Array.from(t.childNodes)){const t=e;if(t.nodeType===Node.ELEMENT_NODE){const e=t.tagName.toLowerCase();["table","blockquote","pre","img","form","figure"].includes(e)?await this.htmlParser.insertSimpleHtml(t.outerHTML):"ul"===e||"ol"===e?await this.htmlParser.insertAsText(t,void 0,!0,!0):await this.htmlParser.insertAsText(t,void 0,!0);}else if(t.nodeType===Node.TEXT_NODE&&t.textContent){const e=document.createElement("div");e.innerText=t.textContent,await this.htmlParser.insertAsText(e,void 0,!0);}}}clearParentContent(e){const t=this.editor,n=t.model,o=n.document.getRoot(),i=n.document.selection.getLastPosition(),s=Array.from(e.getChildren()).find((e=>"inline-slash"===e.name));o&&i&&t.model.change((t=>{const r=(null==s?void 0:s.getPath())||e.getPath(),a=n.createRange(n.createPositionFromPath(o,r),n.createPositionFromPath(o,i.path));t.remove(a),t.setSelection(n.createPositionFromPath(o,r));}));}async generateGptPromptBasedOnUserPrompt(e,t){try{const n=this.promptHelper.trimContext(e,t),o=e.slice(1);let i=[];const s=/https?:\/\/[^\s/$.?#].[^\s]*/g,r=e.match(s);if(Array.isArray(r)&&r.length){const t=r.map((e=>e.replace(/[,.]$/,"")));i=await this.promptHelper.generateMarkDownForUrls(t),i=this.promptHelper.allocateTokensToFetchedContent(e,i);}const a="@@@cursor@@@"===n;return this.promptHelper.formatFinalPrompt(o,n,i,a)}catch(e){return console.error(e),null}}}class $ extends ckeditor5.Plugin{static get pluginName(){return "AiAgentEditing"}init(){const e=this.editor,t=new H(e);e.commands.add("aiAgent",new h(e,t)),this.setupEnterKeyHandling();}setupEnterKeyHandling(){const e=this.editor,t=e.model,n=e.editing.mapper,o=e.editing.view;e.keystrokes.set("enter",(async(i,s)=>{var r;const a=t.document.selection.getFirstPosition();if(a){const t=a.parent,i=Array.from(t.getChildren()).find((e=>"inline-slash"===e.name)),l=n.toViewElement(t);let c;l&&(c=null===(r=o.domConverter.mapViewToDom(l))||void 0===r?void 0:r.innerText),("string"==typeof c&&c.startsWith("/")||i)&&(s(),await e.execute("aiAgent"));}}));}}class G extends ckeditor5.Plugin{constructor(e){super(e),this.DEFAULT_GPT_MODEL="gpt-4o",this.DEFAULT_AI_END_POINT="https://api.openai.com/v1/chat/completions";const t=e.config.get("aiAgent")||{},n={...{model:this.DEFAULT_GPT_MODEL,apiKey:"",endpointUrl:this.DEFAULT_AI_END_POINT,temperature:void 0,timeOutDuration:45e3,maxOutputTokens:l[this.DEFAULT_GPT_MODEL].maxOutputTokens,maxInputTokens:l[this.DEFAULT_GPT_MODEL].maxInputContextTokens,retryAttempts:1,contextSize:.75*l[this.DEFAULT_GPT_MODEL].maxInputContextTokens,stopSequences:[],promptSettings:{},debugMode:!1,streamContent:!0},...t};e.config.set("aiAgent",n),this.validateConfiguration(n);}static get requires(){return [u,$]}static get pluginName(){return "AiAgent"}validateConfiguration(e){if(!e.apiKey)throw new Error("AiAgent: apiKey is required.");if(e.temperature&&(e.temperature<0||e.temperature>2))throw new Error("AiAgent: Temperature must be a number between 0 and 2.");const t=l[e.model];if(void 0!==e.maxOutputTokens&&(e.maxOutputTokens<t.minOutputTokens||e.maxOutputTokens>t.maxOutputTokens))throw new Error(`AiAgent: maxOutputTokens must be between ${t.minOutputTokens} and ${t.maxOutputTokens} for ${e.model}`);if(void 0!==e.maxInputTokens&&e.maxInputTokens>t.maxInputContextTokens)throw new Error(`AiAgent: maxInputTokens cannot exceed ${t.maxInputContextTokens} for ${e.model}`)}init(){}}const U={ckeditor:"<svg width='68' height='64' viewBox='0 0 68 64' xmlns='http://www.w3.org/2000/svg'><g fill='none' fill-rule='evenodd'><path d='M43.71 11.025a11.508 11.508 0 0 0-1.213 5.159c0 6.42 5.244 11.625 11.713 11.625.083 0 .167 0 .25-.002v16.282a5.464 5.464 0 0 1-2.756 4.739L30.986 60.7a5.548 5.548 0 0 1-5.512 0L4.756 48.828A5.464 5.464 0 0 1 2 44.089V20.344c0-1.955 1.05-3.76 2.756-4.738L25.474 3.733a5.548 5.548 0 0 1 5.512 0l12.724 7.292z' fill='#FFF'/><path d='M45.684 8.79a12.604 12.604 0 0 0-1.329 5.65c0 7.032 5.744 12.733 12.829 12.733.091 0 .183-.001.274-.003v17.834a5.987 5.987 0 0 1-3.019 5.19L31.747 63.196a6.076 6.076 0 0 1-6.037 0L3.02 50.193A5.984 5.984 0 0 1 0 45.003V18.997c0-2.14 1.15-4.119 3.019-5.19L25.71.804a6.076 6.076 0 0 1 6.037 0L45.684 8.79zm-29.44 11.89c-.834 0-1.51.671-1.51 1.498v.715c0 .828.676 1.498 1.51 1.498h25.489c.833 0 1.51-.67 1.51-1.498v-.715c0-.827-.677-1.498-1.51-1.498h-25.49.001zm0 9.227c-.834 0-1.51.671-1.51 1.498v.715c0 .828.676 1.498 1.51 1.498h18.479c.833 0 1.509-.67 1.509-1.498v-.715c0-.827-.676-1.498-1.51-1.498H16.244zm0 9.227c-.834 0-1.51.671-1.51 1.498v.715c0 .828.676 1.498 1.51 1.498h25.489c.833 0 1.51-.67 1.51-1.498v-.715c0-.827-.677-1.498-1.51-1.498h-25.49.001zm41.191-14.459c-5.835 0-10.565-4.695-10.565-10.486 0-5.792 4.73-10.487 10.565-10.487C63.27 3.703 68 8.398 68 14.19c0 5.791-4.73 10.486-10.565 10.486v-.001z' fill='#1EBC61' fill-rule='nonzero'/><path d='M60.857 15.995c0-.467-.084-.875-.251-1.225a2.547 2.547 0 0 0-.686-.88 2.888 2.888 0 0 0-1.026-.531 4.418 4.418 0 0 0-1.259-.175c-.134 0-.283.006-.447.018-.15.01-.3.034-.446.07l.075-1.4h3.587v-1.8h-5.462l-.214 5.06c.319-.116.682-.21 1.089-.28.406-.071.77-.107 1.088-.107.218 0 .437.021.655.063.218.041.413.114.585.218s.313.244.422.419c.109.175.163.391.163.65 0 .424-.132.745-.396.961a1.434 1.434 0 0 1-.938.325c-.352 0-.656-.1-.912-.3-.256-.2-.43-.453-.523-.762l-1.925.588c.1.35.258.664.472.943.214.279.47.514.767.706.298.191.63.339.995.443.365.104.749.156 1.151.156.437 0 .86-.064 1.272-.193.41-.13.778-.323 1.1-.581a2.8 2.8 0 0 0 .775-.981c.193-.396.29-.864.29-1.405h-.001z' fill='#FFF' fill-rule='nonzero'/></g></svg>\n"};

	exports.AiAgent = G;
	exports.icons = U;

}));
//# sourceMappingURL=index.umd.js.map
