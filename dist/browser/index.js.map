{"version":3,"file":"index.js","sources":["../../src/aiagentcontext.ts","../../src/const.ts","../../src/util/html-utils.ts","../../node_modules/sbd/lib/Match.js","../../node_modules/sbd/lib/stringHelper.js","../../node_modules/sbd/lib/tokenizer.js","../../node_modules/sbd/lib/sanitize-html-browser.js","../../src/util/text-utils.ts","../../src/util/token-utils.ts","../../src/util/url-utils.ts","../../src/util/prompt.ts","../../src/util/default-rules.ts","../../src/util/htmlparser.ts","../../src/aiagentservice.ts","../../src/aiagentui.ts","../../src/aiagentcommand.ts","../../src/aiagentediting.ts","../../src/aiagent.ts","../../src/index.ts"],"sourcesContent":["/**\n * The AiAgentContext class provides a context for the AI Agent plugin,\n * allowing access to shared resources and state across different components.\n */\nexport class AiAgentContext {\n\tprivate static instance: AiAgentContext;\n\tprivate _uiComponent: any;\n\n\tprivate constructor() {}\n\n\tpublic static getInstance(): AiAgentContext {\n\t\tif ( !AiAgentContext.instance ) {\n\t\t\tAiAgentContext.instance = new AiAgentContext();\n\t\t}\n\t\treturn AiAgentContext.instance;\n\t}\n\n\tpublic set uiComponent( component: any ) {\n\t\tthis._uiComponent = component;\n\t}\n\n\tpublic showError( message: string ): void {\n\t\tif ( this._uiComponent ) {\n\t\t\tconsole.log( 'Showing error message...', message );\n\t\t\tthis._uiComponent.showGptErrorToolTip( message );\n\t\t}\n\t}\n\n\tpublic showLoader( rect: DOMRect ): void {\n\t\tif ( this._uiComponent ) {\n\t\t\tthis._uiComponent.showLoader( rect );\n\t\t}\n\t}\n\n\tpublic hideLoader(): void {\n\t\tif ( this._uiComponent ) {\n\t\t\tthis._uiComponent.hideLoader();\n\t\t}\n\t}\n}\n\nexport const aiAgentContext = AiAgentContext.getInstance();\n","import type { AiModel, ModelTokenLimits } from './type-identifiers.js';\n\n// const\nexport const TOKEN_LIMITS: Record<AiModel, ModelTokenLimits> = {\n\t'gpt-3.5-turbo': {\n\t\tminOutputTokens: 1,\n\t\tmaxOutputTokens: 4096,\n\t\tmaxInputContextTokens: 16385\n\t},\n\t'gpt-4o': {\n\t\tminOutputTokens: 0,\n\t\tmaxOutputTokens: 16384,\n\t\tmaxInputContextTokens: 128000\n\t},\n\t'gpt-4o-mini': {\n\t\tminOutputTokens: 1,\n\t\tmaxOutputTokens: 16384,\n\t\tmaxInputContextTokens: 128000\n\t},\n\t'kavya-m1': {\n\t\tminOutputTokens: 0,\n\t\tmaxOutputTokens: 16384,\n\t\tmaxInputContextTokens: 128000\n\t}\n};\n\nexport const SUPPORTED_LANGUAGES = [ 'en', 'es', 'hi', 'nl' ];\n\nexport const MODERATION_URL = 'https://api.openai.com/v1/moderations';\n\nexport const ALL_MODERATION_FLAGS = [\n\t'harassment',\n\t'harassment/threatening',\n\t'hate',\n\t'hate/threatening',\n\t'self-harm',\n\t'self-harm/instructions',\n\t'self-harm/intent',\n\t'sexual',\n\t'sexual/minors',\n\t'violence',\n\t'violence/graphic'\n] as const;\n\nexport const SHOW_ERROR_DURATION = 5000;\n\nexport const AI_AGENT_DROPDOWN_MENU = [\n\t{\n\t\ttitle: 'Edit or review',\n\t\titems: [\n\t\t\t{\n\t\t\t\ttitle: 'Improve Writing',\n\t\t\t\tcommand:\n\t\t\t\t\t`Fix spelling mistakes, use proper grammar and apply good writing practices.\n\t\t\t\t\tDo not lose the original meaning.\\nYou must keep the text formatting.`\n\t\t\t},\n\t\t\t{\n\t\t\t\ttitle: 'Make Shorter',\n\t\t\t\tcommand:\n\t\t\t\t\t`Remove any repetitive, redundant, or non-essential writing in this\n\t\t\t\t\tcontent without changing the meaning or losing any key information.`\n\t\t\t},\n\t\t\t{\n\t\t\t\ttitle: 'Make Longer',\n\t\t\t\tcommand:\n\t\t\t\t\t`Improve this content by using descriptive language and inserting\n\t\t\t\t\tmore information and more detailed explanations.\\nYou must keep the text formatting.`\n\t\t\t},\n\t\t\t{\n\t\t\t\ttitle: 'Simplify Language',\n\t\t\t\tcommand:\n\t\t\t\t\t`Simplify the writing style of this content and reduce the complexity,\n\t\t\t\t\tso that the content is easy to understand.\\nYou must keep the text formatting`\n\t\t\t}\n\t\t]\n\t},\n\t{\n\t\ttitle: 'Generate from selection',\n\t\titems: [\n\t\t\t{\n\t\t\t\ttitle: 'Summarize',\n\t\t\t\tcommand:\n\t\t\t\t\t`Summarize this content into one paragraph of text. Include only the key ideas and conclusions.\n\t\t\t\t\tKeep it short. Do not keep original text formatting`\n\t\t\t},\n\t\t\t{\n\t\t\t\ttitle: 'Continue',\n\t\t\t\tcommand:\n\t\t\t\t\t`Start with the provided content and write at the end of it continuing this topic.\n\t\t\t\t\tKeep the added part short.\\nYou must keep the text formatting`\n\t\t\t}\n\t\t]\n\t}\n];\n","import type { Editor } from 'ckeditor5/src/core.js';\n\n// Map of CKEditor nodes to HTML tags\nconst nodeToHtmlMap: Record<string, string> = {\n\tblockQuote: 'blockquote',\n\tcaption: 'figcaption',\n\tcodeBlock: 'pre',\n\theading1: 'h1',\n\theading2: 'h2',\n\theading3: 'h3',\n\timageBlock: 'img',\n\timageInline: 'img',\n\tparagraph: 'p',\n\ttable: 'table',\n\ttableCell: 'td',\n\ttableRow: 'tr',\n\t$listItem: 'li',\n\thorizontalLine: 'hr'\n};\n\n// Map text attributes to HTML tags\nconst textAttributeToHtmlMap: Record<string, string> = {\n\tbold: 'strong',\n\titalic: 'em',\n\tcode: 'code',\n\tstrikethrough: 's',\n\tsubscript: 'sub',\n\tsuperscript: 'sup',\n\tunderline: 'u',\n\tlinkHref: 'a'\n};\n\n/**\n * Gets the allowed HTML tags from the editor schema.\n *\n * @param editor - The CKEditor instance\n * @returns Array of allowed HTML tag names\n */\nexport function getAllowedHtmlTags( editor: Editor ): Array<string> {\n\tconst schema = editor.model.schema;\n\tconst definitions = schema.getDefinitions();\n\tconst schemaNodes = Object.keys( definitions ).sort();\n\tconst allowedTags = new Set<string>();\n\n\t// Add tags from node mappings\n\tschemaNodes.forEach( node => {\n\t\tif ( node in nodeToHtmlMap ) {\n\t\t\tallowedTags.add( nodeToHtmlMap[ node ] );\n\t\t}\n\t} );\n\n\t// Add tags from text attributes\n\tconst textDefinition = definitions.$text;\n\tif ( textDefinition && textDefinition.allowAttributes ) {\n\t\ttextDefinition.allowAttributes.forEach( ( attr: string ) => {\n\t\t\tif ( attr in textAttributeToHtmlMap ) {\n\t\t\t\tallowedTags.add( textAttributeToHtmlMap[ attr ] );\n\t\t\t}\n\t\t} );\n\t}\n\n\t// If listItem is present, add ul and ol\n\tif ( allowedTags.has( 'li' ) ) {\n\t\tallowedTags.add( 'ul' );\n\t\tallowedTags.add( 'ol' );\n\t}\n\n\treturn Array.from( allowedTags ).sort();\n}\n","var abbreviations;\r\n\r\nvar englishAbbreviations = [\r\n    \"al\",\r\n    \"adj\",\r\n    \"assn\",\r\n    \"Ave\",\r\n    \"BSc\", \"MSc\",\r\n    \"Cell\",\r\n    \"Ch\",\r\n    \"Co\",\r\n    \"cc\",\r\n    \"Corp\",\r\n    \"Dem\",\r\n    \"Dept\",\r\n    \"ed\",\r\n    \"eg\",\r\n    \"Eq\",\r\n    \"Eqs\",\r\n    \"est\",\r\n    \"est\",\r\n    \"etc\",\r\n    \"Ex\",\r\n    \"ext\", // + number?\r\n    \"Fig\",\r\n    \"fig\",\r\n    \"Figs\",\r\n    \"figs\",\r\n    \"i.e\",\r\n    \"ie\",\r\n    \"Inc\",\r\n    \"inc\",\r\n    \"Jan\",\"Feb\",\"Mar\",\"Apr\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Sept\",\"Oct\",\"Nov\",\"Dec\",\r\n    \"jr\",\r\n    \"mi\",\r\n    \"Miss\", \"Mrs\", \"Mr\", \"Ms\",\r\n    \"Mol\",\r\n    \"mt\",\r\n    \"mts\",\r\n    \"no\",\r\n    \"Nos\",\r\n    \"PhD\", \"MD\", \"BA\", \"MA\", \"MM\",\r\n    \"pl\",\r\n    \"pop\",\r\n    \"pp\",\r\n    \"Prof\", \"Dr\",\r\n    \"pt\",\r\n    \"Ref\",\r\n    \"Refs\",\r\n    \"Rep\",\r\n    \"repr\",\r\n    \"rev\",\r\n    \"Sec\",\r\n    \"Secs\",\r\n    \"Sgt\", \"Col\", \"Gen\", \"Rep\", \"Sen\",'Gov', \"Lt\", \"Maj\", \"Capt\",\"St\",\r\n    \"Sr\", \"sr\", \"Jr\", \"jr\", \"Rev\",\r\n    \"Sun\",\"Mon\",\"Tu\",\"Tue\",\"Tues\",\"Wed\",\"Th\",\"Thu\",\"Thur\",\"Thurs\",\"Fri\",\"Sat\",\r\n    \"trans\",\r\n    \"Univ\",\r\n    \"Viz\",\r\n    \"Vol\",\r\n    \"vs\",\r\n    \"v\",\r\n];\r\n\r\nexports.setAbbreviations = function(abbr) {\r\n    if (abbr) {\r\n        abbreviations = abbr;\r\n    } else {\r\n        abbreviations = englishAbbreviations;\r\n    }\r\n}\r\n\r\nvar isCapitalized = exports.isCapitalized = function(str) {\r\n    return /^[A-Z][a-z].*/.test(str) || isNumber(str);\r\n}\r\n\r\n// Start with opening quotes or capitalized letter\r\nexports.isSentenceStarter = function(str) {\r\n    return isCapitalized(str) || /``|\"|'/.test(str.substring(0,2));\r\n}\r\n\r\nexports.isCommonAbbreviation = function(str) {\r\n    var noSymbols = str.replace(/[-'`~!@#$%^&*()_|+=?;:'\",.<>\\{\\}\\[\\]\\\\\\/]/gi, \"\");\r\n\r\n    return ~abbreviations.indexOf(noSymbols);\r\n}\r\n\r\n// This is going towards too much rule based\r\nexports.isTimeAbbreviation = function(word, next) {\r\n    if (word === \"a.m.\" || word === \"p.m.\") {\r\n        var tmp = next.replace(/\\W+/g, '').slice(-3).toLowerCase();\r\n\r\n        if (tmp === \"day\") {\r\n            return true;\r\n        }\r\n    }\r\n\r\n    return false;\r\n}\r\n\r\nexports.isDottedAbbreviation = function(word) {\r\n    var matches = word.replace(/[\\(\\)\\[\\]\\{\\}]/g, '').match(/(.\\.)*/);\r\n    return matches && matches[0].length > 0;\r\n}\r\n\r\n// TODO look for next words, if multiple are capitalized,\r\n// then it's probably not a sentence ending\r\nexports.isCustomAbbreviation = function(str) {\r\n    if (str.length <= 3) {\r\n        return true;\r\n    }\r\n\r\n    return isCapitalized(str);\r\n}\r\n\r\n// Uses current word count in sentence and next few words to check if it is\r\n// more likely an abbreviation + name or new sentence.\r\nexports.isNameAbbreviation = function(wordCount, words) {\r\n    if (words.length > 0) {\r\n        if (wordCount < 5 && words[0].length < 6 && isCapitalized(words[0])) {\r\n            return true;\r\n        }\r\n\r\n        var capitalized = words.filter(function(str) {\r\n            return /[A-Z]/.test(str.charAt(0));\r\n        });\r\n\r\n        return capitalized.length >= 3;\r\n    }\r\n\r\n    return false;\r\n}\r\n\r\nvar isNumber = exports.isNumber = function(str, dotPos) {\r\n    if (dotPos) {\r\n        str = str.slice(dotPos-1, dotPos+2);\r\n    }\r\n\r\n    return !isNaN(str);\r\n};\r\n\r\n// Phone number matching\r\n// http://stackoverflow.com/a/123666/951517\r\nexports.isPhoneNr = function(str) {\r\n    return str.match(/^(?:(?:\\+?1\\s*(?:[.-]\\s*)?)?(?:\\(\\s*([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9])\\s*\\)|([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9]))\\s*(?:[.-]\\s*)?)?([2-9]1[02-9]|[2-9][02-9]1|[2-9][02-9]{2})\\s*(?:[.-]\\s*)?([0-9]{4})(?:\\s*(?:#|x\\.?|ext\\.?|extension)\\s*(\\d+))?$/);\r\n};\r\n\r\n// Match urls / emails\r\n// http://stackoverflow.com/a/3809435/951517\r\nexports.isURL = function(str) {\r\n    return str.match(/[-a-zA-Z0-9@:%._\\+~#=]{2,256}\\.[a-z]{2,6}\\b([-a-zA-Z0-9@:%_\\+.~#?&//=]*)/);\r\n};\r\n\r\n// Starting a new sentence if beginning with capital letter\r\n// Exception: The word is enclosed in brackets\r\nexports.isConcatenated = function(word) {\r\n    var i = 0;\r\n\r\n    if ((i = word.indexOf(\".\")) > -1 ||\r\n        (i = word.indexOf(\"!\")) > -1 ||\r\n        (i = word.indexOf(\"?\")) > -1)\r\n    {\r\n        var c = word.charAt(i + 1);\r\n\r\n        // Check if the next word starts with a letter\r\n        if (c.match(/[a-zA-Z].*/)) {\r\n            return [word.slice(0, i), word.slice(i+1)];\r\n        }\r\n    }\r\n\r\n    return false;\r\n};\r\n\r\nexports.isBoundaryChar = function(word) {\r\n    return word === \".\" ||\r\n           word === \"!\" ||\r\n           word === \"?\";\r\n};\r\n","\r\nexports.endsWithChar = function ends_with_char(word, c) {\r\n    if (c.length > 1) {\r\n        return c.indexOf(word.slice(-1)) > -1;\r\n    }\r\n\r\n    return word.slice(-1) === c;\r\n};\r\n\r\nexports.endsWith = function ends_with(word, end) {\r\n    return word.slice(word.length - end.length) === end;\r\n};","/*jshint node:true, laxcomma:true */\r\n\r\nvar sanitizeHtml = require(\"sanitize-html\");\r\n\r\nvar stringHelper = require(\"./stringHelper\");\r\nvar Match  = require(\"./Match\");\r\n\r\nvar newline_placeholder = \" @~@ \";\r\nvar newline_placeholder_t = newline_placeholder.trim();\r\n\r\n\r\nvar whiteSpaceCheck = new RegExp(\"\\\\S\", \"\");\r\nvar addNewLineBoundaries = new RegExp(\"\\\\n+|[-#=_+*]{4,}\", \"g\");\r\nvar splitIntoWords = new RegExp(\"\\\\S+|\\\\n\", \"g\");\r\n\r\n\r\n// Split the entry into sentences.\r\nexports.sentences = function(text, user_options) {\r\n    if (!text || typeof text !== \"string\" || !text.length) {\r\n        return [];\r\n    }\r\n\r\n    if (!whiteSpaceCheck.test(text)) {\r\n      // whitespace-only string has no sentences\r\n      return [];\r\n    }\r\n\r\n    var options = {\r\n        \"newline_boundaries\"  : false,\r\n        \"html_boundaries\"     : false,\r\n        \"html_boundaries_tags\": [\"p\",\"div\",\"ul\",\"ol\"],\r\n        \"sanitize\"            : false,\r\n        \"allowed_tags\"        : false,\r\n        \"preserve_whitespace\" : false,\r\n        \"abbreviations\"       : null\r\n    };\r\n\r\n    if (typeof user_options === \"boolean\") {\r\n        // Deprecated quick option\r\n        options.newline_boundaries = true;\r\n    }\r\n    else {\r\n        // Extend options\r\n        for (var k in user_options) {\r\n            options[k] = user_options[k];\r\n        }\r\n    }\r\n\r\n    Match.setAbbreviations(options.abbreviations);\r\n\r\n    if (options.newline_boundaries) {\r\n        text = text.replace(addNewLineBoundaries, newline_placeholder);\r\n    }\r\n\r\n    if (options.html_boundaries) {\r\n        var html_boundaries_regexp = \"(<br\\\\s*\\\\/?>|<\\\\/(\" + options.html_boundaries_tags.join(\"|\") + \")>)\";\r\n        var re = new RegExp(html_boundaries_regexp, \"g\");\r\n        text = text.replace(re, \"$1\" + newline_placeholder);\r\n    }\r\n\r\n    if (options.sanitize || options.allowed_tags) {\r\n        if (! options.allowed_tags) {\r\n            options.allowed_tags = [\"\"];\r\n        }\r\n\r\n        text = sanitizeHtml(text, { \"allowedTags\" : options.allowed_tags });\r\n    }\r\n\r\n\r\n    // Split the text into words\r\n    var words;\r\n    var tokens;\r\n\r\n    // Split the text into words\r\n    if (options.preserve_whitespace) {\r\n        // <br> tags are the odd man out, as whitespace is allowed inside the tag\r\n        tokens = text.split(/(<br\\s*\\/?>|\\S+|\\n+)/);\r\n\r\n        // every other token is a word\r\n        words = tokens.filter(function (token, ii) {\r\n          return ii % 2;\r\n        });\r\n    }\r\n    else {\r\n        // - see http://blog.tompawlak.org/split-string-into-tokens-javascript\r\n        words = text.trim().match(splitIntoWords);\r\n    }\r\n\r\n\r\n    var wordCount = 0;\r\n    var index = 0;\r\n    var temp  = [];\r\n    var sentences = [];\r\n    var current   = [];\r\n\r\n    // If given text is only whitespace (or nothing of \\S+)\r\n    if (!words || !words.length) {\r\n        return [];\r\n    }\r\n\r\n    for (var i=0, L=words.length; i < L; i++) {\r\n        wordCount++;\r\n\r\n        // Add the word to current sentence\r\n        current.push(words[i]);\r\n\r\n        // Sub-sentences, reset counter\r\n        if (~words[i].indexOf(\",\")) {\r\n            wordCount = 0;\r\n        }\r\n\r\n        if (Match.isBoundaryChar(words[i]) || stringHelper.endsWithChar(words[i], \"?!\") || words[i] === newline_placeholder_t) {\r\n            if ((options.newline_boundaries || options.html_boundaries) && words[i] === newline_placeholder_t) {\r\n                current.pop();\r\n            }\r\n\r\n            sentences.push(current);\r\n\r\n            wordCount = 0;\r\n            current   = [];\r\n\r\n            continue;\r\n        }\r\n\r\n\r\n        if (stringHelper.endsWithChar(words[i], \"\\\"\") || stringHelper.endsWithChar(words[i], \"”\")) {\r\n            words[i] = words[i].slice(0, -1);\r\n        }\r\n\r\n        // A dot might indicate the end sentences\r\n        // Exception: The next sentence starts with a word (non abbreviation)\r\n        //            that has a capital letter.\r\n        if (stringHelper.endsWithChar(words[i], \".\")) {\r\n            // Check if there is a next word\r\n            // This probably needs to be improved with machine learning\r\n            if (i+1 < L) {\r\n                // Single character abbr.\r\n                if (words[i].length === 2 && isNaN(words[i].charAt(0))) {\r\n                    continue;\r\n                }\r\n\r\n                // Common abbr. that often do not end sentences\r\n                if (Match.isCommonAbbreviation(words[i])) {\r\n                    continue;\r\n                }\r\n\r\n                // Next word starts with capital word, but current sentence is\r\n                // quite short\r\n                if (Match.isSentenceStarter(words[i+1])) {\r\n                    if (Match.isTimeAbbreviation(words[i], words[i+1])) {\r\n                        continue;\r\n                    }\r\n\r\n                    // Dealing with names at the start of sentences\r\n                    if (Match.isNameAbbreviation(wordCount, words.slice(i, 6))) {\r\n                        continue;\r\n                    }\r\n\r\n                    if (Match.isNumber(words[i+1])) {\r\n                        if (Match.isCustomAbbreviation(words[i])) {\r\n                            continue;\r\n                        }\r\n                    }\r\n                }\r\n                else {\r\n                    // Skip ellipsis\r\n                    if (stringHelper.endsWith(words[i], \"..\")) {\r\n                        continue;\r\n                    }\r\n\r\n                    //// Skip abbreviations\r\n                    // Short words + dot or a dot after each letter\r\n                    if (Match.isDottedAbbreviation(words[i])) {\r\n                        continue;\r\n                    }\r\n\r\n                    if (Match.isNameAbbreviation(wordCount, words.slice(i, 5))) {\r\n                        continue;\r\n                    }\r\n                }\r\n            }\r\n\r\n            sentences.push(current);\r\n            current   = [];\r\n            wordCount = 0;\r\n\r\n            continue;\r\n        }\r\n\r\n        // Check if the word has a dot in it\r\n        if ((index = words[i].indexOf(\".\")) > -1) {\r\n            if (Match.isNumber(words[i], index)) {\r\n                continue;\r\n            }\r\n\r\n            // Custom dotted abbreviations (like K.L.M or I.C.T)\r\n            if (Match.isDottedAbbreviation(words[i])) {\r\n                continue;\r\n            }\r\n\r\n            // Skip urls / emails and the like\r\n            if (Match.isURL(words[i]) || Match.isPhoneNr(words[i])) {\r\n                continue;\r\n            }\r\n        }\r\n\r\n        if (temp = Match.isConcatenated(words[i])) {\r\n            current.pop();\r\n            current.push(temp[0]);\r\n            sentences.push(current);\r\n\r\n            current = [];\r\n            wordCount = 0;\r\n            current.push(temp[1]);\r\n        }\r\n    }\r\n\r\n    if (current.length) {\r\n        sentences.push(current);\r\n    }\r\n\r\n\r\n    // Clear \"empty\" sentences\r\n    sentences = sentences.filter(function(s) {\r\n        return s.length > 0;\r\n    });\r\n\r\n    var result = sentences.slice(1).reduce(function (out, sentence) {\r\n      var lastSentence = out[out.length - 1];\r\n\r\n      // Single words, could be \"enumeration lists\"\r\n      if (lastSentence.length === 1 && /^.{1,2}[.]$/.test(lastSentence[0])) {\r\n          // Check if there is a next sentence\r\n          // It should not be another list item\r\n          if (!/[.]/.test(sentence[0])) {\r\n              out.pop()\r\n              out.push(lastSentence.concat(sentence));\r\n              return out;\r\n          }\r\n      }\r\n\r\n      out.push(sentence);\r\n\r\n      return out;\r\n    }, [ sentences[0] ]);\r\n\r\n    // join tokens back together\r\n    return result.map(function (sentence, ii) {\r\n      if (options.preserve_whitespace && !options.newline_boundaries && !options.html_boundaries) {\r\n        // tokens looks like so: [leading-space token, non-space token, space\r\n        // token, non-space token, space token... ]. In other words, the first\r\n        // item is the leading space (or the empty string), and the rest of\r\n        // the tokens are [non-space, space] token pairs.\r\n        var tokenCount = sentence.length * 2;\r\n\r\n        if (ii === 0) {\r\n          tokenCount += 1;\r\n        }\r\n\r\n        return tokens.splice(0, tokenCount).join(\"\");\r\n      }\r\n\r\n      return sentence.join(\" \");\r\n    });\r\n};\r\n","\r\nmodule.exports = function sanitizeHtml(text, opts) {\r\n  // Strip HTML from Text using browser HTML parser\r\n  if ((typeof text == 'string' || text instanceof String) && typeof document !== \"undefined\") {\r\n    var $div = document.createElement(\"DIV\");\r\n    $div.innerHTML = text;\r\n    text = ($div.textContent || '').trim();\r\n  }\r\n  //DOM Object\r\n  else if (typeof text === 'object' && text.textContent) {\r\n    text = (text.textContent || '').trim();\r\n  }\r\n\r\n  return text;\r\n};\r\n","import type { Editor } from 'ckeditor5/src/core.js';\nimport { getAllowedHtmlTags } from './html-utils.js';\nimport sbd from 'sbd';\n\n// Disable camelcase for external library types\n/* eslint-disable camelcase */\ntype SbdOptions = {\n    preserve_whitespace?: boolean;\n    html_boundaries?: boolean;\n    allowed_tags?: Array<string>;\n    newline_boundaries?: boolean;\n    html_boundaries_tags?: Array<string>;\n    sanitize?: boolean;\n    clean?: boolean;\n};\n/* eslint-enable camelcase */\n\n/**\n * Utility functions for text processing operations.\n */\n\n/**\n * Removes leading spaces from each line while preserving empty lines and content indentation.\n *\n * @param text - The text to process\n * @returns The processed text with leading spaces removed\n */\nexport function removeLeadingSpaces( text: string ): string {\n\treturn text.split( '\\n' )\n\t\t.map( line => line.trimStart() )\n\t\t.join( '\\n' );\n}\n\n/**\n * Removes leading & trailing spaces from each line while preserving empty lines and content indentation.\n *\n * @param text - The text to process\n * @returns The processed text with leading spaces removed\n */\nexport function trimMultilineString( text: string ): string {\n\treturn text.split( '\\n' )\n\t\t.map( line => line.trim() )\n\t\t.join( '\\n' );\n}\n\n/**\n * Extracts a portion of text from the editor content based on sentence boundaries.\n *\n * @param contentAfterPrompt - The text to extract from\n * @param contextSize - Maximum size of the context to extract\n * @param reverse - Whether to extract from the end of the text\n * @returns The extracted text portion\n */\nexport function extractEditorContent(\n\tcontentAfterPrompt: string,\n\tcontextSize: number,\n\treverse: boolean = false,\n\teditor: Editor\n): string {\n\tlet trimmedContent = '';\n\tlet charCount = 0;\n\n\tconst options: SbdOptions = {\n\t\tpreserve_whitespace: true,\n\t\thtml_boundaries: true,\n\t\tallowed_tags: getAllowedHtmlTags( editor )\n\t};\n\n\tconst sentences = sbd.sentences( contentAfterPrompt, options );\n\tconst iterator = reverse ? sentences.reverse() : sentences;\n\n\tfor ( const sentence of iterator ) {\n\t\tconst sentenceLength = sentence.length;\n\t\tif ( ( charCount + sentenceLength ) / 4 <= contextSize ) {\n\t\t\ttrimmedContent = reverse ?\n\t\t\t\tsentence + trimmedContent :\n\t\t\t\ttrimmedContent + sentence;\n\t\t\tcharCount += sentenceLength;\n\t\t} else {\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn trimmedContent.trim();\n}\n","/**\n * Utility functions for token management and calculations.\n */\n\n/**\n * Counts the number of tokens in the provided content string.\n *\n * @param content - The content string to count tokens in.\n * @returns The number of tokens in the content.\n */\nexport function countTokens( content: string ): number {\n\tif ( !content || typeof content !== 'string' ) {\n\t\treturn 0;\n\t}\n\n\t// Normalize the content by trimming and reducing multiple whitespaces\n\tconst normalizedContent = content\n\t\t.trim()\n\t\t.replace( /\\s+/g, ' ' );\n\n\t// Approximate tokens by breaking words, contractions, and common punctuation marks\n\tconst tokens = normalizedContent.match( /\\b\\w+('\\w+)?\\b|[.,!?;:\"(){}[\\]]/g ) || [];\n\n\t// Heuristic: Long words (over 10 characters) are likely to be split into multiple tokens\n\tlet approxTokenCount = 0;\n\ttokens.forEach( token => {\n\t\t// Break long words into chunks to approximate GPT subword tokenization\n\t\tif ( token.length > 10 ) {\n\t\t\tapproxTokenCount += Math.ceil( token.length / 4 ); // Approximation: 4 characters per token\n\t\t} else {\n\t\t\tapproxTokenCount += 1;\n\t\t}\n\t} );\n\n\treturn approxTokenCount;\n}\n\n/**\n * Trims the LLM content by tokens while ensuring that sentences or other structures\n * are not clipped mid-way.\n *\n * @param content - The LLM-generated content string to trim\n * @param maxTokens - The maximum number of tokens allowed\n * @returns The trimmed content string\n */\nexport function trimLLMContentByTokens( content: string, maxTokens: number ): string {\n\tconst elements = content.split( '\\n' );\n\tlet accumulatedTokens = 0;\n\tlet trimmedContent = '';\n\n\tfor ( const element of elements ) {\n\t\tconst elementTokenCount = countTokens( element );\n\t\tif ( accumulatedTokens + elementTokenCount > maxTokens ) {\n\t\t\tbreak; // Stop if adding this element would exceed the token limit\n\t\t}\n\t\taccumulatedTokens += elementTokenCount;\n\t\ttrimmedContent += element + '\\n'; // Add the whole structural element\n\t}\n\n\treturn trimmedContent;\n}\n","import { aiAgentContext } from '../aiagentcontext.js';\n\n/**\n * Fetches the content of a given URL and returns it as a string.\n *\n * @param url - The URL to fetch content from.\n * @returns A promise that resolves to the fetched content as a string.\n * @throws Will throw an error if the URL is invalid or if the fetch fails.\n */\nexport async function fetchUrlContent( url: string ): Promise<string> {\n\tconst urlRegex = /^(https?|ftp):\\/\\/[^\\s/$.?#].[^\\s]*$/i;\n\tconst trimmedUrl = url.trim();\n\n\tif ( !urlRegex.test( trimmedUrl ) ) {\n\t\tthrow new Error( 'Invalid URL' );\n\t}\n\n\ttry {\n\t\t// Use a regular expression to remove hidden characters\n\t\tconst cleanedUrl = trimmedUrl.replace( /[^\\x20-\\x7E]/g, '' );\n\t\tconst requestURL = `https://r.jina.ai/${ cleanedUrl.trim() }`;\n\t\tconst response = await fetch( requestURL.trim(), {\n\t\t\theaders: {\n\t\t\t\t'X-With-Generated-Alt': 'true'\n\t\t\t}\n\t\t} );\n\t\tif ( !response.ok ) {\n\t\t\tthrow new Error( `HTTP error! status: ${ response.status }` );\n\t\t}\n\t\tconst content = await response.text();\n\n\t\t// Updated error matching\n\t\tif ( content.includes( 'Warning: Target URL returned error' ) ) {\n\t\t\tthrow new Error( `Target URL (${ trimmedUrl }) returned an error` );\n\t\t}\n\n\t\tif ( content.trim().length === 0 ) {\n\t\t\tthrow new Error( 'Empty content received' );\n\t\t}\n\n\t\treturn content.replace( /\\(https?:\\/\\/[^\\s]+\\)/g, '' ).replace( /^\\s*$/gm, '' ).trim();\n\t} catch ( error ) {\n\t\tconsole.error( `Failed to fetch content: ${ url }`, error );\n\t\taiAgentContext.showError( 'Failed to fetch URL content' );\n\t\treturn '';\n\t}\n}\n","import type { Editor } from 'ckeditor5/src/core.js';\nimport type { MarkdownContent, PromptComponentKey, PromptSettings } from '../type-identifiers.js';\nimport { aiAgentContext } from '../aiagentcontext.js';\nimport { removeLeadingSpaces, extractEditorContent, trimMultilineString } from './text-utils.js';\nimport { countTokens, trimLLMContentByTokens } from './token-utils.js';\nimport { fetchUrlContent } from './url-utils.js';\nimport { getDefaultRules } from './default-rules.js';\nimport { getAllowedHtmlTags } from './html-utils.js';\n\nexport class PromptHelper {\n\tprivate editor: Editor;\n\tprivate contextSize: number;\n\tprivate promptSettings: PromptSettings;\n\tprivate debugMode: boolean;\n\tprivate editorContextRatio: number;\n\n\tconstructor( editor: Editor, options: { editorContextRatio?: number } = {} ) {\n\t\tthis.editor = editor;\n\t\tconst config = editor.config.get( 'aiAgent' )!;\n\n\t\tthis.contextSize = config.contextSize ?? 4000;\n\t\tthis.promptSettings = config.promptSettings ?? {};\n\t\tthis.debugMode = config.debugMode ?? false;\n\t\tthis.editorContextRatio = options.editorContextRatio ?? 0.3;\n\t}\n\n\tpublic getSystemPrompt( isInlineResponse: boolean = false ): string {\n\t\tconst defaultComponents = getDefaultRules( this.editor );\n\t\tlet systemPrompt = '';\n\n\t\t// Process each component\n\t\tfor ( const [ id, defaultContent ] of Object.entries( defaultComponents ) ) {\n\t\t\t// Skip components that are not allowed in the editor and not inline response\n\t\t\tif (\n\t\t\t\t( id === 'imageHandling' && !getAllowedHtmlTags( this.editor ).includes( 'img' ) ) ||\n\t\t\t\t( id === 'inlineContent' && !isInlineResponse )\n\t\t\t) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst componentId = id as PromptComponentKey;\n\t\t\tlet content = defaultContent;\n\n\t\t\t// Apply overrides if they exist\n\t\t\tif ( this.promptSettings.overrides?.[ componentId ] ) {\n\t\t\t\tcontent = this.promptSettings.overrides[ componentId ]!;\n\t\t\t}\n\n\t\t\t// Apply additions if they exist\n\t\t\tif ( this.promptSettings.additions?.[ componentId ] ) {\n\t\t\t\tcontent += '\\n' + this.promptSettings.additions[ componentId ];\n\t\t\t}\n\n\t\t\t// Add the component to the system prompt\n\t\t\tsystemPrompt += trimMultilineString( content ) + ( '\\n\\n' );\n\t\t}\n\n\t\tif ( this.debugMode ) {\n\t\t\tconsole.group( 'AiAgent System Prompt Debug' );\n\t\t\tconsole.log( 'System Prompt:', systemPrompt );\n\t\t\tconsole.groupEnd();\n\t\t}\n\n\t\treturn systemPrompt;\n\t}\n\n\tpublic trimContext( prompt: string, promptContainerText: string = '' ): string {\n\t\tlet contentBeforePrompt = '';\n\t\tlet contentAfterPrompt = '';\n\t\tconst splitText = promptContainerText ?? prompt;\n\t\tconst view = this.editor?.editing?.view?.domRoots?.get( 'main' );\n\t\tconst context = view?.innerText ?? '';\n\n\t\tconst matchIndex = context.indexOf( splitText );\n\t\tconst nextEnterIndex = context.indexOf( '\\n', matchIndex );\n\t\tconst firstNewlineIndex = nextEnterIndex !== -1 ? nextEnterIndex : matchIndex + splitText.length;\n\t\tconst beforeNewline = context.substring( 0, firstNewlineIndex );\n\t\tconst afterNewline = context.substring( firstNewlineIndex + 1 );\n\t\tconst contextParts = [ beforeNewline, afterNewline ];\n\n\t\tconst allocatedEditorContextToken = Math.floor( this.contextSize * this.editorContextRatio );\n\t\tif ( contextParts.length > 1 ) {\n\t\t\tif ( contextParts[ 0 ].length < contextParts[ 1 ].length ) {\n\t\t\t\tcontentBeforePrompt = extractEditorContent(\n\t\t\t\t\tcontextParts[ 0 ],\n\t\t\t\t\tallocatedEditorContextToken / 2,\n\t\t\t\t\ttrue,\n\t\t\t\t\tthis.editor\n\t\t\t\t);\n\t\t\t\tcontentAfterPrompt = extractEditorContent(\n\t\t\t\t\tcontextParts[ 1 ],\n\t\t\t\t\tallocatedEditorContextToken - contentBeforePrompt.length / 4,\n\t\t\t\t\tfalse,\n\t\t\t\t\tthis.editor\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tcontentAfterPrompt = extractEditorContent(\n\t\t\t\t\tcontextParts[ 1 ],\n\t\t\t\t\tallocatedEditorContextToken / 2,\n\t\t\t\t\tfalse,\n\t\t\t\t\tthis.editor\n\t\t\t\t);\n\t\t\t\tcontentBeforePrompt = extractEditorContent(\n\t\t\t\t\tcontextParts[ 0 ],\n\t\t\t\t\tallocatedEditorContextToken - contentAfterPrompt.length / 4,\n\t\t\t\t\ttrue,\n\t\t\t\t\tthis.editor\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Combine the trimmed context with the cursor placeholder\n\t\tconst escapedPrompt = prompt.replace( /[.*+?^${}()|[\\]\\\\]/g, '\\\\$&' ); // Escapes special characters\n\t\tcontentBeforePrompt = contentBeforePrompt.trim()\n\t\t\t.replace( new RegExp( escapedPrompt.slice( 1 ) ), '@@@cursor@@@' )\n\t\t\t.replace( '/@@@cursor@@@', '@@@cursor@@@' ); // Remove forward slash if present\n\t\tconst trimmedContext = `${ contentBeforePrompt }\\n${ contentAfterPrompt }`;\n\t\treturn trimmedContext.trim();\n\t}\n\n\tpublic formatFinalPrompt(\n\t\trequest: string,\n\t\tcontext: string,\n\t\tmarkDownContents: Array<MarkdownContent>,\n\t\tisEditorEmpty: boolean,\n\t\tselectedContent?: string\n\t): string {\n\t\tif ( this.debugMode ) {\n\t\t\tconsole.group( 'formatFinalPrompt Debug' );\n\t\t\tconsole.log( 'Request:', request );\n\t\t\tconsole.log( 'Context:', context );\n\t\t\tconsole.log( 'MarkDownContents:', markDownContents );\n\t\t\tconsole.log( 'IsEditorEmpty:', isEditorEmpty );\n\t\t}\n\n\t\tconst contentLanguageCode = this.editor.locale.contentLanguage;\n\t\tconst corpus: Array<string> = [];\n\n\t\t// Task Section\n\t\tcorpus.push( '<TASK>' );\n\t\tcorpus.push( request );\n\t\tcorpus.push( '</TASK>' );\n\n\t\t// Context Section\n\t\tif ( context?.length && !selectedContent ) {\n\t\t\tcorpus.push( '\\n<CONTEXT>' );\n\t\t\tcorpus.push( context );\n\t\t\tcorpus.push( '</CONTEXT>' );\n\t\t}\n\n\t\tif ( selectedContent ) {\n\t\t\tcorpus.push( '<SELECTED_CONTENT>' );\n\t\t\tcorpus.push( selectedContent );\n\t\t\tcorpus.push( '</SELECTED_CONTENT>' );\n\t\t}\n\n\t\t// Markdown Content Section\n\t\tif ( markDownContents?.length ) {\n\t\t\tcorpus.push( '\\n<REFERENCE_CONTENT>' );\n\t\t\tfor ( const content of markDownContents ) {\n\t\t\t\tcorpus.push( `<SOURCE url=\"${ content.url }\">\\n${ content.content }\\n</SOURCE>` );\n\t\t\t}\n\t\t\tcorpus.push( '</REFERENCE_CONTENT>' );\n\n\t\t\tcorpus.push( '\\n<REFERENCE_GUIDELINES>' );\n\t\t\tcorpus.push( trimMultilineString( `\n\t\t\t\tUse information from provided markdown to generate new text.\n\t\t\t\tDo not copy content verbatim.\n\t\t\t\tEnsure natural flow with existing context.\n\t\t\t\tAvoid markdown formatting in response.\n\t\t\t\tConsider whole markdown as single source.\n\t\t\t\tGenerate requested percentage of content.\n\t\t\t` ) );\n\t\t\tcorpus.push( '</REFERENCE_GUIDELINES>' );\n\t\t}\n\n\t\t// Instructions Section\n\t\tcorpus.push( '\\n<INSTRUCTIONS>' );\n\t\tcorpus.push( `The response must follow the language code - ${ contentLanguageCode }.` );\n\t\tcorpus.push( '</INSTRUCTIONS>' );\n\n\t\t// Context-Specific Instructions\n\t\tif ( !isEditorEmpty && !selectedContent ) {\n\t\t\tcorpus.push( '\\n<CONTEXT_REQUIREMENTS>' );\n\t\t\tcorpus.push( trimMultilineString( `\n\t\t\t\tReplace \"@@@cursor@@@\" with contextually appropriate content.\n\t\t\t\tReplace ONLY @@@cursor@@@ - surrounding text is READ-ONLY.\n\t\t\t\tNEVER copy or paraphrase context text.\n\t\t\t\tVerify zero phrase duplication.\n\t\t\t\tAnalyze the CONTEXT section thoroughly \n\t\t\t\tto understand the existing content and its style.\n\t\t\t\tGenerate a response that seamlessly integrates \n\t\t\t\twith the existing content.\n\t\t\t\tDetermine the appropriate tone and style based\n\t\t\t\ton the context. Ensure the response flows \n\t\t\t\tnaturally with the existing content.\n\n\t\t\t` ) );\n\t\t\tcorpus.push( '</CONTEXT_REQUIREMENTS>' );\n\t\t}\n\n\t\t// Debug Output\n\t\tif ( this.debugMode ) {\n\t\t\tconsole.group( 'AiAgent Final Prompt Debug' );\n\t\t\tconsole.log( 'Final Prompt:', corpus.join( '\\n' ) );\n\t\t\tconsole.groupEnd();\n\t\t}\n\n\t\treturn corpus.map( text => removeLeadingSpaces( text ) ).join( '\\n' );\n\t}\n\n\tpublic async generateMarkDownForUrls( urls: Array<string> ): Promise<Array<MarkdownContent>> {\n\t\ttry {\n\t\t\tconst markdownContents: Array<MarkdownContent> = [];\n\n\t\t\tfor ( const url of urls ) {\n\t\t\t\ttry {\n\t\t\t\t\tconst content = await fetchUrlContent( url );\n\t\t\t\t\tif ( content ) {\n\t\t\t\t\t\tmarkdownContents.push( {\n\t\t\t\t\t\t\tcontent,\n\t\t\t\t\t\t\turl,\n\t\t\t\t\t\t\ttokenCount: countTokens( content )\n\t\t\t\t\t\t} );\n\t\t\t\t\t}\n\t\t\t\t} catch ( error ) {\n\t\t\t\t\tif ( this.debugMode ) {\n\t\t\t\t\t\tconsole.error( `Failed to fetch content from ${ url }:`, error );\n\t\t\t\t\t}\n\t\t\t\t\taiAgentContext.showError( `Failed to fetch content from ${ url }` );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn this.allocateTokensToFetchedContent(\n\t\t\t\tthis.getSystemPrompt(),\n\t\t\t\tmarkdownContents\n\t\t\t);\n\t\t} catch ( error ) {\n\t\t\tif ( this.debugMode ) {\n\t\t\t\tconsole.error( 'Error generating markdown content:', error );\n\t\t\t}\n\t\t\taiAgentContext.showError( 'Failed to generate markdown content' );\n\t\t\treturn [];\n\t\t}\n\t}\n\n\tpublic allocateTokensToFetchedContent(\n\t\tprompt: string,\n\t\tfetchedContent: Array<MarkdownContent>\n\t): Array<MarkdownContent> {\n\t\tconst editorContent = this.editor?.editing?.view?.domRoots?.get( 'main' )?.innerText ?? '';\n\t\tconst editorToken = Math.min(\n\t\t\tMath.floor( this.contextSize * this.editorContextRatio ),\n\t\t\tcountTokens( editorContent )\n\t\t);\n\t\tconst availableLimit = this.contextSize - editorToken;\n\n\t\tif ( availableLimit === 0 || !fetchedContent.length ) {\n\t\t\treturn fetchedContent;\n\t\t}\n\n\t\tconst tokensPerContent = Math.floor( availableLimit / fetchedContent.length );\n\n\t\treturn fetchedContent.map( content => ( {\n\t\t\t...content,\n\t\t\tcontent: trimLLMContentByTokens( content.content, tokensPerContent )\n\t\t} ) );\n\t}\n}\n","import { getAllowedHtmlTags } from './html-utils.js';\n\nexport function getDefaultRules( editor: any ): { [key: string]: string } {\n\treturn {\n\t\tresponseRules: `\n            Follow these step-by-step instructions to respond to user inputs:\n            Identify the specific requirements from the TASK section.\n            Do not include any markdown syntax in the response.\n            Generate a response that seamlessly integrates with the existing content.\n            Format the response according to the HTML and structural requirements.\n            Verify that the response meets all formatting and content guidelines.\n            If there is SELECTED_CONTENT I'll use only that content to answer\n\t\t\tthe user's request in the TASK section, ignoring any additional CONTEXT\n\t\t\tor prior knowledge.\n        `,\n\t\thtmlFormatting: `\n            HTML Formatting Requirements:\n            Generate valid HTML snippets only.\n            Use only the following allowed tags: ${ getAllowedHtmlTags( editor ).join( ', ' ) }.\n            Ensure proper tag nesting.\n            Avoid empty elements.\n            Use semantic HTML where appropriate.\n            Maintain clean, readable HTML structure.\n            Follow block-level element rules.\n            Properly close all tags.\n            No inline styles unless specified.\n            No script or style tags.\n            The first word must be a valid HTML tag.\n            Block elements must not contain other block elements.\n        `,\n\t\tcontentStructure: `\n            Content Structure Rules:\n            Organize information logically.\n            Use appropriate paragraph breaks.\n            Maintain consistent formatting.\n            Follow document hierarchy.\n            Use appropriate list structures when needed.\n            Ensure proper content flow.\n            Respect existing document structure.\n        `,\n\t\ttone: `\n            Language and Tone Guidelines:\n            Match the formality level of the surrounding content.\n            Maintain a consistent voice throughout the response.\n            Use appropriate technical terminology when relevant.\n            Ensure proper grammar and punctuation.\n            Avoid overly complex sentence structures.\n            Keep the tone engaging and reader-friendly.\n            Adapt style based on content type.\n        `,\n\t\tinlineContent: `\n            Inline Content Specific Rules:\n            Determine content type (list, table, or inline).\n            Format according to content type.\n            Ensure seamless integration.\n            Preserve existing content flow.\n            Maintain proper nesting.\n        `,\n\t\timageHandling: `\n            Image Element Requirements:\n            Every <img> must have src and alt attributes.\n            Format src URLs as: https://placehold.co/600x400?text=[alt_text].\n            Alt text must be descriptive and meaningful.\n        `\n\t};\n}\n","import type { Editor } from 'ckeditor5/src/core.js';\nimport type { Element, Model, Position } from 'ckeditor5/src/engine.js';\n\nexport class HtmlParser {\n\tprivate editor: Editor;\n\tprivate model: Model;\n\tprivate debugMode: boolean;\n\n\tconstructor( editor: Editor ) {\n\t\tthis.editor = editor;\n\t\tthis.model = editor.model;\n\t\tthis.debugMode = editor.config.get( 'aiAgent.debugMode' ) ?? false;\n\t}\n\n\t/**\n\t * Inserts simple HTML content into the editor.\n\t *\n\t * @param html - The HTML string to be inserted into the editor.\n\t * @returns A promise that resolves when the HTML has been inserted.\n\t */\n\tpublic async insertSimpleHtml( html: string ): Promise<void> {\n\t\tif ( this.debugMode ) {\n\t\t\tconsole.log( 'Attempting to insert simple HTML:', html );\n\t\t}\n\t\tconst viewFragment = this.editor.data.processor.toView( html );\n\t\tconst modelFragment = this.editor.data.toModel( viewFragment, '$root' );\n\n\t\tconst selection = this.model.document.selection;\n\t\tconst root = this.model.document.getRoot();\n\n\t\tlet insertionPosition = selection.getLastPosition();\n\t\tconst lastInsertedChild = modelFragment.getChild( modelFragment.childCount - 1 );\n\n\t\tconst currentChildIndex = selection.getLastPosition()?.path[ 0 ];\n\t\tconst lastUpdatedElementInRoot = root?.getChild( currentChildIndex ?? 0 );\n\n\t\tthis.model.change( writer => {\n\t\t\tif ( lastUpdatedElementInRoot?.is( 'element' ) ) {\n\t\t\t\tinsertionPosition = lastUpdatedElementInRoot.isEmpty ?\n\t\t\t\t\twriter.createPositionAt( lastUpdatedElementInRoot, 'end' ) :\n\t\t\t\t\twriter.createPositionAfter( lastUpdatedElementInRoot );\n\t\t\t}\n\n\t\t\tif ( insertionPosition && root ) {\n\t\t\t\t// Insert element to current selection\n\t\t\t\twriter.setSelection( insertionPosition );\n\t\t\t\tthis.model.insertContent( modelFragment, insertionPosition );\n\n\t\t\t\t// Check if it required to add break to current context of list etc.\n\t\t\t\t// More to will be added during testing any edge case\n\t\t\t\tlet isBreakElementReq = lastInsertedChild?.getAttribute( 'listItemId' );\n\t\t\t\tif ( lastInsertedChild?.is( 'element' ) ) {\n\t\t\t\t\tisBreakElementReq = isBreakElementReq || lastInsertedChild.name === 'table';\n\t\t\t\t}\n\t\t\t\tif ( isBreakElementReq && lastInsertedChild ) {\n\t\t\t\t\tconst paragraph = writer.createElement( 'paragraph' );\n\t\t\t\t\twriter.insert( paragraph, writer.createPositionAfter( lastInsertedChild ) );\n\t\t\t\t\twriter.setSelection( paragraph, 'in' );\n\t\t\t\t} else if ( lastInsertedChild ) {\n\t\t\t\t\twriter.setSelection( writer.createPositionAfter( lastInsertedChild ) );\n\t\t\t\t}\n\t\t\t}\n\t\t} );\n\n\t\t// Maintain a delay to simulate asynchronous behavior\n\t\tawait new Promise( resolve => setTimeout( resolve, 100 ) );\n\t}\n\n\t/**\n\t * Inserts HTML content as text into the editor.\n\t *\n\t * @param content - The HTML element containing the text to be inserted.\n\t * @param position - The position at which to insert the text (optional).\n\t * @param stream - Indicates whether to insert text in a streaming manner (default is false).\n\t * @param shouldAddBreakAtEnd - Indicates whether to add a paragraph break at the end of the inserted content (default is false).\n\t * @returns A promise that resolves when the text has been inserted.\n\t *\n\t * This method processes the provided HTML element, converting it to a model fragment,\n\t * and inserts it into the editor at the specified position. If streaming is enabled,\n\t * elements are inserted one at a time, allowing for a more dynamic insertion experience.\n\t * An optional paragraph break can be added at the end of the inserted content.\n\t*/\n\tpublic async insertAsText(\n\t\tcontent: HTMLElement,\n\t\tposition?: Position,\n\t\tstream: boolean = false,\n\t\tshouldAddBreakAtEnd: boolean = false\n\t): Promise<void> {\n\t\tconst viewFragment = this.editor.data.processor.toView( content.outerHTML );\n\t\tconst modelFragment = this.editor.data.toModel( viewFragment, '$root' );\n\t\tconst childrenToInsert = Array.from( modelFragment.getChildren() );\n\t\tconst root = this.model.document.getRoot();\n\n\t\tfor ( const [ index, element ] of childrenToInsert.entries() ) {\n\t\t\tif ( element.is( 'element' ) ) {\n\t\t\t\tconst insertPosition = index === 0 ? position : undefined; // Determine position for insertion\n\t\t\t\tif ( stream ) {\n\t\t\t\t\tawait this.insertElementAsStream( element, insertPosition );\n\t\t\t\t} else {\n\t\t\t\t\tawait this.batchInsertOfElement( element, insertPosition );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif ( shouldAddBreakAtEnd ) {\n\t\t\tthis.model.change( writer => {\n\t\t\t\tconst lastPosition = this.model.document.selection.getLastPosition();\n\t\t\t\tconst currentChildIndex = lastPosition?.path[ 0 ];\n\t\t\t\tif ( root && currentChildIndex != undefined ) {\n\t\t\t\t\tconst paragraph = writer.createElement( 'paragraph' );\n\t\t\t\t\twriter.insert( paragraph, root, currentChildIndex + 1 );\n\t\t\t\t\twriter.setSelection( paragraph, 'in' );\n\t\t\t\t}\n\t\t\t} );\n\t\t}\n\t}\n\n\t/**\n\t * Inserts a given element into the editor at the specified position.\n\t *\n\t * @param element - The element to be inserted into the editor.\n\t * @param position - The position at which to insert the element.\n\t * If not provided, the element will be inserted at the current selection position.\n\t * @returns A promise that resolves when the element has been inserted.\n\t */\n\tpublic async batchInsertOfElement( element: Element, position?: Position ): Promise<void> {\n\t\tconst selection = this.model.document.selection;\n\t\tconst root = this.model.document.getRoot();\n\n\t\tlet insertionPosition: Position | undefined = position;\n\n\t\tif ( !position ) {\n\t\t\tconst currentChildIndex = selection.getFirstPosition()?.path[ 0 ];\n\t\t\tconst lastUpdatedElementInRoot = root?.getChild( currentChildIndex ?? 0 );\n\t\t\tif ( lastUpdatedElementInRoot?.is( 'element' ) ) {\n\t\t\t\tinsertionPosition = lastUpdatedElementInRoot.isEmpty ?\n\t\t\t\t\tthis.model.createPositionAt( lastUpdatedElementInRoot, 'end' ) :\n\t\t\t\t\tthis.model.createPositionAfter( lastUpdatedElementInRoot );\n\t\t\t}\n\t\t}\n\n\t\t// insert content at current identified position\n\t\tthis.model.change( writer => {\n\t\t\tthis.model.insertContent( element, insertionPosition );\n\t\t\twriter.setSelection( element, 'end' );\n\t\t} );\n\t}\n\n\t/**\n\t * Inserts a given element into the editor at the specified position in a streaming manner.\n\t *\n\t * @param element - The element to be inserted into the editor.\n\t * @param position - The position at which to insert the element.\n\t * If not provided, the element will be inserted at the current selection position.\n\t * @returns A promise that resolves when the element has been inserted and all text has been streamed in.\n\t */\n\tprivate async insertElementAsStream( element: Element, position?: Position ): Promise<void> {\n\t\tconst selection = this.model.document.selection;\n\t\tconst root = this.model.document.getRoot();\n\t\tconst lastRecognizedPosition = selection.getLastPosition();\n\n\t\tlet insertionPosition: Position | undefined = position;\n\t\tlet targetElement: Element;\n\n\t\t// Determine insertion position\n\t\tif ( !position ) {\n\t\t\tconst currentChildIndex = lastRecognizedPosition?.path[ 0 ];\n\t\t\tconst lastUpdatedElement = root?.getChild( currentChildIndex ?? 0 );\n\n\t\t\tif ( lastUpdatedElement?.is( 'element' ) ) {\n\t\t\t\tinsertionPosition = lastUpdatedElement.isEmpty ?\n\t\t\t\t\tthis.model.createPositionAt( lastUpdatedElement, 'end' ) :\n\t\t\t\t\tthis.model.createPositionAfter( lastUpdatedElement );\n\t\t\t}\n\n\t\t\tthis.model.change( writer => {\n\t\t\t\ttargetElement = writer.createElement( element.name );\n\t\t\t\t// Set attributes in a more concise way\n\t\t\t\tfor ( const [ key, value ] of element.getAttributes() ) {\n\t\t\t\t\ttargetElement._setAttribute( key, value );\n\t\t\t\t}\n\t\t\t\tthis.model.insertContent( targetElement, insertionPosition );\n\t\t\t\tif ( insertionPosition ) {\n\t\t\t\t\twriter.setSelection( targetElement, 'end' );\n\t\t\t\t}\n\t\t\t} );\n\t\t} else {\n\t\t\t// current element from the offset\n\t\t\tconst currentElement = lastRecognizedPosition?.parent;\n\t\t\tif ( currentElement?.is( 'element' ) ) {\n\t\t\t\ttargetElement = currentElement;\n\t\t\t}\n\t\t}\n\n\t\tconst textChildren = Array.from( element.getChildren() ).filter( child => child.is( '$text' ) );\n\n\t\tfor ( const textNode of textChildren ) {\n\t\t\tif ( !textNode.is( '$text' ) ) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst textAttributes = Array.from( textNode.getAttributes() );\n\t\t\tconst textContent = textNode._data;\n\n\t\t\tfor ( const char of textContent ) {\n\t\t\t\tawait new Promise( resolve => {\n\t\t\t\t\tthis.model.change( writer => {\n\t\t\t\t\t\tconst currentPosition = this.editor.model.document.selection.getLastPosition();\n\t\t\t\t\t\tconst newPosition = currentPosition!.getShiftedBy( 1 );\n\t\t\t\t\t\tconst shouldAppendAtEnd = newPosition.offset === currentPosition?.parent.maxOffset;\n\t\t\t\t\t\twriter.insertText( char, textAttributes, targetElement, shouldAppendAtEnd ? 'end' : currentPosition?.offset );\n\t\t\t\t\t\twriter.setSelection( this.editor.model.document.selection.getLastPosition() );\n\t\t\t\t\t} );\n\t\t\t\t\tsetTimeout( resolve, 5 ); // Maintain the streaming effect\n\t\t\t\t} );\n\t\t\t}\n\t\t}\n\n\t\t// Set selection\n\t\tif ( !position ) {\n\t\t\tthis.model.change( writer => {\n\t\t\t\twriter.setSelection( targetElement, 'end' );\n\t\t\t} );\n\t\t}\n\t}\n\n\t/**\n\t * Validate given string as a HTML content\n\t * @param content string containing html content\n\t * @returns A boolean value as result of validation\n\t */\n\tpublic isCompleteHtmlChunk( html: string ): boolean {\n\t\tconst openingTags = ( html.match( /<[^/][^>]*>/g ) || [] ).length;\n\t\tconst closingTags = ( html.match( /<\\/[^>]+>/g ) || [] ).length;\n\n\t\t// Check if all opening tags have corresponding closing tags\n\t\tif ( openingTags !== closingTags ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Check for incomplete tags\n\t\tif ( html.includes( '<' ) && !html.includes( '>' ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Check if the HTML starts with an opening tag and ends with a closing tag\n\t\tconst trimmedHtml = html.trim();\n\t\tif ( !trimmedHtml.startsWith( '<' ) || !trimmedHtml.endsWith( '>' ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n}\n","import type { Editor } from 'ckeditor5/src/core.js';\nimport type { Element } from 'ckeditor5/src/engine.js';\nimport type { AiModel, MarkdownContent, ModerationResponse, ModerationFlagsTypes } from './type-identifiers.js';\nimport { aiAgentContext } from './aiagentcontext.js';\nimport { PromptHelper } from './util/prompt.js';\nimport { HtmlParser } from './util/htmlparser.js';\nimport { ButtonView } from 'ckeditor5/src/ui.js';\nimport { env } from 'ckeditor5/src/utils.js';\nimport { ALL_MODERATION_FLAGS, MODERATION_URL } from './const.js';\n\nexport default class AiAgentService {\n\tprivate editor: Editor;\n\tprivate aiModel: AiModel;\n\tprivate apiKey: string | undefined;\n\tprivate endpointUrl: string;\n\tprivate temperature: number | undefined;\n\tprivate timeOutDuration: number;\n\tprivate maxTokens: number;\n\tprivate retryAttempts: number;\n\tprivate streamContent: boolean;\n\tprivate stopSequences: Array<string>;\n\tprivate aiAgentFeatureLockId = Symbol( 'ai-agent-feature' );\n\tprivate promptHelper: PromptHelper;\n\tprivate htmlParser: HtmlParser;\n\n\tprivate buffer = '';\n\tprivate openTags: Array<string> = [];\n\tprivate isInlineInsertion: boolean = false;\n\tprivate abortGeneration: boolean = false;\n\tprivate moderationKey: string;\n\tprivate moderationEnable: boolean;\n\tprivate disableFlags: Array<ModerationFlagsTypes> = [];\n\n\t/**\n\t * Initializes the AiAgentService with the provided editor and configuration settings.\n\t *\n\t * @param editor - The CKEditor instance to be used with the AI assist service.\n\t */\n\tconstructor( editor: Editor ) {\n\t\tthis.editor = editor;\n\t\tthis.promptHelper = new PromptHelper( editor );\n\t\tthis.htmlParser = new HtmlParser( editor );\n\t\tconst config = editor.config.get( 'aiAgent' )!;\n\n\t\tthis.aiModel = config.model!;\n\t\tthis.apiKey = config.apiKey;\n\t\tthis.endpointUrl = config.endpointUrl!;\n\t\tthis.temperature = config.temperature;\n\t\tthis.timeOutDuration = config.timeOutDuration ?? 45000;\n\t\tthis.maxTokens = config.maxOutputTokens ?? config.maxTokens!;\n\t\tthis.retryAttempts = config.retryAttempts!;\n\t\tthis.stopSequences = config.stopSequences!;\n\t\tthis.streamContent = config.streamContent ?? true;\n\t\tthis.moderationKey = config.moderation?.key ?? '';\n\t\tthis.moderationEnable = config.moderation?.enable ?? false;\n\t\tthis.disableFlags = config.moderation?.disableFlags ?? [];\n\t}\n\n\t/**\n\t * Handles the slash command input from the user, processes it, and interacts with the AI model.\n\t *\n\t * @returns A promise that resolves when the command has been processed.\n\t */\n\tpublic async handleSlashCommand( command?: string ): Promise<void> {\n\t\tconst editor = this.editor;\n\t\tconst model = editor.model;\n\t\tconst mapper = editor.editing.mapper;\n\t\tconst view = editor.editing.view;\n\t\tconst root = model.document.getRoot();\n\n\t\tlet content: string | undefined;\n\t\tlet selectedContent: string | undefined;\n\t\tlet parentEquivalentHTML: HTMLElement | undefined;\n\t\tlet parent: Element | undefined;\n\t\tconst position = model.document.selection.getLastPosition();\n\n\t\tif ( position && root ) {\n\t\t\tparent = position.parent as Element;\n\t\t\tconst inlineSlash = parent.name === 'inline-slash' ? parent : undefined;\n\t\t\tconst equivalentView = mapper.toViewElement( parent );\n\t\t\tparentEquivalentHTML = equivalentView ? view.domConverter.mapViewToDom( equivalentView ) : undefined;\n\n\t\t\tif ( inlineSlash ) {\n\t\t\t\teditor.model.change( writer => {\n\t\t\t\t\tconst endPosition = writer.createPositionAt( inlineSlash, 'end' );\n\t\t\t\t\twriter.setSelection( endPosition );\n\t\t\t\t} );\n\n\t\t\t\tthis.isInlineInsertion = true;\n\t\t\t\tconst startPosition = editor.model.createPositionAt( inlineSlash, 0 );\n\t\t\t\tconst endPosition = editor.model.createPositionAt( inlineSlash, 'end' );\n\t\t\t\tconst range = model.createRange( startPosition, endPosition );\n\t\t\t\tparentEquivalentHTML = equivalentView?.parent ?\n\t\t\t\t\tview.domConverter.mapViewToDom( equivalentView.parent ) as HTMLElement :\n\t\t\t\t\tundefined;\n\t\t\t\tcontent = '';\n\n\t\t\t\tfor ( const item of range.getItems() ) {\n\t\t\t\t\tif ( item.is( '$textProxy' ) ) {\n\t\t\t\t\t\tcontent += item.data.trim(); // Add text data\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else if ( parentEquivalentHTML ) {\n\t\t\t\teditor.model.change( writer => {\n\t\t\t\t\tconst endPosition = writer.createPositionAt( position.parent, 'end' );\n\t\t\t\t\twriter.setSelection( endPosition );\n\t\t\t\t} );\n\t\t\t\tcontent = parentEquivalentHTML?.innerText;\n\t\t\t}\n\t\t}\n\n\t\tif ( command ) {\n\t\t\tcontent = command;\n\t\t\tselectedContent = parentEquivalentHTML?.outerHTML;\n\t\t\tconst selection = model.document.selection;\n\t\t\tconst range = selection.getFirstRange();\n\t\t\tif ( range ) {\n\t\t\t\tmodel.change( writer => {\n\t\t\t\t\twriter.setSelection( range.end );\n\t\t\t\t} );\n\t\t\t}\n\t\t}\n\n\t\tif ( this.moderationEnable ) {\n\t\t\tconst moderateContent = await this.moderateContent( content ?? '' );\n\t\t\tif ( !moderateContent ) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\ttry {\n\t\t\tconst domSelection = window.getSelection();\n\t\t\tconst domRange: any = domSelection?.getRangeAt( 0 );\n\t\t\tconst rect = domRange.getBoundingClientRect();\n\n\t\t\taiAgentContext.showLoader( rect );\n\t\t\tconst gptPrompt = await this.generateGptPromptBasedOnUserPrompt(\n\t\t\t\tcontent ?? '',\n\t\t\t\tparentEquivalentHTML?.innerText,\n\t\t\t\tselectedContent\n\t\t\t);\n\t\t\tif ( parent && gptPrompt ) {\n\t\t\t\tawait this.fetchAndProcessGptResponse( gptPrompt, parent );\n\t\t\t}\n\t\t} catch ( error ) {\n\t\t\tconsole.error( 'Error handling slash command:', error );\n\t\t\tthrow error;\n\t\t} finally {\n\t\t\tthis.isInlineInsertion = false;\n\t\t\taiAgentContext.hideLoader();\n\t\t}\n\t}\n\n\t/**\n\t * Moderates the input content using OpenAI's moderation API to check for inappropriate content.\n\t *\n\t * @param input - The text content to be moderated\n\t * @returns A promise that resolves to:\n\t * - `true` if content is acceptable or if moderation fails (fail-open)\n\t * - `false` if content is flagged as inappropriate\n\t *\n\t * @throws Shows user-friendly error messages via aiAgentContext for:\n\t * - Flagged content (\"Cannot process your query...\")\n\t * - API errors (\"Error in content moderation\")\n\t */\n\tprivate async moderateContent( input: string ): Promise<boolean> {\n\t\tif ( !this.moderationKey ) {\n\t\t\treturn true;\n\t\t}\n\t\tconst editor = this.editor;\n\t\tconst t = editor.t;\n\t\tconst controller = new AbortController();\n\n\t\t// Set timeout for moderation request\n\t\tconst timeoutId = setTimeout( () => controller.abort(), this.timeOutDuration );\n\n\t\ttry {\n\t\t\tconst response = await fetch( MODERATION_URL, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Authorization': `Bearer ${ this.moderationKey }`,\n\t\t\t\t\t'Content-Type': 'application/json'\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify( { input } ),\n\t\t\t\tsignal: controller.signal\n\t\t\t} );\n\n\t\t\tclearTimeout( timeoutId );\n\n\t\t\tif ( !response.ok ) {\n\t\t\t\tthrow new Error( `HTTP error! status: ${ response.status }` );\n\t\t\t}\n\n\t\t\tconst data = await response.json() as ModerationResponse;\n\n\t\t\tif ( !data?.results?.[ 0 ] ) {\n\t\t\t\tthrow new Error( 'Invalid moderation response format' );\n\t\t\t}\n\n\t\t\tconst flags = ALL_MODERATION_FLAGS.filter( flag => !this.disableFlags.includes( flag ) );\n\n\t\t\tif ( data.results[ 0 ].flagged ) {\n\t\t\t\tlet error = false;\n\t\t\t\tconst categories = data.results[ 0 ].categories;\n\t\t\t\tfor ( let index = 0; index < flags.length; index++ ) {\n\t\t\t\t\tconst flag = flags[ index ];\n\t\t\t\t\tif ( flags.includes( flag ) ) {\n\t\t\t\t\t\tif ( categories[ flag ] ) {\n\t\t\t\t\t\t\terror = true;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif ( error ) {\n\t\t\t\t\taiAgentContext.showError( t( 'I\\'m sorry, but I cannot assist with that request.' ) );\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn true;\n\t\t} catch ( error ) {\n\t\t\tconsole.error( 'Moderation error:', error );\n\n\t\t\t// Handle specific error cases\n\t\t\tif ( error instanceof TypeError ) {\n\t\t\t\taiAgentContext.showError( t( 'Network error during content moderation' ) );\n\t\t\t} else if ( error instanceof DOMException && error.name === 'AbortError' ) {\n\t\t\t\taiAgentContext.showError( t( 'Content moderation timed out' ) );\n\t\t\t} else {\n\t\t\t\taiAgentContext.showError( t( 'Error in content moderation' ) );\n\t\t\t}\n\n\t\t\t// Fail open for moderation errors\n\t\t\treturn true;\n\t\t} finally {\n\t\t\tclearTimeout( timeoutId );\n\t\t}\n\t}\n\n\t/**\n\t * Fetches and processes the GPT response based on the provided prompt and parent element.\n\t *\n\t * @param prompt - The prompt to send to the GPT model.\n\t * @param parent - The parent element in the editor where the response will be inserted.\n\t * @param retries - The number of retry attempts for the API call (default is the configured retry attempts).\n\t * @returns A promise that resolves when the response has been processed.\n\t */\n\tprivate async fetchAndProcessGptResponse(\n\t\tprompt: string,\n\t\tparent: Element,\n\t\tretries: number = this.retryAttempts\n\t): Promise<void> {\n\t\tconsole.log( 'Starting fetchAndProcessGptResponse' );\n\t\tconst editor = this.editor;\n\t\tconst t = editor.t;\n\t\tconst controller = new AbortController();\n\t\tconst timeoutId = setTimeout(\n\t\t\t() => controller.abort(),\n\t\t\tthis.timeOutDuration\n\t\t);\n\n\t\tlet buffer = '';\n\t\tlet contentBuffer = '';\n\t\tconst blockID = `ai-${ new Date().getTime() }`;\n\n\t\ttry {\n\t\t\tconst response = await fetch( this.endpointUrl, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${ this.apiKey }`,\n\t\t\t\t\t'Content-Type': 'application/json'\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify( {\n\t\t\t\t\tmodel: this.aiModel,\n\t\t\t\t\tmessages: [\n\t\t\t\t\t\t{ role: 'system', content: this.promptHelper.getSystemPrompt( this.isInlineInsertion ) },\n\t\t\t\t\t\t{ role: 'user', content: prompt }\n\t\t\t\t\t],\n\t\t\t\t\ttemperature: this.temperature,\n\t\t\t\t\tmax_tokens: this.maxTokens,\n\t\t\t\t\tstop: this.stopSequences,\n\t\t\t\t\tstream: true\n\t\t\t\t} ),\n\t\t\t\tsignal: controller.signal\n\t\t\t} );\n\n\t\t\tclearTimeout( timeoutId );\n\n\t\t\tif ( !response.ok ) {\n\t\t\t\tthrow new Error( 'Fetch failed' );\n\t\t\t}\n\n\t\t\taiAgentContext.hideLoader();\n\n\t\t\tconst reader = response.body!.getReader();\n\t\t\tconst decoder = new TextDecoder( 'utf-8' );\n\n\t\t\tthis.clearParentContent( parent );\n\t\t\t// this.editor.enableReadOnlyMode( this.aiAgentFeatureLockId );\n\n\t\t\tlet insertParent = true;\n\n\t\t\tthis.cancelGenerationButton( blockID, controller );\n\n\t\t\teditor.model.change( writer => {\n\t\t\t\tconst position = editor.model.document.selection.getLastPosition();\n\t\t\t\tif ( position ) {\n\t\t\t\t\tconst aiTag = writer.createElement( 'ai-tag', {\n\t\t\t\t\t\tid: blockID\n\t\t\t\t\t} );\n\t\t\t\t\tconst parent = position.parent as Element;\n\t\t\t\t\tif ( parent ) {\n\t\t\t\t\t\tif ( parent.parent?.name === 'tableCell' ) {\n\t\t\t\t\t\t\tinsertParent = false;\n\t\t\t\t\t\t} else if ( parent.getAttribute( 'listType' ) === 'bulleted' ) {\n\t\t\t\t\t\t\tinsertParent = false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tlet parentContent = '';\n\t\t\t\t\tfor ( const child of parent.getChildren() ) {\n\t\t\t\t\t\tif ( child.is( '$text' ) ) {\n\t\t\t\t\t\t\tparentContent += child.data;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tconst nextLinePosition = parentContent ?\n\t\t\t\t\t\twriter.createPositionAt( position.parent, 'after' ) :\n\t\t\t\t\t\twriter.createPositionAt( position.parent, 'before' );\n\n\t\t\t\t\twriter.insert( aiTag, insertParent ? nextLinePosition : position );\n\t\t\t\t\tconst newPosition = writer.createPositionAt( aiTag, 'end' );\n\t\t\t\t\twriter.setSelection( newPosition );\n\t\t\t\t}\n\t\t\t} );\n\n\t\t\tconsole.log( 'Starting to process response' );\n\t\t\tfor ( ;; ) {\n\t\t\t\tconst { done, value } = await reader.read();\n\t\t\t\tif ( done ) {\n\t\t\t\t\tconsole.log( 'Finished reading response' );\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tconst chunk = decoder.decode( value, { stream: true } );\n\t\t\t\tbuffer += chunk;\n\n\t\t\t\tlet newlineIndex;\n\t\t\t\twhile ( ( newlineIndex = buffer.indexOf( '\\n' ) ) !== -1 ) {\n\t\t\t\t\tconst line = buffer.slice( 0, newlineIndex ).trim();\n\t\t\t\t\tbuffer = buffer.slice( newlineIndex + 1 );\n\n\t\t\t\t\tif ( line.startsWith( 'data: ' ) ) {\n\t\t\t\t\t\tconst jsonStr = line.slice( 5 ).trim();\n\t\t\t\t\t\tif ( jsonStr === '[DONE]' ) {\n\t\t\t\t\t\t\tconsole.log( 'Received [DONE] signal' );\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst data = JSON.parse( jsonStr );\n\t\t\t\t\t\t\tconst content = data.choices[ 0 ]?.delta?.content;\n\t\t\t\t\t\t\tif ( content !== null && content !== undefined ) {\n\t\t\t\t\t\t\t\tcontentBuffer += content;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tawait this.updateContent( contentBuffer, blockID );\n\t\t\t\t\t\t} catch ( parseError ) {\n\t\t\t\t\t\t\tconsole.warn( 'Error parsing JSON:', parseError );\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.processCompleted( blockID );\n\t\t} catch ( error: any ) {\n\t\t\tif ( this.abortGeneration ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconsole.error( 'Error in fetchAndProcessGptResponse:', error );\n\t\t\tconst errorIdentifier =\n\t\t\t\t( error?.message || '' ).trim() || ( error?.name || '' ).trim();\n\t\t\tconst isRetryableError = [\n\t\t\t\t'AbortError',\n\t\t\t\t'ReadableStream not supported',\n\t\t\t\t'AiAgent: Fetch failed'\n\t\t\t].includes( errorIdentifier );\n\t\t\tif ( retries > 0 && isRetryableError ) {\n\t\t\t\tconsole.warn( `Retrying... (${ retries } attempts left)` );\n\t\t\t\treturn await this.fetchAndProcessGptResponse(\n\t\t\t\t\tprompt,\n\t\t\t\t\tparent,\n\t\t\t\t\tretries - 1\n\t\t\t\t);\n\t\t\t}\n\t\t\tlet errorMessage: string;\n\t\t\tswitch ( error?.name || error?.message?.trim() ) {\n\t\t\t\tcase 'ReadableStream not supported':\n\t\t\t\t\terrorMessage = t(\n\t\t\t\t\t\t'Browser does not support readable streams'\n\t\t\t\t\t);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'AiAgent: Fetch failed':\n\t\t\t\t\terrorMessage = t(\n\t\t\t\t\t\t'We couldn\\'t connect to the AI. Please check your internet'\n\t\t\t\t\t);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\terrorMessage = t(\n\t\t\t\t\t\t'We couldn\\'t connect to the AI. Please check your internet'\n\t\t\t\t\t);\n\t\t\t}\n\n\t\t\taiAgentContext.showError( errorMessage );\n\t\t} finally {\n\t\t\tthis.editor.disableReadOnlyMode( this.aiAgentFeatureLockId );\n\t\t}\n\t}\n\n\t/**\n     * Creates and configures a cancel generation button with keyboard shortcut support.\n     *\n     * @param blockID - Unique identifier for the AI generation block\n     * @param controller - AbortController to cancel the ongoing AI generation\n     * @private\n     */\n\tprivate cancelGenerationButton( blockID: string, controller: AbortController ) {\n\t\tconst editor = this.editor;\n\t\tconst t = editor.t;\n\n\t\tconst view = new ButtonView();\n\t\tlet label = t( 'Cancel Generation' );\n\n\t\tif ( env.isMac ) {\n\t\t\tlabel = t( '\\u2318 + \\u232B Cancel Generation' );\n\t\t}\n\n\t\tif ( env.isWindows ) {\n\t\t\tlabel = t( 'Ctrl + \\u232B Cancel Generation' );\n\t\t}\n\n\t\tview.set( {\n\t\t\tlabel,\n\t\t\twithText: true,\n\t\t\tclass: 'ck-cancel-request-button'\n\t\t} );\n\n\t\tview.on( 'execute', () => {\n\t\t\tthis.abortGeneration = true;\n\t\t\tcontroller.abort();\n\t\t\tthis.processCompleted( blockID );\n\t\t} );\n\n\t\tview.render();\n\n\t\teditor.keystrokes.set( 'Ctrl+Backspace', ( keyEvtData, cancel ) => {\n\t\t\tif ( keyEvtData.ctrlKey || keyEvtData.metaKey ) {\n\t\t\t\tthis.abortGeneration = true;\n\t\t\t\tcontroller.abort();\n\t\t\t\tthis.processCompleted( blockID );\n\t\t\t}\n\t\t\tcancel();\n\t\t} );\n\n\t\tif ( editor.ui.view.element && view.element ) {\n\t\t\tconst panelContent = editor.ui.view.element.querySelector( '.ck-sticky-panel__content .ck-toolbar__items' );\n\t\t\tif ( panelContent ) {\n\t\t\t\tpanelContent.append( view.element );\n\t\t\t}\n\t\t}\n\n\t\tsetTimeout( () => view.set( { class: 'ck-cancel-request-button visible' } ), 2000 );\n\t}\n\n\t/**\n\t * Handles cleanup after AI generation is completed or cancelled.\n\t * Removes the cancel button from the UI and cleans up the temporary AI tag from editor content.\n\t *\n\t * @param blockID - Unique identifier for the AI generation block to be cleaned up\n\t * @private\n\t */\n\tprivate processCompleted( blockID: string ) {\n\t\tconst editor = this.editor;\n\n\t\tif ( editor.ui.view.element ) {\n\t\t\tconst cancelButton = editor.ui.view.element.querySelector( '.ck-cancel-request-button' );\n\t\t\tif ( cancelButton ) {\n\t\t\t\tcancelButton.remove();\n\t\t\t}\n\t\t}\n\n\t\tconst editorData = editor.getData();\n\t\tlet editorContent = editorData.replace( /<\\/ai-tag>\\s*<[^>]+>\\s*&nbsp;\\s*<\\/[^>]+>/g, '' );\n\t\teditorContent = editorContent.replace( `<ai-tag id=\"${ blockID }\">`, '' );\n\t\teditor.setData( editorContent );\n\t}\n\n\t/**\n\t * Recursively retrieves all child elements of a given view element that match the specified block ID.\n\t *\n\t * @param viewElement - The parent view element from which to retrieve children.\n\t * @param blockID - The unique identifier of the AI block to search for.\n\t * @returns An array of matching child elements.\n\t */\n\tprivate getViewChildrens( viewElement: any, blockID: string ): any {\n\t\tconst results = [];\n\t\tfor ( const child of viewElement.getChildren() ) {\n\t\t\tif ( child.is( 'element' ) ) {\n\t\t\t\tif ( child.is( 'element', 'ai-tag' ) && child.getAttribute( 'id' ) === blockID ) {\n\t\t\t\t\tresults.push( child );\n\t\t\t\t} else {\n\t\t\t\t\tconst nestedResults = this.getViewChildrens( child, blockID );\n\t\t\t\t\tresults.push( ...nestedResults );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn results;\n\t}\n\n\t/**\n\t * Updates the content of an AI-generated block in the editor.\n\t *\n\t * @param newHtml - The new HTML content to insert\n\t * @param blockID - The unique identifier of the AI block to update\n\t * @param insertParent - Whether to insert at parent level or child level\n\t * @returns Promise that resolves when the update is complete\n\t * @private\n\t */\n\tprivate async updateContent( newHtml: string, blockID: string ): Promise<void> {\n\t\tconst editor = this.editor;\n\t\teditor.model.change( writer => {\n\t\t\tconst root = editor.model.document.getRoot();\n\t\t\tif ( root ) {\n\t\t\t\tconst childrens = this.getViewChildrens( root, blockID );\n\t\t\t\tconst targetElement = childrens.length ? childrens[ 0 ] : null;\n\n\t\t\t\tif ( targetElement ) {\n\t\t\t\t\tconst range = editor.model.createRangeIn( targetElement );\n\t\t\t\t\twriter.remove( range );\n\n\t\t\t\t\tconst viewFragment = editor.data.processor.toView( newHtml );\n\t\t\t\t\tconst modelFragment = editor.data.toModel( viewFragment );\n\n\t\t\t\t\twriter.insert( modelFragment, targetElement, 'end' );\n\t\t\t\t}\n\t\t\t}\n\t\t} );\n\t\tawait new Promise( resolve => setTimeout( resolve ) );\n\t}\n\n\t/**\n\t * Processes the provided content and inserts it into the specified parent element.\n\t * Depending on the feature flag, it either uses a simple HTML insertion method\n\t * or processes the content as HTML.\n\t *\n\t * @param content - The content to be processed and inserted.\n\t * @param parent - The parent element in the editor where the content will be inserted.\n\t */\n\tprivate async processContent( content: string ): Promise<void> {\n\t\ttry {\n\t\t\tconsole.log( '--- Start of processContent ---' );\n\t\t\tconsole.log( 'Processing content:', content, this.isInlineInsertion );\n\t\t\tif ( this.isInlineInsertion ) {\n\t\t\t\tconst position = this.editor.model.document.selection.getLastPosition();\n\t\t\t\tconst tempParagraph: HTMLElement = document.createElement( 'div' );\n\t\t\t\ttempParagraph.innerHTML = content;\n\t\t\t\tawait this.htmlParser.insertAsText( tempParagraph || '', position ?? undefined, this.streamContent );\n\t\t\t} else {\n\t\t\t\tif ( this.streamContent ) {\n\t\t\t\t\t// Existing complex content processing logic\n\t\t\t\t\tawait this.proceedHtmlResponse( content );\n\t\t\t\t} else {\n\t\t\t\t\t// Use the simple HTML insertion method\n\t\t\t\t\tawait this.htmlParser.insertSimpleHtml( content );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconsole.log( '--- End of processContent ---' );\n\t\t} catch ( error ) {\n\t\t\tconsole.error( error );\n\t\t}\n\t}\n\n\t/**\n\t * Processes the provided HTML string and inserts its content into the editor.\n\t * It creates a temporary div to parse the HTML and handles different types of\n\t * elements (lists, tables, headings, etc.) accordingly.\n\t *\n\t * @param html - The HTML string to be processed and inserted into the editor.\n\t */\n\tprivate async proceedHtmlResponse( html: string ): Promise<void> {\n\t\tconst tempDiv: HTMLElement = document.createElement( 'div' );\n\t\ttempDiv.innerHTML = html;\n\n\t\tfor ( const child of Array.from( tempDiv.childNodes ) ) {\n\t\t\tconst element = child as HTMLElement;\n\t\t\tif ( element.nodeType === Node.ELEMENT_NODE ) {\n\t\t\t\tconst elementName = element.tagName.toLowerCase();\n\t\t\t\tconst isStreamingNotAllow = [\n\t\t\t\t\t'table', 'blockquote', 'pre', 'img', 'form', 'figure'\n\t\t\t\t].includes( elementName );\n\n\t\t\t\tif ( isStreamingNotAllow ) {\n\t\t\t\t\tawait this.htmlParser.insertSimpleHtml( element.outerHTML );\n\t\t\t\t}\n\t\t\t\telse if ( elementName === 'ul' || elementName === 'ol' ) {\n\t\t\t\t\tawait this.htmlParser.insertAsText( element, undefined, true, true );\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tawait this.htmlParser.insertAsText( element, undefined, true );\n\t\t\t\t}\n\t\t\t} else if ( element.nodeType === Node.TEXT_NODE && element.textContent ) {\n\t\t\t\tconst tempParagraph: HTMLElement = document.createElement( 'div' );\n\t\t\t\ttempParagraph.innerText = element.textContent;\n\t\t\t\tawait this.htmlParser.insertAsText( tempParagraph, undefined, true );\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Clears the content of the specified parent element in the editor.\n\t *\n\t * @param parent - The parent element whose content will be cleared.\n\t */\n\tprivate clearParentContent( parent: Element ): void {\n\t\tconst editor = this.editor;\n\t\tconst model = editor.model;\n\t\tconst root = model.document.getRoot();\n\t\tconst position = model.document.selection.getLastPosition();\n\t\tconst inlineSlash = Array.from( parent.getChildren() ).find( ( child: any ) => child.name === 'inline-slash' ) as Element;\n\n\t\tif ( root && position ) {\n\t\t\teditor.model.change( writer => {\n\t\t\t\tconst startingPath = inlineSlash?.getPath() || parent.getPath();\n\t\t\t\tconst range = model.createRange(\n\t\t\t\t\tmodel.createPositionFromPath( root, startingPath ),\n\t\t\t\t\tmodel.createPositionFromPath( root, position.path )\n\t\t\t\t);\n\t\t\t\twriter.remove( range );\n\t\t\t\t// writer.setSelection( model.createPositionFromPath( root, startingPath ) );\n\t\t\t} );\n\t\t}\n\t}\n\n\t/**\n\t * Generates a GPT prompt based on the user's input and the current context in the editor.\n\t * This method processes the input prompt, extracts any URLs, and formats the final prompt\n\t * to be sent to the GPT model. It also handles the case where the editor is empty.\n\t *\n\t * @param prompt - The user's input prompt, typically starting with a slash.\n\t * @param promptContainerText - Optional text from the container that may provide additional context.\n\t * @returns A promise that resolves to the generated GPT prompt string or null if an error occurs.\n\t*/\n\tprivate async generateGptPromptBasedOnUserPrompt(\n\t\tprompt: string,\n\t\tpromptContainerText?: string,\n\t\tselectedContent?: string\n\t): Promise<string | null> {\n\t\ttry {\n\t\t\tconst context = this.promptHelper.trimContext( prompt, promptContainerText );\n\t\t\tconst request = selectedContent ? prompt : prompt.slice( 1 ); // Remove the leading slash\n\t\t\tlet markDownContents: Array<MarkdownContent> = [];\n\t\t\tconst urlRegex = /https?:\\/\\/[^\\s/$.?#].[^\\s]*/g;\n\t\t\tconst urls = prompt.match( urlRegex );\n\t\t\tif ( Array.isArray( urls ) && urls.length ) {\n\t\t\t\tconst formattedUrl = urls.map( url => {\n\t\t\t\t\treturn url.replace( /[,.]$/, '' );\n\t\t\t\t} );\n\t\t\t\tmarkDownContents = await this.promptHelper.generateMarkDownForUrls( formattedUrl );\n\t\t\t\tmarkDownContents = this.promptHelper.allocateTokensToFetchedContent( prompt, markDownContents );\n\t\t\t}\n\n\t\t\tconst isEditorEmpty = context === '@@@cursor@@@';\n\t\t\treturn this.promptHelper.formatFinalPrompt(\n\t\t\t\trequest,\n\t\t\t\tcontext,\n\t\t\t\tmarkDownContents,\n\t\t\t\tisEditorEmpty,\n\t\t\t\tselectedContent\n\t\t\t);\n\t\t} catch ( error ) {\n\t\t\tconsole.error( error );\n\t\t\treturn null;\n\t\t}\n\t}\n}\n","import {\n\tMenuBarMenuView,\n\tMenuBarMenuListView,\n\tMenuBarMenuListItemView,\n\tMenuBarMenuListItemButtonView,\n\tcreateDropdown,\n\tSplitButtonView,\n\tLabeledFieldView,\n\tListSeparatorView,\n\tcreateLabeledInputText\n} from 'ckeditor5/src/ui.js';\nimport { Plugin, type Editor } from 'ckeditor5/src/core.js';\nimport aiAgentIcon from '../theme/icons/ai-agent.svg';\nimport searchIcon from '../theme/icons/search.svg';\nimport { aiAgentContext } from './aiagentcontext.js';\nimport { AI_AGENT_DROPDOWN_MENU, SUPPORTED_LANGUAGES, SHOW_ERROR_DURATION } from './const.js';\nimport { Widget, toWidget } from 'ckeditor5/src/widget.js';\nimport { env } from 'ckeditor5/src/utils.js';\nimport AiAgentService from './aiagentservice.js';\n\nexport default class AiAgentUI extends Plugin {\n\tpublic PLACEHOLDER_TEXT_ID = 'slash-placeholder';\n\tpublic GPT_RESPONSE_LOADER_ID = 'gpt-response-loader';\n\tpublic GPT_RESPONSE_ERROR_ID = 'gpt-error';\n\tprivate showErrorDuration: number = SHOW_ERROR_DURATION;\n\tprivate commandsDropdown = AI_AGENT_DROPDOWN_MENU;\n\n\tconstructor( editor: Editor ) {\n\t\tsuper( editor );\n\n\t\tconst config = editor.config.get( 'aiAgent' );\n\t\tthis.showErrorDuration = config?.showErrorDuration ?? SHOW_ERROR_DURATION;\n\t\tthis.commandsDropdown = config?.commandsDropdown ?? AI_AGENT_DROPDOWN_MENU;\n\t}\n\n\tpublic static get pluginName() {\n\t\treturn 'AiAgentUI' as const;\n\t}\n\n\tpublic static get requires() {\n\t\treturn [ Widget ] as const;\n\t}\n\n\t/**\n\t * Initializes the AI Agent UI plugin, setting up UI components and event listeners.\n\t * This method is called when the plugin is loaded.\n\t */\n\tpublic init(): void {\n\t\ttry {\n\t\t\taiAgentContext.uiComponent = this;\n\t\t\t// Initialize UI components like buttons, placeholders, loaders, etc.\n\t\t\tthis.initializeUIComponents();\n\n\t\t\t// Set displays content in the appropriate language.\n\t\t\tthis.initializeUILanguage();\n\n\t\t\t// Attach event listeners for handling editor events and user interactions\n\t\t\tthis.attachListener();\n\t\t} catch ( error: any ) {\n\t\t\tconsole.error( error.message );\n\t\t}\n\t}\n\n\t/**\n\t * Initializes UI components such as placeholders, loaders, and buttons for the editor.\n\t */\n\tprivate initializeUIComponents(): void {\n\t\tconst editor = this.editor;\n\t\tconst t = editor.t;\n\n\t\t// Register the inline-slash schema\n\t\teditor.model.schema.register( 'inline-slash', {\n\t\t\tinheritAllFrom: '$block',\n\t\t\tisInline: true,\n\t\t\tisObject: true,\n\t\t\tallowWhere: '$text',\n\t\t\tallowAttributes: [ 'class' ]\n\t\t} );\n\n\t\t// Allow the inline-slash element to have text inside it\n\t\teditor.model.schema.extend( '$text', {\n\t\t\tallowIn: 'inline-slash'\n\t\t} );\n\n\t\t// Set up upcast conversion for inline-slash\n\t\teditor.conversion.for( 'upcast' ).elementToElement( {\n\t\t\tview: {\n\t\t\t\tname: 'inline-slash',\n\t\t\t\tattributes: [ 'class' ]\n\t\t\t},\n\t\t\tmodel: ( viewElement, { writer } ) => {\n\t\t\t\treturn writer.createElement( 'inline-slash', {\n\t\t\t\t\tclass: viewElement.getAttribute( 'class' )\n\t\t\t\t} );\n\t\t\t},\n\t\t\tconverterPriority: 'high'\n\t\t} );\n\n\t\teditor.conversion.for( 'downcast' ).elementToElement( {\n\t\t\tmodel: {\n\t\t\t\tname: 'inline-slash',\n\t\t\t\tattributes: [ 'class' ]\n\t\t\t},\n\t\t\tview: ( modelElement, { writer } ) => {\n\t\t\t\treturn writer.createContainerElement( 'inline-slash', {\n\t\t\t\t\tclass: modelElement.getAttribute( 'class' )\n\t\t\t\t} );\n\t\t\t}\n\t\t} );\n\n\t\tthis.addPlaceholder();\n\t\tthis.addLoader();\n\t\tthis.addGptErrorToolTip();\n\t\tthis.addAiAgentButton();\n\n\t\teditor.accessibility.addKeystrokeInfos( {\n\t\t\tkeystrokes: [\n\t\t\t\t{\n\t\t\t\t\tlabel: t( 'Insert slash command (AI Agent)' ),\n\t\t\t\t\tkeystroke: '/'\n\t\t\t\t}\n\t\t\t]\n\t\t} );\n\n\t\teditor.model.schema.register( 'ai-tag', {\n\t\t\tinheritAllFrom: '$block',\n\t\t\tisInline: true,\n\t\t\tisObject: true,\n\t\t\tallowWhere: '$block',\n\t\t\tallowAttributes: [ 'id' ]\n\t\t} );\n\n\t\teditor.model.schema.extend( '$block', { allowIn: 'ai-tag' } );\n\n\t\tthis.addCustomTagConversions();\n\t\tlet keystroke = '';\n\t\tif ( env.isMac ) {\n\t\t\tkeystroke = 'Cmd + Backspace';\n\t\t}\n\n\t\tif ( env.isWindows ) {\n\t\t\tkeystroke = 'Ctrl + Backspace';\n\t\t}\n\t\teditor.accessibility.addKeystrokeInfos( {\n\t\t\tkeystrokes: [\n\t\t\t\t{\n\t\t\t\t\tlabel: t( 'Cancel AI Generation' ),\n\t\t\t\t\tkeystroke\n\t\t\t\t}\n\t\t\t]\n\t\t} );\n\t}\n\n\tprivate addCustomTagConversions(): void {\n\t\tconst editor = this.editor;\n\n\t\teditor.conversion.for( 'upcast' ).elementToElement( {\n\t\t\tview: {\n\t\t\t\tname: 'ai-tag',\n\t\t\t\tattributes: [ 'id' ]\n\t\t\t},\n\t\t\tmodel: ( viewElement, { writer } ) => {\n\t\t\t\treturn writer.createElement( 'ai-tag', {\n\t\t\t\t\tid: viewElement.getAttribute( 'id' )\n\t\t\t\t} );\n\t\t\t}\n\t\t} );\n\n\t\teditor.conversion.for( 'dataDowncast' ).elementToElement( {\n\t\t\tmodel: 'ai-tag',\n\t\t\tview: ( modelElement, { writer } ) => {\n\t\t\t\treturn writer.createContainerElement( 'ai-tag', {\n\t\t\t\t\tid: modelElement.getAttribute( 'id' )\n\t\t\t\t} );\n\t\t\t}\n\t\t} );\n\n\t\teditor.conversion.for( 'editingDowncast' ).elementToElement( {\n\t\t\tmodel: 'ai-tag',\n\t\t\tview: ( modelElement, { writer } ) => {\n\t\t\t\tconst customTag = writer.createContainerElement( 'ai-tag', {\n\t\t\t\t\tid: modelElement.getAttribute( 'id' )\n\t\t\t\t} );\n\n\t\t\t\treturn toWidget( customTag, writer );\n\t\t\t}\n\t\t} );\n\t}\n\n\t/**\n\t * Adds the AI Agent button to the editor's UI, which includes a dropdown menu\n\t * for various AI commands. The button allows users to insert slash commands\n\t * and provides a search functionality for available commands.\n\t *\n\t * This method sets up the button's execute event, handles user input for\n\t * searching commands, and organizes the command menu into groups for better\n\t * usability.\n\t */\n\tprivate addAiAgentButton(): void {\n\t\tconst t = this.editor.t;\n\t\tconst model = this.editor.model;\n\t\tconst viewDocument = this.editor.editing.view.document;\n\n\t\tthis.editor.ui.componentFactory.add( 'aiAgentButton', locale => {\n\t\t\tconst dropdownView = createDropdown( locale, SplitButtonView );\n\t\t\tdropdownView.class = 'ck-ai-commands-list';\n\t\t\tconst buttonView = dropdownView.buttonView;\n\t\t\tbuttonView.set( {\n\t\t\t\tlabel: t( 'AI Agent' ),\n\t\t\t\ticon: aiAgentIcon,\n\t\t\t\ttooltip: true\n\t\t\t} );\n\n\t\t\t// Add the functionality for the dropdown button's execute event\n\t\t\tbuttonView.on( 'execute', () => {\n\t\t\t\tthis.editor.model.change( writer => {\n\t\t\t\t\tconst position = this.editor.model.document.selection.getLastPosition();\n\t\t\t\t\tif ( position ) {\n\t\t\t\t\t\tconst inlineSlashContainer = writer.createElement( 'inline-slash', { class: 'ck-slash' } );\n\t\t\t\t\t\twriter.insertText( '/', inlineSlashContainer );\n\t\t\t\t\t\twriter.insert( inlineSlashContainer, position );\n\t\t\t\t\t\tconst newPosition = writer.createPositionAt( inlineSlashContainer, 'end' );\n\t\t\t\t\t\twriter.setSelection( newPosition );\n\t\t\t\t\t}\n\t\t\t\t} );\n\t\t\t\tthis.editor.editing.view.focus();\n\t\t\t} );\n\t\t\tconst menuView = new MenuBarMenuView( locale );\n\t\t\tconst listView = new MenuBarMenuListView( locale );\n\t\t\tconst searchContainer = new MenuBarMenuListItemView( locale, menuView );\n\n\t\t\tconst labeledFieldView = new LabeledFieldView( locale, createLabeledInputText );\n\t\t\tlabeledFieldView.label = t( 'Search AI command' );\n\n\t\t\t// Create a wrapper div for the icon and input\n\t\t\tconst wrapper = document.createElement( 'div' );\n\t\t\twrapper.className = 'ck-input-icon-wrapper';\n\n\t\t\t// Create and add the icon\n\t\t\tconst iconSpan = document.createElement( 'span' );\n\t\t\ticonSpan.className = 'ck-input-search-icon';\n\t\t\ticonSpan.innerHTML = searchIcon;\n\t\t\twrapper.appendChild( iconSpan );\n\n\t\t\tlabeledFieldView.fieldView.on( 'input', () => {\n\t\t\t\tif ( labeledFieldView?.fieldView?.element ) {\n\t\t\t\t\tconst search = labeledFieldView.fieldView.element.value.toLowerCase();\n\t\t\t\t\tthis.aiAgentListItemUpdate( listView, 'search', search );\n\t\t\t\t}\n\t\t\t} );\n\t\t\t// Listen for selection changes in the editor\n\t\t\tviewDocument.on( 'selectionChange', () => {\n\t\t\t\tconst selection = model.document.selection;\n\t\t\t\tconst range = selection.getFirstRange();\n\t\t\t\tif ( range ) {\n\t\t\t\t\tconst selectedText = Array.from( range.getItems() )\n\t\t\t\t\t\t.map( item => ( item as any ).data )\n\t\t\t\t\t\t.join( '' );\n\n\t\t\t\t\tconst isTextSelected = !!selectedText;\n\t\t\t\t\tthis.aiAgentListItemUpdate( listView, 'enable', isTextSelected );\n\t\t\t\t}\n\t\t\t} );\n\n\t\t\tsearchContainer.children.add( labeledFieldView );\n\t\t\tlistView.items.add( searchContainer );\n\n\t\t\tif ( labeledFieldView.element ) {\n\t\t\t\tlabeledFieldView.element.appendChild( wrapper );\n\t\t\t}\n\n\t\t\tfor ( const group of this.commandsDropdown ) {\n\t\t\t\tconst separatorView = new ListSeparatorView( locale );\n\t\t\t\tlistView.items.add( separatorView );\n\t\t\t\t// Add group title if needed\n\t\t\t\tconst titleView = new MenuBarMenuListItemView( locale, menuView );\n\t\t\t\tconst titleButton = new MenuBarMenuListItemButtonView( locale );\n\t\t\t\ttitleButton.set( {\n\t\t\t\t\tlabel: t( group.title ),\n\t\t\t\t\tclass: 'ck-menu-group-title',\n\t\t\t\t\tisEnabled: false\n\t\t\t\t} );\n\t\t\t\ttitleView.children.add( titleButton );\n\t\t\t\tlistView.items.add( titleView );\n\t\t\t\t// Add group items\n\t\t\t\tfor ( const item of group.items ) {\n\t\t\t\t\tconst listItemView = new MenuBarMenuListItemView( locale, menuView );\n\t\t\t\t\tconst buttonView = new MenuBarMenuListItemButtonView( locale );\n\t\t\t\t\tbuttonView.set( {\n\t\t\t\t\t\tlabel: t( item.title ),\n\t\t\t\t\t\tclass: 'ck-menu-item',\n\t\t\t\t\t\tisEnabled: false\n\t\t\t\t\t} );\n\t\t\t\t\tbuttonView.delegate( 'execute' ).to( menuView );\n\t\t\t\t\tbuttonView.on( 'execute', () => {\n\t\t\t\t\t\tconst aiAgentService = new AiAgentService( this.editor );\n\t\t\t\t\t\tthis.editor.editing.view.focus();\n\t\t\t\t\t\taiAgentService.handleSlashCommand( item.command );\n\t\t\t\t\t} );\n\t\t\t\t\tlistItemView.children.add( buttonView );\n\t\t\t\t\tlistView.items.add( listItemView );\n\t\t\t\t}\n\t\t\t}\n\t\t\tdropdownView.panelView.children.add( listView );\n\t\t\treturn dropdownView;\n\t\t} );\n\t}\n\n\t/**\n\t * Updates the enabled state of items in the AI Agent command list based on the provided type and data.\n\t *\n\t * This method iterates through the list of items in the provided listView and enables or disables them\n\t * based on the search input or selection state. It checks if the item is a title, separator, or search input\n\t * and updates the isEnabled property accordingly.\n\t *\n\t * @param listView - The MenuBarMenuListView containing the items to update.\n\t * @param type - The type of update to perform, either 'search' to filter items based on input or 'enable'\n\t *               to enable/disable items based on selection state.\n\t * @param data - The search string for filtering items when type is 'search', or a boolean indicating\n\t *               whether to enable or disable items when type is 'enable'.\n\t */\n\tprivate aiAgentListItemUpdate( listView: MenuBarMenuListView, type: 'search' | 'enable', data: string | boolean ) {\n\t\tlistView.items.map( itemView => {\n\t\t\tconst element = itemView as any;\n\t\t\tif ( element.children?.first ) {\n\t\t\t\tconst button = element.children.first;\n\t\t\t\tif ( button.class ) {\n\t\t\t\t\tconst isTitle = button.class.includes( 'ck-menu-group-title' );\n\t\t\t\t\tconst isSearchInout = button.class.includes( 'ck-ai-search-input' );\n\t\t\t\t\tconst isSeparator = !button.label;\n\t\t\t\t\tif ( !isTitle && !isSeparator && !isSearchInout ) {\n\t\t\t\t\t\tconst label = button.label.toLowerCase();\n\t\t\t\t\t\tif ( type === 'search' ) {\n\t\t\t\t\t\t\telement.isVisible = !data || label.includes( data );\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ( type === 'enable' ) {\n\t\t\t\t\t\t\telement.isEnabled = data;\n\t\t\t\t\t\t\tbutton.isEnabled = data;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} );\n\t}\n\n\t/**\n\t * Initializes the UI language settings based on the editor's locale.\n\t * Displays an error tooltip if the current language is unsupported.\n\t */\n\tprivate initializeUILanguage(): void {\n\t\tconst editor = this.editor;\n\t\tconst t = editor.t;\n\t\tconst contentLanguageCode = editor.locale.contentLanguage;\n\t\tconst supportedLanguages = SUPPORTED_LANGUAGES;\n\t\tif ( !supportedLanguages.includes( contentLanguageCode ) ) {\n\t\t\tthis.showGptErrorToolTip( t( 'Unsupported language code' ) );\n\t\t}\n\t}\n\n\t/**\n\t * Attaches event listeners to the editor for handling user interactions and content changes.\n\t */\n\tprivate attachListener(): void {\n\t\tconst editor = this.editor;\n\t\tconst model = editor.model;\n\n\t\tmodel.document.on( 'change:data', () => {\n\t\t\tsetTimeout( () => {\n\t\t\t\tthis.applyPlaceholderToCurrentLine();\n\t\t\t}, 10 );\n\t\t} );\n\n\t\tmodel.document.selection.on( 'change:range', () => {\n\t\t\tsetTimeout( () => {\n\t\t\t\tthis.applyPlaceholderToCurrentLine();\n\t\t\t}, 10 );\n\t\t\tconst modelRoot = editor.model.document.getRoot();\n\t\t\tif ( modelRoot ) {\n\t\t\t\tconst modelRange = editor.model.createRangeIn( modelRoot );\n\t\t\t\tconst itemsToRemove: Array<any> = [];\n\t\t\t\tfor ( const item of modelRange.getItems() ) {\n\t\t\t\t\tif ( item.is( 'element', 'inline-slash' ) && item.isEmpty ) {\n\t\t\t\t\t\titemsToRemove.push( item ); // Collect empty items\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Remove collected empty inline-slash elements\n\t\t\t\teditor.model.change( writer => {\n\t\t\t\t\tfor ( const item of itemsToRemove ) {\n\t\t\t\t\t\twriter.remove( item );\n\t\t\t\t\t}\n\t\t\t\t} );\n\t\t\t}\n\t\t} );\n\n\t\teditor.editing.view.document.on( 'scroll', () => {\n\t\t\tthis.hidePlaceHolder();\n\t\t} );\n\n\t\tdocument.addEventListener( 'scroll', () => {\n\t\t\tthis.hidePlaceHolder();\n\t\t} );\n\t}\n\n\t/**\n\t * Applies the placeholder to the current line in the editor if it is empty.\n\t * Hides the placeholder if the line is not empty.\n\t */\n\tpublic applyPlaceholderToCurrentLine(): void {\n\t\tconst editor = this.editor;\n\t\tconst model = editor.model;\n\t\tconst modelSelection = model.document.selection;\n\n\t\tconst block = modelSelection.getFirstPosition()?.parent;\n\t\tif ( block && block.isEmpty ) {\n\t\t\tthis.hidePlaceHolder();\n\n\t\t\tsetTimeout( async () => {\n\t\t\t\tif ( block.is( 'element' ) ) {\n\t\t\t\t\tconst rect = await this.getRectDomOfGivenModelElement(\n\t\t\t\t\t\tblock\n\t\t\t\t\t);\n\t\t\t\t\tif ( rect ) {\n\t\t\t\t\t\tthis.showPlaceHolder( rect );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}, 100 );\n\t\t} else {\n\t\t\tthis.hidePlaceHolder();\n\t\t}\n\t}\n\n\t/**\n\t * Retrieves the DOM rectangle of a given model element.\n\t *\n\t * @param element - The model element for which to get the DOM rectangle.\n\t * @returns A promise that resolves to the DOMRect of the element, or null if not found.\n\t */\n\tprivate async getRectDomOfGivenModelElement(\n\t\telement: any\n\t): Promise<DOMRect | null | undefined> {\n\t\tconst editor = this.editor;\n\t\tconst mapper = editor.editing.mapper;\n\t\tconst view = editor.editing.view;\n\n\t\tconst equivalentView = mapper.toViewElement( element );\n\n\t\tif ( equivalentView ) {\n\t\t\tconst domElement = view.domConverter.mapViewToDom( equivalentView );\n\t\t\tif ( domElement ) {\n\t\t\t\treturn domElement.getBoundingClientRect();\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Adds a placeholder element to the document body for user interaction.\n\t */\n\tprivate addPlaceholder(): void {\n\t\tconst editor = this.editor;\n\t\tconst t = editor.t;\n\t\tconst placeholder = document.createElement( 'p' );\n\t\tplaceholder.id = this.PLACEHOLDER_TEXT_ID;\n\t\tplaceholder.onclick = () => {\n\t\t\teditor.focus();\n\t\t};\n\t\tplaceholder.classList.add( 'place-holder' );\n\t\tplaceholder.textContent = t( 'Type / to request AI content' );\n\t\tsetTimeout( async () => {\n\t\t\tconst panelContent = editor.ui.view.element;\n\t\t\tif ( panelContent ) {\n\t\t\t\tpanelContent.append( placeholder );\n\t\t\t}\n\t\t} );\n\t}\n\n\t/**\n\t * Shows the placeholder at the specified position.\n\t *\n\t * @param rect - The DOMRect object defining the position to show the placeholder.\n\t */\n\tprivate showPlaceHolder( rect?: DOMRect ): void {\n\t\tconst editor = this.editor;\n\t\tconst ele = editor.ui.view.element?.querySelector( `#${ this.PLACEHOLDER_TEXT_ID }` ) as HTMLElement;\n\t\tconst isReadOnlyMode = this.editor.isReadOnly;\n\t\tif ( ele && rect && !isReadOnlyMode ) {\n\t\t\tele.classList.add( 'show-place-holder' );\n\t\t\tele.style.left = `${ rect.left }px`;\n\t\t\tele.style.top = `${ rect.top }px`;\n\t\t} else if ( ele ) {\n\t\t\tele.classList.remove( 'show-place-holder' );\n\t\t}\n\t}\n\n\t/**\n\t * Hides the placeholder element from the document.\n\t */\n\tprivate hidePlaceHolder(): void {\n\t\tconst editor = this.editor;\n\t\tconst ele = editor.ui.view.element?.querySelector( `#${ this.PLACEHOLDER_TEXT_ID }` );\n\t\tif ( ele ) {\n\t\t\tele.classList.remove( 'show-place-holder' );\n\t\t}\n\t}\n\n\t/**\n\t * Adds a loader element to the document body for indicating processing.\n\t */\n\tprivate addLoader(): void {\n\t\tconst loaderElement = document.createElement( 'div' );\n\t\tloaderElement.id = this.GPT_RESPONSE_LOADER_ID;\n\t\tloaderElement.classList.add( 'gpt-loader' );\n\t\tdocument.body.appendChild( loaderElement );\n\t}\n\n\t/**\n\t * Shows the loader at the specified position.\n\t *\n\t * @param rect - The DOMRect object defining the position to show the loader.\n\t */\n\tpublic showLoader( rect?: DOMRect ): void {\n\t\tconst ele = document.getElementById( this.GPT_RESPONSE_LOADER_ID );\n\t\tif ( ele && rect ) {\n\t\t\tele.style.left = `${ rect.left + 10 }px`;\n\t\t\tele.style.top = `${ rect.top + 10 }px`;\n\t\t\tele.classList.add( 'show-gpt-loader' );\n\t\t} else if ( ele ) {\n\t\t\tele.classList.remove( 'show-gpt-loader' );\n\t\t}\n\t}\n\n\t/**\n\t * Hides the loader element from the document.\n\t */\n\tpublic hideLoader(): void {\n\t\tconst ele = document.getElementById( this.GPT_RESPONSE_LOADER_ID );\n\t\tif ( ele ) {\n\t\t\tele.classList.remove( 'show-gpt-loader' );\n\t\t}\n\t}\n\n\t/**\n\t * Adds an error tooltip element to the document body for displaying error messages.\n\t */\n\tprivate addGptErrorToolTip(): void {\n\t\tconst tooltipElement = document.createElement( 'p' );\n\t\ttooltipElement.id = this.GPT_RESPONSE_ERROR_ID;\n\t\ttooltipElement.classList.add( 'response-error' );\n\t\tdocument.body.appendChild( tooltipElement );\n\t}\n\n\t/**\n\t * Displays an error tooltip with the specified message.\n\t *\n\t * @param message - The error message to display in the tooltip.\n\t */\n\tpublic showGptErrorToolTip( message: string ): void {\n\t\tconsole.log( 'Showing error message...', message );\n\t\tconst editor = this.editor;\n\t\tconst view = editor?.editing?.view?.domRoots?.get( 'main' );\n\t\tconst tooltipElement = document.getElementById(\n\t\t\tthis.GPT_RESPONSE_ERROR_ID\n\t\t);\n\n\t\tconst editorRect = view?.getBoundingClientRect();\n\t\tif ( tooltipElement && editorRect ) {\n\t\t\ttooltipElement.classList.add( 'show-response-error' );\n\t\t\ttooltipElement.textContent = message;\n\t\t\tsetTimeout( () => {\n\t\t\t\tthis.hideGptErrorToolTip();\n\t\t\t}, this.showErrorDuration );\n\t\t}\n\t}\n\n\t/**\n\t * Hides the error tooltip element from the document.\n\t */\n\tprivate hideGptErrorToolTip(): void {\n\t\tconst tooltipElement = document.getElementById(\n\t\t\tthis.GPT_RESPONSE_ERROR_ID\n\t\t);\n\t\tif ( tooltipElement ) {\n\t\t\ttooltipElement.classList.remove( 'show-response-error' );\n\t\t}\n\t}\n}\n","import { Command } from 'ckeditor5/src/core.js';\nimport type AiAgentService from './aiagentservice.js';\nimport type { Editor } from 'ckeditor5';\nexport default class AiAgentCommand extends Command {\n\tprivate aiAgentService: AiAgentService;\n\n\t/**\n\t * Creates an instance of the AiAgentCommand.\n\t *\n\t * @param editor - The editor instance to which this command belongs.\n\t * @param aiAgentService - The service instance that handles AI assist functionality.\n\t */\n\tconstructor( editor: Editor, aiAgentService: AiAgentService ) {\n\t\tsuper( editor );\n\t\tthis.aiAgentService = aiAgentService;\n\t}\n\n\t/**\n\t * Checks whether the command can be executed based on the current selection.\n\t *\n\t * @returns A boolean indicating if the command can be executed.\n\t */\n\tpublic override refresh(): void {\n\t\t// Enable the command when the selection is in an empty block or at the beginning of a block\n\t\tthis.isEnabled = true;\n\t}\n\n\t/**\n\t * Executes the AI assist command, processing the user's input and interacting with the AI service.\n\t *\n\t * @param options - An optional parameter for additional execution options.\n\t */\n\tpublic override async execute(): Promise<void> {\n\t\tawait this.aiAgentService.handleSlashCommand();\n\t}\n}\n","import { Plugin } from 'ckeditor5/src/core.js';\nimport AiAgentCommand from './aiagentcommand.js';\nimport type { Element } from 'ckeditor5';\nimport AiAgentService from './aiagentservice.js';\n\nexport default class AiAgentEditing extends Plugin {\n\tpublic static get pluginName() {\n\t\treturn 'AiAgentEditing' as const;\n\t}\n\n\t/**\n\t * Initializes the AI Agent editing plugin, setting up commands and key handling.\n\t */\n\tpublic init(): void {\n\t\tconst editor = this.editor;\n\t\tconst aiAgentService = new AiAgentService( editor );\n\t\teditor.commands.add(\n\t\t\t'aiAgent',\n\t\t\tnew AiAgentCommand( editor, aiAgentService )\n\t\t);\n\n\t\tthis.setupEnterKeyHandling();\n\t}\n\n\t/**\n\t * Sets up handling for the Enter key to trigger AI assist functionality.\n\t * If the content starts with a slash, it cancels the default action and executes the AI assist command.\n\t */\n\tprivate setupEnterKeyHandling(): void {\n\t\tconst editor = this.editor;\n\t\tconst model = editor.model;\n\t\tconst mapper = editor.editing.mapper;\n\t\tconst view = editor.editing.view;\n\n\t\teditor.keystrokes.set( 'enter', async ( _, cancel ) => {\n\t\t\tconst position = model.document.selection.getFirstPosition();\n\t\t\tif ( position ) {\n\t\t\t\tconst paragraph = position.parent as Element;\n\t\t\t\tconst inlineSlash = Array.from( paragraph.getChildren() ).find( ( child: any ) => child.name === 'inline-slash' );\n\t\t\t\tconst equivalentView = mapper.toViewElement( paragraph );\n\t\t\t\tlet content;\n\t\t\t\tif ( equivalentView ) {\n\t\t\t\t\tcontent =\n\t\t\t\t\t\tview.domConverter.mapViewToDom(\n\t\t\t\t\t\t\tequivalentView\n\t\t\t\t\t\t)?.innerText;\n\t\t\t\t}\n\t\t\t\tif ( ( typeof content === 'string' && content.startsWith( '/' ) ) || inlineSlash ) {\n\t\t\t\t\tcancel();\n\t\t\t\t\tawait editor.execute( 'aiAgent' );\n\t\t\t\t}\n\t\t\t}\n\t\t} );\n\t}\n}\n","import { Plugin } from 'ckeditor5/src/core.js';\nimport AiAgentUI from './aiagentui.js';\nimport AiAgentEditing from './aiagentediting.js';\nimport type { Editor } from 'ckeditor5';\nimport type { AiModel, AiAgentConfig } from './type-identifiers.js';\nimport { TOKEN_LIMITS } from './const.js';\nimport '../theme/style.css';\nexport default class AiAgent extends Plugin {\n\tpublic DEFAULT_GPT_MODEL = 'gpt-4o' as AiModel;\n\tpublic DEFAULT_AI_END_POINT = 'https://api.openai.com/v1/chat/completions';\n\n\tconstructor( editor: Editor ) {\n\t\tsuper( editor );\n\n\t\tconst config = editor.config.get( 'aiAgent' ) || {};\n\t\t// Set default values and merge with provided config\n\t\tconst defaultConfig = {\n\t\t\tmodel: this.DEFAULT_GPT_MODEL, // Default AI model\n\t\t\tapiKey: '', // Default OpenAI key\n\t\t\tendpointUrl: this.DEFAULT_AI_END_POINT, // Default endpoint URL\n\t\t\ttemperature: undefined, // Default temperature\n\t\t\ttimeOutDuration: 45000, // Default timeout duration\n\t\t\tmaxOutputTokens: TOKEN_LIMITS[ this.DEFAULT_GPT_MODEL ].maxOutputTokens,\n\t\t\tmaxInputTokens: TOKEN_LIMITS[ this.DEFAULT_GPT_MODEL ].maxInputContextTokens,\n\t\t\tretryAttempts: 1, // Default retry attempts\n\t\t\tcontextSize: TOKEN_LIMITS[ this.DEFAULT_GPT_MODEL ].maxInputContextTokens * 0.75, // Default context size\n\t\t\tstopSequences: [], // Default stop sequences\n\t\t\tpromptSettings: {},\n\t\t\tdebugMode: false, // Default debug mode\n\t\t\tstreamContent: true // Default streaming mode\n\t\t};\n\n\t\tconst updatedConfig = { ...defaultConfig, ...config };\n\n\t\t// Set the merged config back to the editor\n\t\teditor.config.set( 'aiAgent', updatedConfig );\n\n\t\t// Validate configuration\n\t\tthis.validateConfiguration( updatedConfig );\n\t}\n\n\tpublic static get requires() {\n\t\treturn [ AiAgentUI, AiAgentEditing ] as const;\n\t}\n\n\tpublic static get pluginName() {\n\t\treturn 'AiAgent' as const;\n\t}\n\n\tprivate validateConfiguration( config: AiAgentConfig ): void {\n\t\tif ( !config.apiKey ) {\n\t\t\tthrow new Error( 'AiAgent: apiKey is required.' );\n\t\t}\n\n\t\tif ( config.temperature && ( config.temperature < 0 || config.temperature > 2 ) ) {\n\t\t\tthrow new Error( 'AiAgent: Temperature must be a number between 0 and 2.' );\n\t\t}\n\n\t\tconst limits = TOKEN_LIMITS[ config.model as AiModel ];\n\n\t\t// Validate output tokens\n\t\tif ( config.maxOutputTokens !== undefined ) {\n\t\t\tif ( config.maxOutputTokens < limits.minOutputTokens ||\n\t\t\t\tconfig.maxOutputTokens > limits.maxOutputTokens ) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`AiAgent: maxOutputTokens must be between ${ limits.minOutputTokens } ` +\n\t\t\t\t\t`and ${ limits.maxOutputTokens } for ${ config.model }`\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Validate input tokens\n\t\tif ( config.maxInputTokens !== undefined &&\n\t\t\tconfig.maxInputTokens > limits.maxInputContextTokens ) {\n\t\t\tthrow new Error(\n\t\t\t\t`AiAgent: maxInputTokens cannot exceed ${ limits.maxInputContextTokens } ` +\n\t\t\t\t`for ${ config.model }`\n\t\t\t);\n\t\t}\n\t}\n\n\tpublic init(): void {\n\t\t// Any additional initialization if needed\n\t}\n}\n","import ckeditor from './../theme/icons/ckeditor.svg';\nimport './augmentation.js';\n\nexport { default as AiAgent } from './aiagent.js';\n\nexport const icons = {\n\tckeditor\n};\n"],"names":["AiAgentContext","static","_uiComponent","constructor","getInstance","instance","uiComponent","component","this","showError","message","console","log","showGptErrorToolTip","showLoader","rect","hideLoader","aiAgentContext","TOKEN_LIMITS","minOutputTokens","maxOutputTokens","maxInputContextTokens","SUPPORTED_LANGUAGES","ALL_MODERATION_FLAGS","AI_AGENT_DROPDOWN_MENU","title","items","command","nodeToHtmlMap","blockQuote","caption","codeBlock","heading1","heading2","heading3","imageBlock","imageInline","paragraph","table","tableCell","tableRow","$listItem","horizontalLine","textAttributeToHtmlMap","bold","italic","code","strikethrough","subscript","superscript","underline","linkHref","getAllowedHtmlTags","editor","definitions","model","schema","getDefinitions","schemaNodes","Object","keys","sort","allowedTags","Set","forEach","node","add","textDefinition","$text","allowAttributes","attr","has","Array","from","abbreviations","stringHelper","word","c","length","indexOf","slice","end","englishAbbreviations","Match","setAbbreviations","abbr","isCapitalized","str","test","isNumber","isSentenceStarter","substring","isCommonAbbreviation","noSymbols","replace","isTimeAbbreviation","next","toLowerCase","isDottedAbbreviation","matches","match","isCustomAbbreviation","isNameAbbreviation","wordCount","words","filter","charAt","dotPos","isNaN","isPhoneNr","isURL","isConcatenated","i","isBoundaryChar","sanitizeHtml","text","opts","String","document","$div","createElement","innerHTML","textContent","trim","require$$1","require$$2","newline_placeholder","newline_placeholder_t","whiteSpaceCheck","RegExp","addNewLineBoundaries","splitIntoWords","trimMultilineString","split","map","line","join","extractEditorContent","contentAfterPrompt","contextSize","reverse","trimmedContent","charCount","options","preserve_whitespace","html_boundaries","allowed_tags","sentences","sbd","iterator","sentence","sentenceLength","countTokens","content","tokens","approxTokenCount","token","Math","ceil","trimLLMContentByTokens","maxTokens","elements","accumulatedTokens","element","elementTokenCount","async","fetchUrlContent","url","trimmedUrl","Error","requestURL","response","fetch","headers","ok","status","includes","error","tokenizer","user_options","newline_boundaries","html_boundaries_tags","sanitize","k","html_boundaries_regexp","re","index","temp","current","ii","L","push","endsWithChar","pop","endsWith","s","reduce","out","lastSentence","concat","tokenCount","splice","PromptHelper","promptSettings","debugMode","editorContextRatio","config","get","getSystemPrompt","isInlineResponse","defaultComponents","responseRules","htmlFormatting","contentStructure","tone","inlineContent","imageHandling","systemPrompt","id","defaultContent","entries","componentId","overrides","additions","group","groupEnd","trimContext","prompt","promptContainerText","contentBeforePrompt","splitText","view","editing","domRoots","context","innerText","matchIndex","nextEnterIndex","firstNewlineIndex","contextParts","allocatedEditorContextToken","floor","escapedPrompt","formatFinalPrompt","request","markDownContents","isEditorEmpty","selectedContent","contentLanguageCode","locale","contentLanguage","corpus","trimStart","removeLeadingSpaces","generateMarkDownForUrls","urls","markdownContents","allocateTokensToFetchedContent","fetchedContent","editorContent","editorToken","min","availableLimit","tokensPerContent","HtmlParser","insertSimpleHtml","html","viewFragment","data","processor","toView","modelFragment","toModel","selection","root","getRoot","insertionPosition","getLastPosition","lastInsertedChild","getChild","childCount","currentChildIndex","path","lastUpdatedElementInRoot","change","writer","is","isEmpty","createPositionAt","createPositionAfter","setSelection","insertContent","isBreakElementReq","getAttribute","name","insert","Promise","resolve","setTimeout","insertAsText","position","stream","shouldAddBreakAtEnd","outerHTML","childrenToInsert","getChildren","insertPosition","undefined","insertElementAsStream","batchInsertOfElement","lastPosition","getFirstPosition","lastRecognizedPosition","targetElement","currentElement","parent","lastUpdatedElement","key","value","getAttributes","_setAttribute","textChildren","child","textNode","textAttributes","_data","char","currentPosition","shouldAppendAtEnd","getShiftedBy","offset","maxOffset","insertText","isCompleteHtmlChunk","trimmedHtml","startsWith","AiAgentService","aiModel","apiKey","endpointUrl","temperature","timeOutDuration","retryAttempts","streamContent","stopSequences","aiAgentFeatureLockId","Symbol","promptHelper","htmlParser","buffer","openTags","isInlineInsertion","abortGeneration","moderationKey","moderationEnable","disableFlags","moderation","enable","handleSlashCommand","mapper","parentEquivalentHTML","inlineSlash","equivalentView","toViewElement","domConverter","mapViewToDom","endPosition","startPosition","range","createRange","item","getItems","getFirstRange","moderateContent","domSelection","window","getSelection","domRange","getRangeAt","getBoundingClientRect","gptPrompt","generateGptPromptBasedOnUserPrompt","fetchAndProcessGptResponse","input","t","controller","AbortController","timeoutId","abort","method","Authorization","body","JSON","stringify","signal","clearTimeout","json","results","flags","flag","flagged","categories","TypeError","DOMException","retries","contentBuffer","blockID","Date","getTime","messages","role","max_tokens","stop","reader","getReader","decoder","TextDecoder","clearParentContent","insertParent","cancelGenerationButton","aiTag","parentContent","nextLinePosition","newPosition","done","read","newlineIndex","decode","jsonStr","parse","choices","delta","updateContent","parseError","warn","processCompleted","errorIdentifier","isRetryableError","errorMessage","disableReadOnlyMode","ButtonView","label","env","isMac","isWindows","set","withText","class","on","render","keystrokes","keyEvtData","cancel","ctrlKey","metaKey","ui","panelContent","querySelector","append","cancelButton","remove","getData","setData","getViewChildrens","viewElement","nestedResults","newHtml","childrens","createRangeIn","processContent","tempParagraph","proceedHtmlResponse","tempDiv","childNodes","nodeType","Node","ELEMENT_NODE","elementName","tagName","TEXT_NODE","find","startingPath","getPath","createPositionFromPath","urlRegex","isArray","formattedUrl","AiAgentUI","Plugin","PLACEHOLDER_TEXT_ID","GPT_RESPONSE_LOADER_ID","GPT_RESPONSE_ERROR_ID","showErrorDuration","commandsDropdown","super","pluginName","requires","Widget","init","initializeUIComponents","initializeUILanguage","attachListener","register","inheritAllFrom","isInline","isObject","allowWhere","extend","allowIn","conversion","for","elementToElement","attributes","converterPriority","modelElement","createContainerElement","addPlaceholder","addLoader","addGptErrorToolTip","addAiAgentButton","accessibility","addKeystrokeInfos","keystroke","addCustomTagConversions","customTag","toWidget","viewDocument","componentFactory","dropdownView","createDropdown","SplitButtonView","buttonView","icon","tooltip","inlineSlashContainer","focus","menuView","MenuBarMenuView","listView","MenuBarMenuListView","searchContainer","MenuBarMenuListItemView","labeledFieldView","LabeledFieldView","createLabeledInputText","wrapper","className","iconSpan","appendChild","fieldView","search","aiAgentListItemUpdate","isTextSelected","children","separatorView","ListSeparatorView","titleView","titleButton","MenuBarMenuListItemButtonView","isEnabled","listItemView","delegate","to","aiAgentService","panelView","type","itemView","first","button","isTitle","isSearchInout","isSeparator","isVisible","applyPlaceholderToCurrentLine","modelRoot","modelRange","itemsToRemove","hidePlaceHolder","addEventListener","modelSelection","block","getRectDomOfGivenModelElement","showPlaceHolder","domElement","placeholder","onclick","classList","ele","isReadOnlyMode","isReadOnly","style","left","top","loaderElement","getElementById","tooltipElement","editorRect","hideGptErrorToolTip","AiAgentCommand","Command","refresh","execute","AiAgentEditing","commands","setupEnterKeyHandling","_","AiAgent","DEFAULT_GPT_MODEL","DEFAULT_AI_END_POINT","updatedConfig","maxInputTokens","validateConfiguration","limits","icons","ckeditor"],"mappings":"wYAIO,MAAMA,EACZC,gBACQC,aAER,WAAAC,GAAsB,CAEtB,kBAAcC,GAIb,OAHMJ,EAAeK,WACpBL,EAAeK,SAAW,IAAIL,GAExBA,EAAeK,QACvB,CAEA,eAAWC,CAAaC,GACvBC,KAAKN,aAAeK,CACrB,CAEOE,SAAAA,CAAWC,GACZF,KAAKN,eACTS,QAAQC,IAAK,2BAA4BF,GACzCF,KAAKN,aAAaW,oBAAqBH,GAEzC,CAEOI,UAAAA,CAAYC,GACbP,KAAKN,cACTM,KAAKN,aAAaY,WAAYC,EAEhC,CAEOC,UAAAA,GACDR,KAAKN,cACTM,KAAKN,aAAac,YAEpB,EAGM,MAAMC,EAAiBjB,EAAeI,cCtChCc,EAAkD,CAC9D,gBAAiB,CAChBC,gBAAiB,EACjBC,gBAAiB,KACjBC,sBAAuB,OAExB,SAAU,CACTF,gBAAiB,EACjBC,gBAAiB,MACjBC,sBAAuB,OAExB,cAAe,CACdF,gBAAiB,EACjBC,gBAAiB,MACjBC,sBAAuB,OAExB,WAAY,CACXF,gBAAiB,EACjBC,gBAAiB,MACjBC,sBAAuB,QAIZC,EAAsB,CAAE,KAAM,KAAM,KAAM,MAI1CC,EAAuB,CACnC,aACA,yBACA,OACA,mBACA,YACA,yBACA,mBACA,SACA,gBACA,WACA,oBAKYC,EAAyB,CACrC,CACCC,MAAO,iBACPC,MAAO,CACN,CACCD,MAAO,kBACPE,QACC,gKAGF,CACCF,MAAO,eACPE,QACC,qJAGF,CACCF,MAAO,cACPE,QACC,oKAGF,CACCF,MAAO,oBACPE,QACC,oKAKJ,CACCF,MAAO,0BACPC,MAAO,CACN,CACCD,MAAO,YACPE,QACC,iKAGF,CACCF,MAAO,WACPE,QACC,iKCrFCC,EAAwC,CAC7CC,WAAY,aACZC,QAAS,aACTC,UAAW,MACXC,SAAU,KACVC,SAAU,KACVC,SAAU,KACVC,WAAY,MACZC,YAAa,MACbC,UAAW,IACXC,MAAO,QACPC,UAAW,KACXC,SAAU,KACVC,UAAW,KACXC,eAAgB,MAIXC,EAAiD,CACtDC,KAAM,SACNC,OAAQ,KACRC,KAAM,OACNC,cAAe,IACfC,UAAW,MACXC,YAAa,MACbC,UAAW,IACXC,SAAU,KASJ,SAASC,EAAoBC,GACnC,MACMC,EADSD,EAAOE,MAAMC,OACDC,iBACrBC,EAAcC,OAAOC,KAAMN,GAAcO,OACzCC,EAAc,IAAIC,IAGxBL,EAAYM,SAASC,IACfA,KAAQrC,GACZkC,EAAYI,IAAKtC,EAAeqC,GACjC,IAID,MAAME,EAAiBb,EAAYc,MAenC,OAdKD,GAAkBA,EAAeE,iBACrCF,EAAeE,gBAAgBL,SAAWM,IACpCA,KAAQ3B,GACZmB,EAAYI,IAAKvB,EAAwB2B,GAC1C,IAKGR,EAAYS,IAAK,QACrBT,EAAYI,IAAK,MACjBJ,EAAYI,IAAK,OAGXM,MAAMC,KAAMX,GAAcD,MAClC,KCpEIa,UCCJC,aAAuB,SAAwBC,EAAMC,GACjD,OAAIA,EAAEC,OAAS,EACJD,EAAEE,QAAQH,EAAKI,OAAO,KAAO,EAGjCJ,EAAKI,OAAO,KAAOH,CAC9B,EAEAF,SAAmB,SAAmBC,EAAMK,GACxC,OAAOL,EAAKI,MAAMJ,EAAKE,OAASG,EAAIH,UAAYG,CACpD,QDTIC,EAAuB,CACvB,KACA,MACA,OACA,MACA,MAAO,MACP,OACA,KACA,KACA,KACA,OACA,MACA,OACA,KACA,KACA,KACA,MACA,MACA,MACA,MACA,KACA,MACA,MACA,MACA,OACA,OACA,MACA,KACA,MACA,MACA,MAAM,MAAM,MAAM,MAAM,MAAM,MAAM,MAAM,MAAM,OAAO,MAAM,MAAM,MACnE,KACA,KACA,OAAQ,MAAO,KAAM,KACrB,MACA,KACA,MACA,KACA,MACA,MAAO,KAAM,KAAM,KAAM,KACzB,KACA,MACA,KACA,OAAQ,KACR,KACA,MACA,OACA,MACA,OACA,MACA,MACA,OACA,MAAO,MAAO,MAAO,MAAO,MAAM,MAAO,KAAM,MAAO,OAAO,KAC7D,KAAM,KAAM,KAAM,KAAM,MACxB,MAAM,MAAM,KAAK,MAAM,OAAO,MAAM,KAAK,MAAM,OAAO,QAAQ,MAAM,MACpE,QACA,OACA,MACA,MACA,KACA,KAGoBC,EAAAC,iBAAG,SAASC,GAE5BX,EADAW,GAGgBH,CAExB,EAEA,IAAII,EAAgBH,EAAAG,cAAwB,SAASC,GACjD,MAAO,gBAAgBC,KAAKD,IAAQE,EAASF,EACjD,IAGyBG,kBAAG,SAASH,GACjC,OAAOD,EAAcC,IAAQ,SAASC,KAAKD,EAAII,UAAU,EAAE,GAC/D,EAE4BR,EAAAS,qBAAG,SAASL,GACpC,IAAIM,EAAYN,EAAIO,QAAQ,8CAA+C,IAE3E,OAAQpB,EAAcK,QAAQc,EAClC,EAGAV,EAAAY,mBAA6B,SAASnB,EAAMoB,GACxC,IAAa,SAATpB,GAA4B,SAATA,IAGP,QAFFoB,EAAKF,QAAQ,OAAQ,IAAId,OAAO,GAAGiB,cAGzC,OAAO,EAIf,OAAO,CACX,EAE4Bd,EAAAe,qBAAG,SAAStB,GACpC,IAAIuB,EAAUvB,EAAKkB,QAAQ,kBAAmB,IAAIM,MAAM,UACxD,OAAOD,GAAWA,EAAQ,GAAGrB,OAAS,CAC1C,IAI4BuB,qBAAG,SAASd,GACpC,OAAIA,EAAIT,QAAU,GAIXQ,EAAcC,EACzB,EAIAJ,EAAAmB,mBAA6B,SAASC,EAAWC,GAC7C,OAAIA,EAAM1B,OAAS,OACXyB,EAAY,GAAKC,EAAM,GAAG1B,OAAS,GAAKQ,EAAckB,EAAM,MAI9CA,EAAMC,QAAO,SAASlB,GACpC,MAAO,QAAQC,KAAKD,EAAImB,OAAO,GAC3C,IAE2B5B,QAAU,EAIrC,EAEA,IAAIW,EAA2BN,EAAAM,SAAG,SAASF,EAAKoB,GAK5C,OAJIA,IACApB,EAAMA,EAAIP,MAAM2B,EAAO,EAAGA,EAAO,KAG7BC,MAAMrB,EAClB,IAIiBsB,UAAG,SAAStB,GACzB,OAAOA,EAAIa,MAAM,wQACrB,IAIaU,MAAG,SAASvB,GACrB,OAAOA,EAAIa,MAAM,2EACrB,IAIsBW,eAAG,SAASnC,GAC9B,IAAIoC,EAAI,EAER,KAAKA,EAAIpC,EAAKG,QAAQ,OAAS,IAC1BiC,EAAIpC,EAAKG,QAAQ,OAAS,IAC1BiC,EAAIpC,EAAKG,QAAQ,OAAS,IAEnBH,EAAK8B,OAAOM,EAAI,GAGlBZ,MAAM,cACR,MAAO,CAACxB,EAAKI,MAAM,EAAGgC,GAAIpC,EAAKI,MAAMgC,EAAE,IAI/C,OAAO,CACX,EAEsB7B,EAAA8B,eAAG,SAASrC,GAC9B,MAAgB,MAATA,GACS,MAATA,GACS,MAATA,CACX,EEhLA,IAAIsC,ECDa,SAAsBC,EAAMC,GAE3C,IAAoB,iBAARD,GAAoBA,aAAgBE,SAA+B,oBAAbC,SAA0B,CAC1F,IAAIC,EAAOD,SAASE,cAAc,OAClCD,EAAKE,UAAYN,EACjBA,GAAQI,EAAKG,aAAe,IAAIC,MACjC,KAEwB,iBAATR,GAAqBA,EAAKO,cACxCP,GAAQA,EAAKO,aAAe,IAAIC,QAGlC,OAAOR,CACT,EDVIxC,EAAeiD,EACfzC,EAAS0C,EAETC,EAAsB,QACtBC,EAAwBD,EAAoBH,OAG5CK,EAAkB,IAAIC,OAAO,MAAO,IACpCC,EAAuB,IAAID,OAAO,oBAAqB,KACvDE,EAAiB,IAAIF,OAAO,WAAY,KE0BrC,SAASG,EAAqBjB,GACpC,OAAOA,EAAKkB,MAAO,MACjBC,KAAKC,GAAQA,EAAKZ,SAClBa,KAAM,KACT,CAUO,SAASC,EACfC,EACAC,EACAC,GAAmB,EACnBvF,GAEA,IAAIwF,EAAiB,GACjBC,EAAY,EAEhB,MAAMC,EAAsB,CAC3BC,qBAAqB,EACrBC,iBAAiB,EACjBC,aAAc9F,EAAoBC,IAG7B8F,EAAYC,EAAID,UAAWT,EAAoBK,GAC/CM,EAAWT,EAAUO,EAAUP,UAAYO,EAEjD,IAAM,MAAMG,KAAYD,EAAW,CAClC,MAAME,EAAiBD,EAASxE,OAChC,MAAOgE,EAAYS,GAAmB,GAAKZ,GAM1C,MALAE,EAAiBD,EAChBU,EAAWT,EACXA,EAAiBS,EAClBR,GAAaS,CAIf,CAEA,OAAOV,EAAelB,MACvB,CC1EO,SAAS6B,EAAaC,GAC5B,IAAMA,GAA8B,iBAAZA,EACvB,OAAO,EAIR,MAKMC,EALoBD,EACxB9B,OACA7B,QAAS,OAAQ,KAGcM,MAAO,qCAAwC,GAGhF,IAAIuD,EAAmB,EAUvB,OATAD,EAAO1F,SAAS4F,IAEVA,EAAM9E,OAAS,GACnB6E,GAAoBE,KAAKC,KAAMF,EAAM9E,OAAS,GAE9C6E,GAAoB,CACrB,IAGMA,CACR,CAUO,SAASI,EAAwBN,EAAiBO,GACxD,MAAMC,EAAWR,EAAQpB,MAAO,MAChC,IAAI6B,EAAoB,EACpBrB,EAAiB,GAErB,IAAM,MAAMsB,KAAWF,EAAW,CACjC,MAAMG,EAAoBZ,EAAaW,GACvC,GAAKD,EAAoBE,EAAoBJ,EAC5C,MAEDE,GAAqBE,EACrBvB,GAAkBsB,EAAU,IAC7B,CAEA,OAAOtB,CACR,CCnDOwB,eAAeC,EAAiBC,GACtC,MACMC,EAAaD,EAAI5C,OAEvB,IAHiB,wCAGFnC,KAAMgF,GACpB,MAAM,IAAIC,MAAO,eAGlB,IAEC,MACMC,EAAa,qBADAF,EAAW1E,QAAS,gBAAiB,IACJ6B,SAC9CgD,QAAiBC,MAAOF,EAAW/C,OAAQ,CAChDkD,QAAS,CACR,uBAAwB,UAG1B,IAAMF,EAASG,GACd,MAAM,IAAIL,MAAO,uBAAwBE,EAASI,UAEnD,MAAMtB,QAAgBkB,EAASxD,OAG/B,GAAKsC,EAAQuB,SAAU,sCACtB,MAAM,IAAIP,MAAO,eAAgBD,wBAGlC,GAA+B,IAA1Bf,EAAQ9B,OAAO7C,OACnB,MAAM,IAAI2F,MAAO,0BAGlB,OAAOhB,EAAQ3D,QAAS,yBAA0B,IAAKA,QAAS,UAAW,IAAK6B,MACjF,CAAE,MAAQsD,GAGT,OAFAtK,QAAQsK,MAAO,4BAA6BV,IAAQU,GACpDhK,EAAeR,UAAW,+BACnB,EACR,CACD,CJ7BAyK,EAAA/B,UAAoB,SAAShC,EAAMgE,GAC/B,IAAKhE,GAAwB,iBAATA,IAAsBA,EAAKrC,OAC3C,MAAO,GAGX,IAAKkD,EAAgBxC,KAAK2B,GAExB,MAAO,GAGT,IA2CIX,EACAkD,EA5CAX,EAAU,CACVqC,oBAAwB,EACxBnC,iBAAwB,EACxBoC,qBAAwB,CAAC,IAAI,MAAM,KAAK,MACxCC,UAAwB,EACxBpC,cAAwB,EACxBF,qBAAwB,EACxBtE,cAAwB,MAG5B,GAA4B,kBAAjByG,EAEPpC,EAAQqC,oBAAqB,OAI7B,IAAK,IAAIG,KAAKJ,EACVpC,EAAQwC,GAAKJ,EAAaI,GAUlC,GANApG,EAAMC,iBAAiB2D,EAAQrE,eAE3BqE,EAAQqC,qBACRjE,EAAOA,EAAKrB,QAAQoC,EAAsBJ,IAG1CiB,EAAQE,gBAAiB,CACzB,IAAIuC,EAAyB,sBAAwBzC,EAAQsC,qBAAqB7C,KAAK,KAAO,MAC1FiD,EAAK,IAAIxD,OAAOuD,EAAwB,KAC5CrE,EAAOA,EAAKrB,QAAQ2F,EAAI,KAAO3D,EAClC,EAEGiB,EAAQuC,UAAYvC,EAAQG,gBACtBH,EAAQG,eACVH,EAAQG,aAAe,CAAC,KAG5B/B,EAAOD,EAAaC,EAAM,CAAErD,YAAgBiF,EAAQG,gBAwBxD,IAAI3C,EAAY,EACZmF,EAAQ,EACRC,EAAQ,GACRxC,EAAY,GACZyC,EAAY,GAGhB,KAjBIpF,EALAuC,EAAQC,qBAERU,EAASvC,EAAKkB,MAAM,yBAGL5B,QAAO,SAAUmD,EAAOiC,GACrC,OAAOA,EAAK,CACtB,IAIgB1E,EAAKQ,OAAOvB,MAAM+B,MAWf3B,EAAM1B,OACjB,MAAO,GAGX,IAAK,IAAIkC,EAAE,EAAG8E,EAAEtF,EAAM1B,OAAQkC,EAAI8E,EAAG9E,IAWjC,GAVAT,IAGAqF,EAAQG,KAAKvF,EAAMQ,KAGdR,EAAMQ,GAAGjC,QAAQ,OAClBwB,EAAY,GAGZpB,EAAM8B,eAAeT,EAAMQ,KAAOrC,EAAaqH,aAAaxF,EAAMQ,GAAI,OAASR,EAAMQ,KAAOe,GACvFgB,EAAQqC,oBAAsBrC,EAAQE,kBAAoBzC,EAAMQ,KAAOe,GACxE6D,EAAQK,MAGZ9C,EAAU4C,KAAKH,GAEfrF,EAAY,EACZqF,EAAY,QAahB,IAPIjH,EAAaqH,aAAaxF,EAAMQ,GAAI,MAASrC,EAAaqH,aAAaxF,EAAMQ,GAAI,QACjFR,EAAMQ,GAAKR,EAAMQ,GAAGhC,MAAM,GAAI,IAM9BL,EAAaqH,aAAaxF,EAAMQ,GAAI,KAAxC,CAGI,GAAIA,EAAE,EAAI8E,EAAG,CAET,GAAwB,IAApBtF,EAAMQ,GAAGlC,QAAgB8B,MAAMJ,EAAMQ,GAAGN,OAAO,IAC/C,SAIJ,GAAIvB,EAAMS,qBAAqBY,EAAMQ,IACjC,SAKJ,GAAI7B,EAAMO,kBAAkBc,EAAMQ,EAAE,IAAK,CACrC,GAAI7B,EAAMY,mBAAmBS,EAAMQ,GAAIR,EAAMQ,EAAE,IAC3C,SAIJ,GAAI7B,EAAMmB,mBAAmBC,EAAWC,EAAMxB,MAAMgC,EAAG,IACnD,SAGJ,GAAI7B,EAAMM,SAASe,EAAMQ,EAAE,KACnB7B,EAAMkB,qBAAqBG,EAAMQ,IACjC,aAIP,CAED,GAAIrC,EAAauH,SAAS1F,EAAMQ,GAAI,MAChC,SAKJ,GAAI7B,EAAMe,qBAAqBM,EAAMQ,IACjC,SAGJ,GAAI7B,EAAMmB,mBAAmBC,EAAWC,EAAMxB,MAAMgC,EAAG,IACnD,QAEP,CACJ,CAEDmC,EAAU4C,KAAKH,GACfA,EAAY,GACZrF,EAAY,CAGf,KAvDD,CA0DA,IAAKmF,EAAQlF,EAAMQ,GAAGjC,QAAQ,OAAS,EAAG,CACtC,GAAII,EAAMM,SAASe,EAAMQ,GAAI0E,GACzB,SAIJ,GAAIvG,EAAMe,qBAAqBM,EAAMQ,IACjC,SAIJ,GAAI7B,EAAM2B,MAAMN,EAAMQ,KAAO7B,EAAM0B,UAAUL,EAAMQ,IAC/C,QAEP,EAEG2E,EAAOxG,EAAM4B,eAAeP,EAAMQ,OAClC4E,EAAQK,MACRL,EAAQG,KAAKJ,EAAK,IAClBxC,EAAU4C,KAAKH,GAGfrF,EAAY,GADZqF,EAAU,IAEFG,KAAKJ,EAAK,IA1BrB,CA4DL,OA9BIC,EAAQ9G,QACRqE,EAAU4C,KAAKH,IAKnBzC,EAAYA,EAAU1C,QAAO,SAAS0F,GAClC,OAAOA,EAAErH,OAAS,CAC1B,KAE2BE,MAAM,GAAGoH,QAAO,SAAUC,EAAK/C,GACpD,IAAIgD,EAAeD,EAAIA,EAAIvH,OAAS,GAGpC,OAA4B,IAAxBwH,EAAaxH,QAAgB,cAAcU,KAAK8G,EAAa,MAGxD,MAAM9G,KAAK8D,EAAS,KACrB+C,EAAIJ,MACJI,EAAIN,KAAKO,EAAaC,OAAOjD,IACtB+C,IAIfA,EAAIN,KAAKzC,GAEF+C,KACN,CAAElD,EAAU,KAGDb,KAAI,SAAUgB,EAAUuC,GACpC,GAAI9C,EAAQC,sBAAwBD,EAAQqC,qBAAuBrC,EAAQE,gBAAiB,CAK1F,IAAIuD,EAA+B,EAAlBlD,EAASxE,OAM1B,OAJW,IAAP+G,IACFW,GAAc,GAGT9C,EAAO+C,OAAO,EAAGD,GAAYhE,KAAK,GAC1C,CAED,OAAOc,EAASd,KAAK,IAC3B,GACA,EK/PO,MAAMkE,EACJrJ,OACAsF,YACAgE,eACAC,UACAC,mBAER1M,WAAAA,CAAakD,EAAgB0F,EAA2C,IACvEvI,KAAK6C,OAASA,EACd,MAAMyJ,EAASzJ,EAAOyJ,OAAOC,IAAK,WAElCvM,KAAKmI,YAAcmE,EAAOnE,aAAe,IACzCnI,KAAKmM,eAAiBG,EAAOH,gBAAkB,CAAC,EAChDnM,KAAKoM,UAAYE,EAAOF,YAAa,EACrCpM,KAAKqM,mBAAqB9D,EAAQ8D,oBAAsB,EACzD,CAEOG,eAAAA,CAAiBC,GAA4B,GACnD,MAAMC,ECxBA,CACNC,cAAe,2pBAWfC,eAAgB,iJAGkChK,EDSP5C,KAAK6C,QCT+BmF,KAAM,0eAYrF6E,iBAAkB,yXAUlBC,KAAM,mdAUNC,cAAe,mSAQfC,cAAe,2PD9Bf,IAAIC,EAAe,GAGnB,IAAM,MAAQC,EAAIC,KAAoBhK,OAAOiK,QAASV,GAAsB,CAE3E,GACU,kBAATQ,IAA6BtK,EAAoB5C,KAAK6C,QAAS2H,SAAU,QAChE,kBAAP0C,IAA2BT,EAE7B,SAGD,MAAMY,EAAcH,EACpB,IAAIjE,EAAUkE,EAGTnN,KAAKmM,eAAemB,YAAaD,KACrCpE,EAAUjJ,KAAKmM,eAAemB,UAAWD,IAIrCrN,KAAKmM,eAAeoB,YAAaF,KACrCpE,GAAW,KAAOjJ,KAAKmM,eAAeoB,UAAWF,IAIlDJ,GAAgBrF,EAAqBqB,GAAc,MACpD,CAQA,OANKjJ,KAAKoM,YACTjM,QAAQqN,MAAO,+BACfrN,QAAQC,IAAK,iBAAkB6M,GAC/B9M,QAAQsN,YAGFR,CACR,CAEOS,WAAAA,CAAaC,EAAgBC,EAA8B,IACjE,IAAIC,EAAsB,GACtB3F,EAAqB,GACzB,MAAM4F,EAAYF,GAAuBD,EACnCI,EAAO/N,KAAK6C,QAAQmL,SAASD,MAAME,UAAU1B,IAAK,QAClD2B,EAAUH,GAAMI,WAAa,GAE7BC,EAAaF,EAAQ3J,QAASuJ,GAC9BO,EAAiBH,EAAQ3J,QAAS,KAAM6J,GACxCE,GAAwC,IAApBD,EAAwBA,EAAiBD,EAAaN,EAAUxJ,OAGpFiK,EAAe,CAFCL,EAAQ/I,UAAW,EAAGmJ,GACvBJ,EAAQ/I,UAAWmJ,EAAoB,IAGtDE,EAA8BnF,KAAKoF,MAAOzO,KAAKmI,YAAcnI,KAAKqM,oBACnEkC,EAAajK,OAAS,IACrBiK,EAAc,GAAIjK,OAASiK,EAAc,GAAIjK,QACjDuJ,EAAsB5F,EACrBsG,EAAc,GACdC,EAA8B,GAC9B,EACAxO,KAAK6C,QAENqF,EAAqBD,EACpBsG,EAAc,GACdC,EAA8BX,EAAoBvJ,OAAS,GAC3D,EACAtE,KAAK6C,UAGNqF,EAAqBD,EACpBsG,EAAc,GACdC,EAA8B,GAC9B,EACAxO,KAAK6C,QAENgL,EAAsB5F,EACrBsG,EAAc,GACdC,EAA8BtG,EAAmB5D,OAAS,GAC1D,EACAtE,KAAK6C,UAMR,MAAM6L,EAAgBf,EAAOrI,QAAS,sBAAuB,QAC7DuI,EAAsBA,EAAoB1G,OACxC7B,QAAS,IAAImC,OAAQiH,EAAclK,MAAO,IAAO,gBACjDc,QAAS,gBAAiB,gBAE5B,MADuB,GAAIuI,MAA0B3F,IAC/Bf,MACvB,CAEOwH,iBAAAA,CACNC,EACAV,EACAW,EACAC,EACAC,GAEK/O,KAAKoM,YACTjM,QAAQqN,MAAO,2BACfrN,QAAQC,IAAK,WAAYwO,GACzBzO,QAAQC,IAAK,WAAY8N,GACzB/N,QAAQC,IAAK,oBAAqByO,GAClC1O,QAAQC,IAAK,iBAAkB0O,IAGhC,MAAME,EAAsBhP,KAAK6C,OAAOoM,OAAOC,gBACzCC,EAAwB,GAqB9B,GAlBAA,EAAO5D,KAAM,UACb4D,EAAO5D,KAAMqD,GACbO,EAAO5D,KAAM,WAGR2C,GAAS5J,SAAWyK,IACxBI,EAAO5D,KAAM,eACb4D,EAAO5D,KAAM2C,GACbiB,EAAO5D,KAAM,eAGTwD,IACJI,EAAO5D,KAAM,sBACb4D,EAAO5D,KAAMwD,GACbI,EAAO5D,KAAM,wBAITsD,GAAkBvK,OAAS,CAC/B6K,EAAO5D,KAAM,yBACb,IAAM,MAAMtC,KAAW4F,EACtBM,EAAO5D,KAAM,gBAAiBtC,EAAQc,UAAYd,EAAQA,sBAE3DkG,EAAO5D,KAAM,wBAEb4D,EAAO5D,KAAM,4BACb4D,EAAO5D,KAAM3D,EAAqB,oUAQlCuH,EAAO5D,KAAM,0BACd,CAkCA,OA/BA4D,EAAO5D,KAAM,oBACb4D,EAAO5D,KAAM,gDAAiDyD,MAC9DG,EAAO5D,KAAM,mBAGPuD,GAAkBC,IACvBI,EAAO5D,KAAM,4BACb4D,EAAO5D,KAAM3D,EAAqB,slBAclCuH,EAAO5D,KAAM,4BAITvL,KAAKoM,YACTjM,QAAQqN,MAAO,8BACfrN,QAAQC,IAAK,gBAAiB+O,EAAOnH,KAAM,OAC3C7H,QAAQsN,YAGF0B,EAAOrH,KAAKnB,GHrLd,SAA8BA,GACpC,OAAOA,EAAKkB,MAAO,MACjBC,KAAKC,GAAQA,EAAKqH,cAClBpH,KAAM,KACT,CGiL6BqH,CAAqB1I,KAASqB,KAAM,KAChE,CAEA,6BAAasH,CAAyBC,GACrC,IACC,MAAMC,EAA2C,GAEjD,IAAM,MAAMzF,KAAOwF,EAClB,IACC,MAAMtG,QAAgBa,EAAiBC,GAClCd,GACJuG,EAAiBjE,KAAM,CACtBtC,UACAc,MACAiC,WAAYhD,EAAaC,IAG5B,CAAE,MAAQwB,GACJzK,KAAKoM,WACTjM,QAAQsK,MAAO,gCAAiCV,KAASU,GAE1DhK,EAAeR,UAAW,gCAAiC8J,IAC5D,CAGD,OAAO/J,KAAKyP,+BACXzP,KAAKwM,kBACLgD,EAEF,CAAE,MAAQ/E,GAKT,OAJKzK,KAAKoM,WACTjM,QAAQsK,MAAO,qCAAsCA,GAEtDhK,EAAeR,UAAW,uCACnB,EACR,CACD,CAEOwP,8BAAAA,CACN9B,EACA+B,GAEA,MAAMC,EAAgB3P,KAAK6C,QAAQmL,SAASD,MAAME,UAAU1B,IAAK,SAAU4B,WAAa,GAClFyB,EAAcvG,KAAKwG,IACxBxG,KAAKoF,MAAOzO,KAAKmI,YAAcnI,KAAKqM,oBACpCrD,EAAa2G,IAERG,EAAiB9P,KAAKmI,YAAcyH,EAE1C,GAAwB,IAAnBE,IAAyBJ,EAAepL,OAC5C,OAAOoL,EAGR,MAAMK,EAAmB1G,KAAKoF,MAAOqB,EAAiBJ,EAAepL,QAErE,OAAOoL,EAAe5H,KAAKmB,IAAa,IACpCA,EACHA,QAASM,EAAwBN,EAAQA,QAAS8G,MAEpD,EExQM,MAAMC,EACJnN,OACAE,MACAqJ,UAERzM,WAAAA,CAAakD,GACZ7C,KAAK6C,OAASA,EACd7C,KAAK+C,MAAQF,EAAOE,MACpB/C,KAAKoM,UAAYvJ,EAAOyJ,OAAOC,IAAK,uBAAyB,CAC9D,CAQA,sBAAa0D,CAAkBC,GACzBlQ,KAAKoM,WACTjM,QAAQC,IAAK,oCAAqC8P,GAEnD,MAAMC,EAAenQ,KAAK6C,OAAOuN,KAAKC,UAAUC,OAAQJ,GAClDK,EAAgBvQ,KAAK6C,OAAOuN,KAAKI,QAASL,EAAc,SAExDM,EAAYzQ,KAAK+C,MAAM+D,SAAS2J,UAChCC,EAAO1Q,KAAK+C,MAAM+D,SAAS6J,UAEjC,IAAIC,EAAoBH,EAAUI,kBAClC,MAAMC,EAAoBP,EAAcQ,SAAUR,EAAcS,WAAa,GAEvEC,EAAoBR,EAAUI,mBAAmBK,KAAM,GACvDC,EAA2BT,GAAMK,SAAUE,GAAqB,GAEtEjR,KAAK+C,MAAMqO,QAAQC,IAOlB,GANKF,GAA0BG,GAAI,aAClCV,EAAoBO,EAAyBI,QAC5CF,EAAOG,iBAAkBL,EAA0B,OACnDE,EAAOI,oBAAqBN,IAGzBP,GAAqBF,EAAO,CAEhCW,EAAOK,aAAcd,GACrB5Q,KAAK+C,MAAM4O,cAAepB,EAAeK,GAIzC,IAAIgB,EAAoBd,GAAmBe,aAAc,cAIzD,GAHKf,GAAmBQ,GAAI,aAC3BM,EAAoBA,GAAgD,UAA3Bd,EAAkBgB,MAEvDF,GAAqBd,EAAoB,CAC7C,MAAMjP,EAAYwP,EAAOrK,cAAe,aACxCqK,EAAOU,OAAQlQ,EAAWwP,EAAOI,oBAAqBX,IACtDO,EAAOK,aAAc7P,EAAW,KACjC,MAAYiP,GACXO,EAAOK,aAAcL,EAAOI,oBAAqBX,GAEnD,WAIK,IAAIkB,SAASC,GAAWC,WAAYD,EAAS,MACpD,CAgBA,kBAAaE,CACZlJ,EACAmJ,EACAC,GAAkB,EAClBC,GAA+B,GAE/B,MAAMnC,EAAenQ,KAAK6C,OAAOuN,KAAKC,UAAUC,OAAQrH,EAAQsJ,WAC1DhC,EAAgBvQ,KAAK6C,OAAOuN,KAAKI,QAASL,EAAc,SACxDqC,EAAmBxO,MAAMC,KAAMsM,EAAckC,eAC7C/B,EAAO1Q,KAAK+C,MAAM+D,SAAS6J,UAEjC,IAAM,MAAQzF,EAAOvB,KAAa6I,EAAiBpF,UAClD,GAAKzD,EAAQ2H,GAAI,WAAc,CAC9B,MAAMoB,EAA2B,IAAVxH,EAAckH,OAAWO,EAC3CN,QACErS,KAAK4S,sBAAuBjJ,EAAS+I,SAErC1S,KAAK6S,qBAAsBlJ,EAAS+I,EAE5C,CAGIJ,GACJtS,KAAK+C,MAAMqO,QAAQC,IAClB,MAAMyB,EAAe9S,KAAK+C,MAAM+D,SAAS2J,UAAUI,kBAC7CI,EAAoB6B,GAAc5B,KAAM,GAC9C,GAAKR,GAA6BiC,MAArB1B,EAAiC,CAC7C,MAAMpP,EAAYwP,EAAOrK,cAAe,aACxCqK,EAAOU,OAAQlQ,EAAW6O,EAAMO,EAAoB,GACpDI,EAAOK,aAAc7P,EAAW,KACjC,IAGH,CAUA,0BAAagR,CAAsBlJ,EAAkByI,GACpD,MAAM3B,EAAYzQ,KAAK+C,MAAM+D,SAAS2J,UAChCC,EAAO1Q,KAAK+C,MAAM+D,SAAS6J,UAEjC,IAAIC,EAA0CwB,EAE9C,IAAMA,EAAW,CAChB,MAAMnB,EAAoBR,EAAUsC,oBAAoB7B,KAAM,GACxDC,EAA2BT,GAAMK,SAAUE,GAAqB,GACjEE,GAA0BG,GAAI,aAClCV,EAAoBO,EAAyBI,QAC5CvR,KAAK+C,MAAMyO,iBAAkBL,EAA0B,OACvDnR,KAAK+C,MAAM0O,oBAAqBN,GAEnC,CAGAnR,KAAK+C,MAAMqO,QAAQC,IAClBrR,KAAK+C,MAAM4O,cAAehI,EAASiH,GACnCS,EAAOK,aAAc/H,EAAS,MAAA,GAEhC,CAUA,2BAAciJ,CAAuBjJ,EAAkByI,GACtD,MAAM3B,EAAYzQ,KAAK+C,MAAM+D,SAAS2J,UAChCC,EAAO1Q,KAAK+C,MAAM+D,SAAS6J,UAC3BqC,EAAyBvC,EAAUI,kBAEzC,IACIoC,EADArC,EAA0CwB,EAI9C,GAAMA,EAqBC,CAEN,MAAMc,EAAiBF,GAAwBG,OAC1CD,GAAgB5B,GAAI,aACxB2B,EAAgBC,EAElB,KA3BiB,CAChB,MAAMjC,EAAoB+B,GAAwB9B,KAAM,GAClDkC,EAAqB1C,GAAMK,SAAUE,GAAqB,GAE3DmC,GAAoB9B,GAAI,aAC5BV,EAAoBwC,EAAmB7B,QACtCvR,KAAK+C,MAAMyO,iBAAkB4B,EAAoB,OACjDpT,KAAK+C,MAAM0O,oBAAqB2B,IAGlCpT,KAAK+C,MAAMqO,QAAQC,IAClB4B,EAAgB5B,EAAOrK,cAAe2C,EAAQmI,MAE9C,IAAM,MAAQuB,EAAKC,KAAW3J,EAAQ4J,gBACrCN,EAAcO,cAAeH,EAAKC,GAEnCtT,KAAK+C,MAAM4O,cAAesB,EAAerC,GACpCA,GACJS,EAAOK,aAAcuB,EAAe,MACrC,IAUF,MAAMQ,EAAezP,MAAMC,KAAM0F,EAAQ8I,eAAgBxM,QAAQyN,GAASA,EAAMpC,GAAI,WAEpF,IAAM,MAAMqC,KAAYF,EAAe,CACtC,IAAME,EAASrC,GAAI,SAClB,SAED,MAAMsC,EAAiB5P,MAAMC,KAAM0P,EAASJ,iBACtCrM,EAAcyM,EAASE,MAE7B,IAAM,MAAMC,KAAQ5M,QACb,IAAI8K,SAASC,IAClBjS,KAAK+C,MAAMqO,QAAQC,IAClB,MAAM0C,EAAkB/T,KAAK6C,OAAOE,MAAM+D,SAAS2J,UAAUI,kBAEvDmD,EADcD,EAAiBE,aAAc,GACbC,SAAWH,GAAiBZ,OAAOgB,UACzE9C,EAAO+C,WAAYN,EAAMF,EAAgBX,EAAee,EAAoB,MAAQD,GAAiBG,QACrG7C,EAAOK,aAAc1R,KAAK6C,OAAOE,MAAM+D,SAAS2J,UAAUI,kBAAe,IAE1EqB,WAAYD,EAAS,KAGxB,CAGMG,GACLpS,KAAK+C,MAAMqO,QAAQC,IAClBA,EAAOK,aAAcuB,EAAe,MAAA,GAGvC,CAOOoB,mBAAAA,CAAqBnE,GAK3B,IAJsBA,EAAKtK,MAAO,iBAAoB,IAAKtB,UACrC4L,EAAKtK,MAAO,eAAkB,IAAKtB,OAIxD,OAAO,EAIR,GAAK4L,EAAK1F,SAAU,OAAU0F,EAAK1F,SAAU,KAC5C,OAAO,EAIR,MAAM8J,EAAcpE,EAAK/I,OACzB,SAAMmN,EAAYC,WAAY,OAAUD,EAAY5I,SAAU,KAK/D,ECjPc,MAAM8I,EACZ3R,OACA4R,QACAC,OACAC,YACAC,YACAC,gBACArL,UACAsL,cACAC,cACAC,cACAC,qBAAuBC,OAAQ,oBAC/BC,aACAC,WAEAC,OAAS,GACTC,SAA0B,GAC1BC,mBAA6B,EAC7BC,iBAA2B,EAC3BC,cACAC,iBACAC,aAA4C,GAOpDhW,WAAAA,CAAakD,GACZ7C,KAAK6C,OAASA,EACd7C,KAAKmV,aAAe,IAAIjJ,EAAcrJ,GACtC7C,KAAKoV,WAAa,IAAIpF,EAAYnN,GAClC,MAAMyJ,EAASzJ,EAAOyJ,OAAOC,IAAK,WAElCvM,KAAKyU,QAAUnI,EAAOvJ,MACtB/C,KAAK0U,OAASpI,EAAOoI,OACrB1U,KAAK2U,YAAcrI,EAAOqI,YAC1B3U,KAAK4U,YAActI,EAAOsI,YAC1B5U,KAAK6U,gBAAkBvI,EAAOuI,iBAAmB,KACjD7U,KAAKwJ,UAAY8C,EAAO1L,iBAAmB0L,EAAO9C,UAClDxJ,KAAK8U,cAAgBxI,EAAOwI,cAC5B9U,KAAKgV,cAAgB1I,EAAO0I,cAC5BhV,KAAK+U,cAAgBzI,EAAOyI,gBAAiB,EAC7C/U,KAAKyV,cAAgBnJ,EAAOsJ,YAAYvC,KAAO,GAC/CrT,KAAK0V,iBAAmBpJ,EAAOsJ,YAAYC,SAAU,EACrD7V,KAAK2V,aAAerJ,EAAOsJ,YAAYD,cAAgB,EACxD,CAOA,wBAAaG,CAAoB3U,GAChC,MAAM0B,EAAS7C,KAAK6C,OACdE,EAAQF,EAAOE,MACfgT,EAASlT,EAAOmL,QAAQ+H,OACxBhI,EAAOlL,EAAOmL,QAAQD,KACtB2C,EAAO3N,EAAM+D,SAAS6J,UAE5B,IAAI1H,EACA8F,EACAiH,EACA7C,EACJ,MAAMf,EAAWrP,EAAM+D,SAAS2J,UAAUI,kBAE1C,GAAKuB,GAAY1B,EAAO,CACvByC,EAASf,EAASe,OAClB,MAAM8C,EAA8B,iBAAhB9C,EAAOrB,KAA0BqB,OAASR,EACxDuD,EAAiBH,EAAOI,cAAehD,GAG7C,GAFA6C,EAAuBE,EAAiBnI,EAAKqI,aAAaC,aAAcH,QAAmBvD,EAEtFsD,EAAc,CAClBpT,EAAOE,MAAMqO,QAAQC,IACpB,MAAMiF,EAAcjF,EAAOG,iBAAkByE,EAAa,OAC1D5E,EAAOK,aAAc4E,EAAAA,IAGtBtW,KAAKuV,mBAAoB,EACzB,MAAMgB,EAAgB1T,EAAOE,MAAMyO,iBAAkByE,EAAa,GAC5DK,EAAczT,EAAOE,MAAMyO,iBAAkByE,EAAa,OAC1DO,EAAQzT,EAAM0T,YAAaF,EAAeD,GAChDN,EAAuBE,GAAgB/C,OACtCpF,EAAKqI,aAAaC,aAAcH,EAAe/C,aAC/CR,EACD1J,EAAU,GAEV,IAAM,MAAMyN,KAAQF,EAAMG,WACpBD,EAAKpF,GAAI,gBACbrI,GAAWyN,EAAKtG,KAAKjJ,OAGxB,MAAY6O,IACXnT,EAAOE,MAAMqO,QAAQC,IACpB,MAAMiF,EAAcjF,EAAOG,iBAAkBY,EAASe,OAAQ,OAC9D9B,EAAOK,aAAc4E,EAAAA,IAEtBrN,EAAU+M,GAAsB7H,UAElC,CAEA,GAAKhN,EAAU,CACd8H,EAAU9H,EACV4N,EAAkBiH,GAAsBzD,UACxC,MACMiE,EADYzT,EAAM+D,SAAS2J,UACTmG,gBACnBJ,GACJzT,EAAMqO,QAAQC,IACbA,EAAOK,aAAc8E,EAAM/R,IAAG,GAGjC,CAEA,GAAKzE,KAAK0V,iBAAmB,CAE5B,UAD8B1V,KAAK6W,gBAAiB5N,GAAW,IAE9D,MAEF,CAEA,IACC,MAAM6N,EAAeC,OAAOC,eACtBC,EAAgBH,GAAcI,WAAY,GAC1C3W,EAAO0W,EAASE,wBAEtB1W,EAAeH,WAAYC,GAC3B,MAAM6W,QAAkBpX,KAAKqX,mCAC5BpO,GAAW,GACX+M,GAAsB7H,UACtBY,GAEIoE,GAAUiE,SACRpX,KAAKsX,2BAA4BF,EAAWjE,EAEpD,CAAE,MAAQ1I,GAET,MADAtK,QAAQsK,MAAO,gCAAiCA,GAC1CA,EACG,QACTzK,KAAKuV,mBAAoB,EACzB9U,EAAeD,YAChB,CACD,CAcA,qBAAcqW,CAAiBU,GAC9B,IAAMvX,KAAKyV,cACV,OAAO,EAER,MACM+B,EADSxX,KAAK6C,OACH2U,EACXC,EAAa,IAAIC,gBAGjBC,EAAYzF,YAAY,IAAMuF,EAAWG,SAAS5X,KAAK6U,iBAE7D,IACC,MAAM1K,QAAiBC,MZrJI,wCYqJmB,CAC7CyN,OAAQ,OACRxN,QAAS,CACRyN,cAAiB,UAAW9X,KAAKyV,gBACjC,eAAgB,oBAEjBsC,KAAMC,KAAKC,UAAW,CAAEV,UACxBW,OAAQT,EAAWS,SAKpB,GAFAC,aAAcR,IAERxN,EAASG,GACd,MAAM,IAAIL,MAAO,uBAAwBE,EAASI,UAGnD,MAAM6F,QAAajG,EAASiO,OAE5B,IAAMhI,GAAMiI,UAAW,GACtB,MAAM,IAAIpO,MAAO,sCAGlB,MAAMqO,EAAQvX,EAAqBkF,QAAQsS,IAASvY,KAAK2V,aAAanL,SAAU+N,KAEhF,GAAKnI,EAAKiI,QAAS,GAAIG,QAAU,CAChC,IAAI/N,GAAQ,EACZ,MAAMgO,EAAarI,EAAKiI,QAAS,GAAII,WACrC,IAAM,IAAIvN,EAAQ,EAAGA,EAAQoN,EAAMhU,OAAQ4G,IAAU,CACpD,MAAMqN,EAAOD,EAAOpN,GACpB,GAAKoN,EAAM9N,SAAU+N,IACfE,EAAYF,GAAS,CACzB9N,GAAQ,EACR,KACD,CAEF,CAEA,GAAKA,EAEJ,OADAhK,EAAeR,UAAWuX,EAAG,uDACtB,CAET,CAEA,OAAO,CACR,CAAE,MAAQ/M,GAaT,OAZAtK,QAAQsK,MAAO,oBAAqBA,GAG/BA,aAAiBiO,UACrBjY,EAAeR,UAAWuX,EAAG,4CAClB/M,aAAiBkO,cAA+B,eAAflO,EAAMqH,KAClDrR,EAAeR,UAAWuX,EAAG,iCAE7B/W,EAAeR,UAAWuX,EAAG,iCAIvB,EACE,QACTW,aAAcR,EACf,CACD,CAUA,gCAAcL,CACb3J,EACAwF,EACAyF,EAAkB5Y,KAAK8U,eAEvB3U,QAAQC,IAAK,uCACb,MAAMyC,EAAS7C,KAAK6C,OACd2U,EAAI3U,EAAO2U,EACXC,EAAa,IAAIC,gBACjBC,EAAYzF,YACjB,IAAMuF,EAAWG,SACjB5X,KAAK6U,iBAGN,IAAIQ,EAAS,GACTwD,EAAgB,GACpB,MAAMC,EAAU,OAAO,IAAIC,MAAOC,YAElC,IACC,MAAM7O,QAAiBC,MAAOpK,KAAK2U,YAAa,CAC/CkD,OAAQ,OACRxN,QAAS,CACRyN,cAAe,UAAW9X,KAAK0U,SAC/B,eAAgB,oBAEjBqD,KAAMC,KAAKC,UAAW,CACrBlV,MAAO/C,KAAKyU,QACZwE,SAAU,CACT,CAAEC,KAAM,SAAUjQ,QAASjJ,KAAKmV,aAAa3I,gBAAiBxM,KAAKuV,oBACnE,CAAE2D,KAAM,OAAQjQ,QAAS0E,IAE1BiH,YAAa5U,KAAK4U,YAClBuE,WAAYnZ,KAAKwJ,UACjB4P,KAAMpZ,KAAKgV,cACX3C,QAAQ,IAET6F,OAAQT,EAAWS,SAKpB,GAFAC,aAAcR,IAERxN,EAASG,GACd,MAAM,IAAIL,MAAO,gBAGlBxJ,EAAeD,aAEf,MAAM6Y,EAASlP,EAAS4N,KAAMuB,YACxBC,EAAU,IAAIC,YAAa,SAEjCxZ,KAAKyZ,mBAAoBtG,GAGzB,IAAIuG,GAAe,EAqCnB,IAnCA1Z,KAAK2Z,uBAAwBb,EAASrB,GAEtC5U,EAAOE,MAAMqO,QAAQC,IACpB,MAAMe,EAAWvP,EAAOE,MAAM+D,SAAS2J,UAAUI,kBACjD,GAAKuB,EAAW,CACf,MAAMwH,EAAQvI,EAAOrK,cAAe,SAAU,CAC7CkG,GAAI4L,IAEC3F,EAASf,EAASe,OACnBA,IACyB,cAAxBA,EAAOA,QAAQrB,MAE8B,aAAtCqB,EAAOtB,aAAc,eADhC6H,GAAe,GAMjB,IAAIG,EAAgB,GACpB,IAAM,MAAMnG,KAASP,EAAOV,cACtBiB,EAAMpC,GAAI,WACduI,GAAiBnG,EAAMtD,MAIzB,MAAM0J,EAAmBD,EACxBxI,EAAOG,iBAAkBY,EAASe,OAAQ,SAC1C9B,EAAOG,iBAAkBY,EAASe,OAAQ,UAE3C9B,EAAOU,OAAQ6H,EAAOF,EAAeI,EAAmB1H,GACxD,MAAM2H,EAAc1I,EAAOG,iBAAkBoI,EAAO,OACpDvI,EAAOK,aAAcqI,EACtB,KAGD5Z,QAAQC,IAAK,kCACF,CACV,MAAM4Z,KAAEA,EAAI1G,MAAEA,SAAgB+F,EAAOY,OACrC,GAAKD,EAAO,CACX7Z,QAAQC,IAAK,6BACb,KACD,CAKA,IAAI8Z,EACJ,IAHA7E,GADckE,EAAQY,OAAQ7G,EAAO,CAAEjB,QAAQ,KAIQ,KAA7C6H,EAAe7E,EAAO9Q,QAAS,QAAkB,CAC1D,MAAMwD,EAAOsN,EAAO7Q,MAAO,EAAG0V,GAAe/S,OAG7C,GAFAkO,EAASA,EAAO7Q,MAAO0V,EAAe,GAEjCnS,EAAKwM,WAAY,UAAa,CAClC,MAAM6F,EAAUrS,EAAKvD,MAAO,GAAI2C,OAChC,GAAiB,WAAZiT,EAAuB,CAC3Bja,QAAQC,IAAK,0BACb,KACD,CAEA,IACC,MAAMgQ,EAAO4H,KAAKqC,MAAOD,GACnBnR,EAAUmH,EAAKkK,QAAS,IAAKC,OAAOtR,QACrCA,UACJ4P,GAAiB5P,SAEZjJ,KAAKwa,cAAe3B,EAAeC,EAC1C,CAAE,MAAQ2B,GACTta,QAAQua,KAAM,sBAAuBD,EACtC,CACD,CACD,CACD,CAEAza,KAAK2a,iBAAkB7B,EACxB,CAAE,MAAQrO,GACT,GAAKzK,KAAKwV,gBACT,OAGDrV,QAAQsK,MAAO,uCAAwCA,GACvD,MAAMmQ,GACHnQ,GAAOvK,SAAW,IAAKiH,SAAYsD,GAAOqH,MAAQ,IAAK3K,OACpD0T,EAAmB,CACxB,aACA,+BACA,yBACCrQ,SAAUoQ,GACZ,GAAKhC,EAAU,GAAKiC,EAEnB,OADA1a,QAAQua,KAAM,gBAAiB9B,0BAClB5Y,KAAKsX,2BACjB3J,EACAwF,EACAyF,EAAU,GAGZ,IAAIkC,EACJ,GACM,kCADGrQ,GAAOqH,MAAQrH,GAAOvK,SAASiH,QAEtC2T,EAAetD,EACd,kDASDsD,EAAetD,EACd,6DAIH/W,EAAeR,UAAW6a,GACjB,QACT9a,KAAK6C,OAAOkY,oBAAqB/a,KAAKiV,qBACvC,CACD,CASA,sBAAA0E,CAAgCb,EAAiBrB,GAChD,MAAM5U,EAAS7C,KAAK6C,OACd2U,EAAI3U,EAAO2U,EAEXzJ,EAAO,IAAIiN,EACjB,IAAIC,EAAQzD,EAAG,qBAiCf,GA/BK0D,EAAIC,QACRF,EAAQzD,EAAG,4BAGP0D,EAAIE,YACRH,EAAQzD,EAAG,+BAGZzJ,EAAKsN,IAAK,CACTJ,QACAK,UAAU,EACVC,MAAO,6BAGRxN,EAAKyN,GAAI,WAAW,KACnBxb,KAAKwV,iBAAkB,EACvBiC,EAAWG,QACX5X,KAAK2a,iBAAkB7B,EAAAA,IAGxB/K,EAAK0N,SAEL5Y,EAAO6Y,WAAWL,IAAK,kBAAkB,CAAEM,EAAYC,MACjDD,EAAWE,SAAWF,EAAWG,WACrC9b,KAAKwV,iBAAkB,EACvBiC,EAAWG,QACX5X,KAAK2a,iBAAkB7B,IAExB8C,GAAAA,IAGI/Y,EAAOkZ,GAAGhO,KAAKpE,SAAWoE,EAAKpE,QAAU,CAC7C,MAAMqS,EAAenZ,EAAOkZ,GAAGhO,KAAKpE,QAAQsS,cAAe,gDACtDD,GACJA,EAAaE,OAAQnO,EAAKpE,QAE5B,CAEAuI,YAAY,IAAMnE,EAAKsN,IAAK,CAAEE,MAAO,sCAAwC,IAC9E,CASQZ,gBAAAA,CAAkB7B,GACzB,MAAMjW,EAAS7C,KAAK6C,OAEpB,GAAKA,EAAOkZ,GAAGhO,KAAKpE,QAAU,CAC7B,MAAMwS,EAAetZ,EAAOkZ,GAAGhO,KAAKpE,QAAQsS,cAAe,6BACtDE,GACJA,EAAaC,QAEf,CAGA,IAAIzM,EADe9M,EAAOwZ,UACK/W,QAAS,6CAA8C,IACtFqK,EAAgBA,EAAcrK,QAAS,eAAgBwT,MAAc,IACrEjW,EAAOyZ,QAAS3M,EACjB,CASA,gBAAA4M,CAA0BC,EAAkB1D,GAC3C,MAAMT,EAAU,GAChB,IAAM,MAAM3E,KAAS8I,EAAY/J,cAChC,GAAKiB,EAAMpC,GAAI,WACd,GAAKoC,EAAMpC,GAAI,UAAW,WAAcoC,EAAM7B,aAAc,QAAWiH,EACtET,EAAQ9M,KAAMmI,OACR,CACN,MAAM+I,EAAgBzc,KAAKuc,iBAAkB7I,EAAOoF,GACpDT,EAAQ9M,QAASkR,EAClB,CAGF,OAAOpE,CACR,CAWA,mBAAcmC,CAAekC,EAAiB5D,GAC7C,MAAMjW,EAAS7C,KAAK6C,OACpBA,EAAOE,MAAMqO,QAAQC,IACpB,MAAMX,EAAO7N,EAAOE,MAAM+D,SAAS6J,UACnC,GAAKD,EAAO,CACX,MAAMiM,EAAY3c,KAAKuc,iBAAkB7L,EAAMoI,GACzC7F,EAAgB0J,EAAUrY,OAASqY,EAAW,GAAM,KAE1D,GAAK1J,EAAgB,CACpB,MAAMuD,EAAQ3T,EAAOE,MAAM6Z,cAAe3J,GAC1C5B,EAAO+K,OAAQ5F,GAEf,MAAMrG,EAAetN,EAAOuN,KAAKC,UAAUC,OAAQoM,GAC7CnM,EAAgB1N,EAAOuN,KAAKI,QAASL,GAE3CkB,EAAOU,OAAQxB,EAAe0C,EAAe,MAC9C,CACD,WAEK,IAAIjB,SAASC,GAAWC,WAAYD,IAC3C,CAUA,oBAAc4K,CAAgB5T,GAC7B,IAGC,GAFA9I,QAAQC,IAAK,mCACbD,QAAQC,IAAK,sBAAuB6I,EAASjJ,KAAKuV,mBAC7CvV,KAAKuV,kBAAoB,CAC7B,MAAMnD,EAAWpS,KAAK6C,OAAOE,MAAM+D,SAAS2J,UAAUI,kBAChDiM,EAA6BhW,SAASE,cAAe,OAC3D8V,EAAc7V,UAAYgC,QACpBjJ,KAAKoV,WAAWjD,aAAc2K,GAAiB,GAAI1K,QAAYO,EAAW3S,KAAK+U,oBAEhF/U,KAAK+U,oBAEH/U,KAAK+c,oBAAqB9T,SAG1BjJ,KAAKoV,WAAWnF,iBAAkBhH,GAI1C9I,QAAQC,IAAK,gCACd,CAAE,MAAQqK,GACTtK,QAAQsK,MAAOA,EAChB,CACD,CASA,yBAAcsS,CAAqB7M,GAClC,MAAM8M,EAAuBlW,SAASE,cAAe,OACrDgW,EAAQ/V,UAAYiJ,EAEpB,IAAM,MAAMwD,KAAS1P,MAAMC,KAAM+Y,EAAQC,YAAe,CACvD,MAAMtT,EAAU+J,EAChB,GAAK/J,EAAQuT,WAAaC,KAAKC,aAAe,CAC7C,MAAMC,EAAc1T,EAAQ2T,QAAQ7X,cACR,CAC3B,QAAS,aAAc,MAAO,MAAO,OAAQ,UAC5C+E,SAAU6S,SAGLrd,KAAKoV,WAAWnF,iBAAkBtG,EAAQ4I,WAEvB,OAAhB8K,GAAwC,OAAhBA,QAC3Brd,KAAKoV,WAAWjD,aAAcxI,OAASgJ,GAAW,GAAM,SAGxD3S,KAAKoV,WAAWjD,aAAcxI,OAASgJ,GAAW,QAEnD,GAAKhJ,EAAQuT,WAAaC,KAAKI,WAAa5T,EAAQzC,YAAc,CACxE,MAAM4V,EAA6BhW,SAASE,cAAe,OAC3D8V,EAAc3O,UAAYxE,EAAQzC,kBAC5BlH,KAAKoV,WAAWjD,aAAc2K,OAAenK,GAAW,EAC/D,CACD,CACD,CAOQ8G,kBAAAA,CAAoBtG,GAC3B,MAAMtQ,EAAS7C,KAAK6C,OACdE,EAAQF,EAAOE,MACf2N,EAAO3N,EAAM+D,SAAS6J,UACtByB,EAAWrP,EAAM+D,SAAS2J,UAAUI,kBACpCoF,EAAcjS,MAAMC,KAAMkP,EAAOV,eAAgB+K,MAAQ9J,GAA+B,iBAAfA,EAAM5B,OAEhFpB,GAAQ0B,GACZvP,EAAOE,MAAMqO,QAAQC,IACpB,MAAMoM,EAAexH,GAAayH,WAAavK,EAAOuK,UAChDlH,EAAQzT,EAAM0T,YACnB1T,EAAM4a,uBAAwBjN,EAAM+M,GACpC1a,EAAM4a,uBAAwBjN,EAAM0B,EAASlB,OAE9CG,EAAO+K,OAAQ5F,EAAAA,GAIlB,CAWA,wCAAca,CACb1J,EACAC,EACAmB,GAEA,IACC,MAAMb,EAAUlO,KAAKmV,aAAazH,YAAaC,EAAQC,GACjDgB,EAAUG,EAAkBpB,EAASA,EAAOnJ,MAAO,GACzD,IAAIqK,EAA2C,GAC/C,MAAM+O,EAAW,gCACXrO,EAAO5B,EAAO/H,MAAOgY,GAC3B,GAAK5Z,MAAM6Z,QAAStO,IAAUA,EAAKjL,OAAS,CAC3C,MAAMwZ,EAAevO,EAAKzH,KAAKiC,GACvBA,EAAIzE,QAAS,QAAS,MAE9BuJ,QAAyB7O,KAAKmV,aAAa7F,wBAAyBwO,GACpEjP,EAAmB7O,KAAKmV,aAAa1F,+BAAgC9B,EAAQkB,EAC9E,CAEA,MAAMC,EAA4B,iBAAZZ,EACtB,OAAOlO,KAAKmV,aAAaxG,kBACxBC,EACAV,EACAW,EACAC,EACAC,EAEF,CAAE,MAAQtE,GAET,OADAtK,QAAQsK,MAAOA,GACR,IACR,CACD,ECzpBc,MAAMsT,UAAkBC,EAC/BC,oBAAsB,oBACtBC,uBAAyB,sBACzBC,sBAAwB,YACvBC,kBboB0B,IanB1BC,iBAAmBrd,EAE3BrB,WAAAA,CAAakD,GACZyb,MAAOzb,GAEP,MAAMyJ,EAASzJ,EAAOyJ,OAAOC,IAAK,WAClCvM,KAAKoe,kBAAoB9R,GAAQ8R,mBbaA,IaZjCpe,KAAKqe,iBAAmB/R,GAAQ+R,kBAAoBrd,CACrD,CAEA,qBAAkBud,GACjB,MAAO,WACR,CAEA,mBAAkBC,GACjB,MAAO,CAAEC,EACV,CAMA,IAAAC,GACC,IACCje,EAAeX,YAAcE,KAE7BA,KAAK2e,yBAGL3e,KAAK4e,uBAGL5e,KAAK6e,gBACN,CAAE,MAAQpU,GACTtK,QAAQsK,MAAOA,EAAMvK,QACtB,CACD,CAKA,sBAAAye,GACC,MAAM9b,EAAS7C,KAAK6C,OACd2U,EAAI3U,EAAO2U,EAGjB3U,EAAOE,MAAMC,OAAO8b,SAAU,eAAgB,CAC7CC,eAAgB,SAChBC,UAAU,EACVC,UAAU,EACVC,WAAY,QACZrb,gBAAiB,CAAE,WAIpBhB,EAAOE,MAAMC,OAAOmc,OAAQ,QAAS,CACpCC,QAAS,iBAIVvc,EAAOwc,WAAWC,IAAK,UAAWC,iBAAkB,CACnDxR,KAAM,CACL+D,KAAM,eACN0N,WAAY,CAAE,UAEfzc,MAAO,CAAEyZ,GAAenL,YAChBA,EAAOrK,cAAe,eAAgB,CAC5CuU,MAAOiB,EAAY3K,aAAc,WAGnC4N,kBAAmB,SAGpB5c,EAAOwc,WAAWC,IAAK,YAAaC,iBAAkB,CACrDxc,MAAO,CACN+O,KAAM,eACN0N,WAAY,CAAE,UAEfzR,KAAM,CAAE2R,GAAgBrO,YAChBA,EAAOsO,uBAAwB,eAAgB,CACrDpE,MAAOmE,EAAa7N,aAAc,aAKrC7R,KAAK4f,iBACL5f,KAAK6f,YACL7f,KAAK8f,qBACL9f,KAAK+f,mBAELld,EAAOmd,cAAcC,kBAAmB,CACvCvE,WAAY,CACX,CACCT,MAAOzD,EAAG,mCACV0I,UAAW,QAKdrd,EAAOE,MAAMC,OAAO8b,SAAU,SAAU,CACvCC,eAAgB,SAChBC,UAAU,EACVC,UAAU,EACVC,WAAY,SACZrb,gBAAiB,CAAE,QAGpBhB,EAAOE,MAAMC,OAAOmc,OAAQ,SAAU,CAAEC,QAAS,WAEjDpf,KAAKmgB,0BACL,IAAID,EAAY,GACXhF,EAAIC,QACR+E,EAAY,mBAGRhF,EAAIE,YACR8E,EAAY,oBAEbrd,EAAOmd,cAAcC,kBAAmB,CACvCvE,WAAY,CACX,CACCT,MAAOzD,EAAG,wBACV0I,eAIJ,CAEQC,uBAAAA,GACP,MAAMtd,EAAS7C,KAAK6C,OAEpBA,EAAOwc,WAAWC,IAAK,UAAWC,iBAAkB,CACnDxR,KAAM,CACL+D,KAAM,SACN0N,WAAY,CAAE,OAEfzc,MAAO,CAAEyZ,GAAenL,YAChBA,EAAOrK,cAAe,SAAU,CACtCkG,GAAIsP,EAAY3K,aAAc,UAKjChP,EAAOwc,WAAWC,IAAK,gBAAiBC,iBAAkB,CACzDxc,MAAO,SACPgL,KAAM,CAAE2R,GAAgBrO,YAChBA,EAAOsO,uBAAwB,SAAU,CAC/CzS,GAAIwS,EAAa7N,aAAc,UAKlChP,EAAOwc,WAAWC,IAAK,mBAAoBC,iBAAkB,CAC5Dxc,MAAO,SACPgL,KAAM,CAAE2R,GAAgBrO,aACvB,MAAM+O,EAAY/O,EAAOsO,uBAAwB,SAAU,CAC1DzS,GAAIwS,EAAa7N,aAAc,QAGhC,OAAOwO,EAAUD,EAAW/O,EAAAA,GAG/B,CAWA,gBAAA0O,GACC,MAAMvI,EAAIxX,KAAK6C,OAAO2U,EAChBzU,EAAQ/C,KAAK6C,OAAOE,MACpBud,EAAetgB,KAAK6C,OAAOmL,QAAQD,KAAKjH,SAE9C9G,KAAK6C,OAAOkZ,GAAGwE,iBAAiB7c,IAAK,iBAAiBuL,IACrD,MAAMuR,EAAeC,EAAgBxR,EAAQyR,GAC7CF,EAAajF,MAAQ,sBACrB,MAAMoF,EAAaH,EAAaG,WAChCA,EAAWtF,IAAK,CACfJ,MAAOzD,EAAG,YACVoJ,2uBACAC,SAAS,IAIVF,EAAWnF,GAAI,WAAW,KACzBxb,KAAK6C,OAAOE,MAAMqO,QAAQC,IACzB,MAAMe,EAAWpS,KAAK6C,OAAOE,MAAM+D,SAAS2J,UAAUI,kBACtD,GAAKuB,EAAW,CACf,MAAM0O,EAAuBzP,EAAOrK,cAAe,eAAgB,CAAEuU,MAAO,aAC5ElK,EAAO+C,WAAY,IAAK0M,GACxBzP,EAAOU,OAAQ+O,EAAsB1O,GACrC,MAAM2H,EAAc1I,EAAOG,iBAAkBsP,EAAsB,OACnEzP,EAAOK,aAAcqI,EACtB,KAED/Z,KAAK6C,OAAOmL,QAAQD,KAAKgT,OAAK,IAE/B,MAAMC,EAAW,IAAIC,EAAiBhS,GAChCiS,EAAW,IAAIC,EAAqBlS,GACpCmS,EAAkB,IAAIC,EAAyBpS,EAAQ+R,GAEvDM,EAAmB,IAAIC,EAAkBtS,EAAQuS,GACvDF,EAAiBrG,MAAQzD,EAAG,qBAG5B,MAAMiK,EAAU3a,SAASE,cAAe,OACxCya,EAAQC,UAAY,wBAGpB,MAAMC,EAAW7a,SAASE,cAAe,QACzC2a,EAASD,UAAY,uBACrBC,EAAS1a,6xBACTwa,EAAQG,YAAaD,GAErBL,EAAiBO,UAAUrG,GAAI,SAAS,KACvC,GAAK8F,GAAkBO,WAAWlY,QAAU,CAC3C,MAAMmY,EAASR,EAAiBO,UAAUlY,QAAQ2J,MAAM7N,cACxDzF,KAAK+hB,sBAAuBb,EAAU,SAAUY,EACjD,KAGDxB,EAAa9E,GAAI,mBAAmB,KACnC,MACMhF,EADYzT,EAAM+D,SAAS2J,UACTmG,gBACxB,GAAKJ,EAAQ,CACZ,MAIMwL,IAJehe,MAAMC,KAAMuS,EAAMG,YACrC7O,KAAK4O,GAAQA,EAAgBtG,OAC7BpI,KAAM,IAGRhI,KAAK+hB,sBAAuBb,EAAU,SAAUc,EACjD,KAGDZ,EAAgBa,SAASve,IAAK4d,GAC9BJ,EAAShgB,MAAMwC,IAAK0d,GAEfE,EAAiB3X,SACrB2X,EAAiB3X,QAAQiY,YAAaH,GAGvC,IAAM,MAAMjU,KAASxN,KAAKqe,iBAAmB,CAC5C,MAAM6D,EAAgB,IAAIC,EAAmBlT,GAC7CiS,EAAShgB,MAAMwC,IAAKwe,GAEpB,MAAME,EAAY,IAAIf,EAAyBpS,EAAQ+R,GACjDqB,EAAc,IAAIC,EAA+BrT,GACvDoT,EAAYhH,IAAK,CAChBJ,MAAOzD,EAAGhK,EAAMvM,OAChBsa,MAAO,sBACPgH,WAAW,IAEZH,EAAUH,SAASve,IAAK2e,GACxBnB,EAAShgB,MAAMwC,IAAK0e,GAEpB,IAAM,MAAM1L,KAAQlJ,EAAMtM,MAAQ,CACjC,MAAMshB,EAAe,IAAInB,EAAyBpS,EAAQ+R,GACpDL,EAAa,IAAI2B,EAA+BrT,GACtD0R,EAAWtF,IAAK,CACfJ,MAAOzD,EAAGd,EAAKzV,OACfsa,MAAO,eACPgH,WAAW,IAEZ5B,EAAW8B,SAAU,WAAYC,GAAI1B,GACrCL,EAAWnF,GAAI,WAAW,KACzB,MAAMmH,EAAiB,IAAInO,EAAgBxU,KAAK6C,QAChD7C,KAAK6C,OAAOmL,QAAQD,KAAKgT,QACzB4B,EAAe7M,mBAAoBY,EAAKvV,QAAO,IAEhDqhB,EAAaP,SAASve,IAAKid,GAC3BO,EAAShgB,MAAMwC,IAAK8e,EACrB,CACD,CAEA,OADAhC,EAAaoC,UAAUX,SAASve,IAAKwd,GAC9BV,CAAAA,GAET,CAeA,qBAAAuB,CAA+Bb,EAA+B2B,EAA2BzS,GACxF8Q,EAAShgB,MAAM4G,KAAKgb,IACnB,MAAMnZ,EAAUmZ,EAChB,GAAKnZ,EAAQsY,UAAUc,MAAQ,CAC9B,MAAMC,EAASrZ,EAAQsY,SAASc,MAChC,GAAKC,EAAOzH,MAAQ,CACnB,MAAM0H,EAAUD,EAAOzH,MAAM/Q,SAAU,uBACjC0Y,EAAgBF,EAAOzH,MAAM/Q,SAAU,sBACvC2Y,GAAeH,EAAO/H,MAC5B,IAAMgI,IAAYE,IAAgBD,EAAgB,CACjD,MAAMjI,EAAQ+H,EAAO/H,MAAMxV,cACb,WAATod,IACJlZ,EAAQyZ,WAAahT,GAAQ6K,EAAMzQ,SAAU4F,IAEhC,WAATyS,IACJlZ,EAAQ4Y,UAAYnS,EACpB4S,EAAOT,UAAYnS,EAErB,CACD,CACD,IAEF,CAMA,oBAAAwO,GACC,MAAM/b,EAAS7C,KAAK6C,OACd2U,EAAI3U,EAAO2U,EACXxI,EAAsBnM,EAAOoM,OAAOC,gBACfpO,EACF0J,SAAUwE,IAClChP,KAAKK,oBAAqBmX,EAAG,6BAE/B,CAKA,cAAAqH,GACC,MAAMhc,EAAS7C,KAAK6C,OACdE,EAAQF,EAAOE,MAErBA,EAAM+D,SAAS0U,GAAI,eAAe,KACjCtJ,YAAY,KACXlS,KAAKqjB,+BAA6B,GAChC,GAAA,IAGJtgB,EAAM+D,SAAS2J,UAAU+K,GAAI,gBAAgB,KAC5CtJ,YAAY,KACXlS,KAAKqjB,+BAA6B,GAChC,IACH,MAAMC,EAAYzgB,EAAOE,MAAM+D,SAAS6J,UACxC,GAAK2S,EAAY,CAChB,MAAMC,EAAa1gB,EAAOE,MAAM6Z,cAAe0G,GACzCE,EAA4B,GAClC,IAAM,MAAM9M,KAAQ6M,EAAW5M,WACzBD,EAAKpF,GAAI,UAAW,iBAAoBoF,EAAKnF,SACjDiS,EAAcjY,KAAMmL,GAKtB7T,EAAOE,MAAMqO,QAAQC,IACpB,IAAM,MAAMqF,KAAQ8M,EACnBnS,EAAO+K,OAAQ1F,EAChB,GAEF,KAGD7T,EAAOmL,QAAQD,KAAKjH,SAAS0U,GAAI,UAAU,KAC1Cxb,KAAKyjB,iBAAe,IAGrB3c,SAAS4c,iBAAkB,UAAU,KACpC1jB,KAAKyjB,iBAAe,GAEtB,CAMA,6BAAAJ,GACC,MAEMM,EAFS3jB,KAAK6C,OACCE,MACQ+D,SAAS2J,UAEhCmT,EAAQD,EAAe5Q,oBAAoBI,OAC5CyQ,GAASA,EAAMrS,SACnBvR,KAAKyjB,kBAELvR,YAAYrI,UACX,GAAK+Z,EAAMtS,GAAI,WAAc,CAC5B,MAAM/Q,QAAaP,KAAK6jB,8BACvBD,GAEIrjB,GACJP,KAAK8jB,gBAAiBvjB,EAExB,IACE,MAEHP,KAAKyjB,iBAEP,CAQA,mCAAcI,CACbla,GAEA,MAAM9G,EAAS7C,KAAK6C,OACdkT,EAASlT,EAAOmL,QAAQ+H,OACxBhI,EAAOlL,EAAOmL,QAAQD,KAEtBmI,EAAiBH,EAAOI,cAAexM,GAE7C,GAAKuM,EAAiB,CACrB,MAAM6N,EAAahW,EAAKqI,aAAaC,aAAcH,GACnD,GAAK6N,EACJ,OAAOA,EAAW5M,uBAEpB,CAEA,OAAO,IACR,CAKA,cAAAyI,GACC,MAAM/c,EAAS7C,KAAK6C,OACd2U,EAAI3U,EAAO2U,EACXwM,EAAcld,SAASE,cAAe,KAC5Cgd,EAAY9W,GAAKlN,KAAKie,oBACtB+F,EAAYC,QAAU,KACrBphB,EAAOke,OAAK,EAEbiD,EAAYE,UAAUxgB,IAAK,gBAC3BsgB,EAAY9c,YAAcsQ,EAAG,gCAC7BtF,YAAYrI,UACX,MAAMmS,EAAenZ,EAAOkZ,GAAGhO,KAAKpE,QAC/BqS,GACJA,EAAaE,OAAQ8H,EACtB,GAEF,CAOQF,eAAAA,CAAiBvjB,GACxB,MAAMsC,EAAS7C,KAAK6C,OACdshB,EAAMthB,EAAOkZ,GAAGhO,KAAKpE,SAASsS,cAAe,IAAKjc,KAAKie,uBACvDmG,EAAiBpkB,KAAK6C,OAAOwhB,WAC9BF,GAAO5jB,IAAS6jB,GACpBD,EAAID,UAAUxgB,IAAK,qBACnBygB,EAAIG,MAAMC,KAAO,GAAIhkB,EAAKgkB,SAC1BJ,EAAIG,MAAME,IAAM,GAAIjkB,EAAKikB,SACdL,GACXA,EAAID,UAAU9H,OAAQ,oBAExB,CAKA,eAAAqH,GACC,MAAM5gB,EAAS7C,KAAK6C,OACdshB,EAAMthB,EAAOkZ,GAAGhO,KAAKpE,SAASsS,cAAe,IAAKjc,KAAKie,uBACxDkG,GACJA,EAAID,UAAU9H,OAAQ,oBAExB,CAKA,SAAAyD,GACC,MAAM4E,EAAgB3d,SAASE,cAAe,OAC9Cyd,EAAcvX,GAAKlN,KAAKke,uBACxBuG,EAAcP,UAAUxgB,IAAK,cAC7BoD,SAASiR,KAAK6J,YAAa6C,EAC5B,CAOOnkB,UAAAA,CAAYC,GAClB,MAAM4jB,EAAMrd,SAAS4d,eAAgB1kB,KAAKke,wBACrCiG,GAAO5jB,GACX4jB,EAAIG,MAAMC,KAAO,GAAIhkB,EAAKgkB,KAAO,OACjCJ,EAAIG,MAAME,IAAM,GAAIjkB,EAAKikB,IAAM,OAC/BL,EAAID,UAAUxgB,IAAK,oBACRygB,GACXA,EAAID,UAAU9H,OAAQ,kBAExB,CAKA,UAAA5b,GACC,MAAM2jB,EAAMrd,SAAS4d,eAAgB1kB,KAAKke,wBACrCiG,GACJA,EAAID,UAAU9H,OAAQ,kBAExB,CAKA,kBAAA0D,GACC,MAAM6E,EAAiB7d,SAASE,cAAe,KAC/C2d,EAAezX,GAAKlN,KAAKme,sBACzBwG,EAAeT,UAAUxgB,IAAK,kBAC9BoD,SAASiR,KAAK6J,YAAa+C,EAC5B,CAOOtkB,mBAAAA,CAAqBH,GAC3BC,QAAQC,IAAK,2BAA4BF,GACzC,MAAM2C,EAAS7C,KAAK6C,OACdkL,EAAOlL,GAAQmL,SAASD,MAAME,UAAU1B,IAAK,QAC7CoY,EAAiB7d,SAAS4d,eAC/B1kB,KAAKme,uBAGAyG,EAAa7W,GAAMoJ,wBACpBwN,GAAkBC,IACtBD,EAAeT,UAAUxgB,IAAK,uBAC9BihB,EAAezd,YAAchH,EAC7BgS,YAAY,KACXlS,KAAK6kB,qBAAmB,GACtB7kB,KAAKoe,mBAEV,CAKA,mBAAAyG,GACC,MAAMF,EAAiB7d,SAAS4d,eAC/B1kB,KAAKme,uBAEDwG,GACJA,EAAeT,UAAU9H,OAAQ,sBAEnC,ECvkBc,MAAM0I,UAAuBC,EACnCpC,eAQRhjB,WAAAA,CAAakD,EAAgB8f,GAC5BrE,MAAOzb,GACP7C,KAAK2iB,eAAiBA,CACvB,CAOA,OAAAqC,GAEChlB,KAAKuiB,WAAY,CAClB,CAOA,aAAsB0C,SACfjlB,KAAK2iB,eAAe7M,oBAC3B,EC7Bc,MAAMoP,UAAuBlH,EAC3C,qBAAkBO,GACjB,MAAO,gBACR,CAKA,IAAAG,GACC,MAAM7b,EAAS7C,KAAK6C,OACd8f,EAAiB,IAAInO,EAAgB3R,GAC3CA,EAAOsiB,SAASzhB,IACf,UACA,IAAIohB,EAAgBjiB,EAAQ8f,IAG7B3iB,KAAKolB,uBACN,CAMA,qBAAAA,GACC,MAAMviB,EAAS7C,KAAK6C,OACdE,EAAQF,EAAOE,MACfgT,EAASlT,EAAOmL,QAAQ+H,OACxBhI,EAAOlL,EAAOmL,QAAQD,KAE5BlL,EAAO6Y,WAAWL,IAAK,SAASxR,MAAQwb,EAAGzJ,KAC1C,MAAMxJ,EAAWrP,EAAM+D,SAAS2J,UAAUsC,mBAC1C,GAAKX,EAAW,CACf,MAAMvQ,EAAYuQ,EAASe,OACrB8C,EAAcjS,MAAMC,KAAMpC,EAAU4Q,eAAgB+K,MAAQ9J,GAA+B,iBAAfA,EAAM5B,OAClFoE,EAAiBH,EAAOI,cAAetU,GAC7C,IAAIoH,EACCiN,IACJjN,EACC8E,EAAKqI,aAAaC,aACjBH,IACE/H,YAEqB,iBAAZlF,GAAwBA,EAAQsL,WAAY,MAAW0B,KACpE2F,UACM/Y,EAAOoiB,QAAS,WAExB,IAEF,EC9Cc,MAAMK,UAAgBtH,EAC7BuH,kBAAoB,SACpBC,qBAAuB,6CAE9B7lB,WAAAA,CAAakD,GACZyb,MAAOzb,GAEP,MAAMyJ,EAASzJ,EAAOyJ,OAAOC,IAAK,YAAe,CAAC,EAkB5CkZ,EAAgB,IAhBA,CACrB1iB,MAAO/C,KAAKulB,kBACZ7Q,OAAQ,GACRC,YAAa3U,KAAKwlB,qBAClB5Q,iBAAajC,EACbkC,gBAAiB,KACjBjU,gBAAiBF,EAAcV,KAAKulB,mBAAoB3kB,gBACxD8kB,eAAgBhlB,EAAcV,KAAKulB,mBAAoB1kB,sBACvDiU,cAAe,EACf3M,YAA4E,IAA/DzH,EAAcV,KAAKulB,mBAAoB1kB,sBACpDmU,cAAe,GACf7I,eAAgB,CAAC,EACjBC,WAAW,EACX2I,eAAe,MAG6BzI,GAG7CzJ,EAAOyJ,OAAO+O,IAAK,UAAWoK,GAG9BzlB,KAAK2lB,sBAAuBF,EAC7B,CAEA,mBAAkBjH,GACjB,MAAO,CAAET,EAAWmH,EACrB,CAEA,qBAAkB3G,GACjB,MAAO,SACR,CAEQoH,qBAAAA,CAAuBrZ,GAC9B,IAAMA,EAAOoI,OACZ,MAAM,IAAIzK,MAAO,gCAGlB,GAAKqC,EAAOsI,cAAiBtI,EAAOsI,YAAc,GAAKtI,EAAOsI,YAAc,GAC3E,MAAM,IAAI3K,MAAO,0DAGlB,MAAM2b,EAASllB,EAAc4L,EAAOvJ,OAGpC,QAAgC4P,IAA3BrG,EAAO1L,kBACN0L,EAAO1L,gBAAkBglB,EAAOjlB,iBACpC2L,EAAO1L,gBAAkBglB,EAAOhlB,iBAChC,MAAM,IAAIqJ,MACT,4CAA6C2b,EAAOjlB,uBAC5CilB,EAAOhlB,uBAAyB0L,EAAOvJ,SAMlD,QAA+B4P,IAA1BrG,EAAOoZ,gBACXpZ,EAAOoZ,eAAiBE,EAAO/kB,sBAC/B,MAAM,IAAIoJ,MACT,yCAA0C2b,EAAO/kB,6BACzCyL,EAAOvJ,QAGlB,CAEO2b,IAAAA,GAEP,QC9EYmH,EAAQ,CACpBC","x_google_ignoreList":[3,4,5,6]}