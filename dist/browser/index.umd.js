(function (global, factory) {
	typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('ckeditor5')) :
	typeof define === 'function' && define.amd ? define(['exports', 'ckeditor5'], factory) :
	(global = typeof globalThis !== 'undefined' ? globalThis : global || self, factory(global.AiAgent = {}, global.CKEDITOR));
})(this, (function (exports, ckeditor5) { 'use strict';

	class a{constructor(){}static getInstance(){return a.instance||(a.instance=new a),a.instance}set uiComponent(e){this._uiComponent=e;}showError(e){this._uiComponent&&(console.log("Showing error message...",e),this._uiComponent.showGptErrorToolTip(e));}showLoader(e){this._uiComponent&&this._uiComponent.showLoader(e);}hideLoader(){this._uiComponent&&this._uiComponent.hideLoader();}}const l=a.getInstance(),c={"gpt-3":{min:1,max:4096,context:16385},"gpt-3.5-turbo":{min:1,max:4096,context:16385},"gpt-4":{min:1,max:4096,context:128e3},"gpt-4o":{min:0,max:4096,context:128e3},"gpt-4-turbo":{min:1,max:16384,context:128e3},"gpt-4o-mini":{min:1,max:16384,context:128e3},"kavya-m1":{min:0,max:16384,context:128e3}},d=["en","es","hi","nl"];class h extends ckeditor5.Plugin{constructor(){super(...arguments),this.PLACEHOLDER_TEXT_ID="slash-placeholder",this.GPT_RESPONSE_LOADER_ID="gpt-response-loader",this.GPT_RESPONSE_ERROR_ID="gpt-error";}static get pluginName(){return "AiAgentUI"}static get requires(){return [ckeditor5.Widget]}init(){try{l.uiComponent=this,this.initializeUIComponents(),this.initializeUILanguage(),this.attachListener();}catch(e){console.error(e.message);}}initializeUIComponents(){const e=this.editor,t=e.t;e.model.schema.register("inline-slash",{inheritAllFrom:"$block",isInline:!0,isObject:!0,allowWhere:"$text",allowAttributes:["class"]}),e.model.schema.extend("$text",{allowIn:"inline-slash"}),e.conversion.for("upcast").elementToElement({view:{name:"inline-slash",attributes:["class"]},model:(e,{writer:t})=>t.createElement("inline-slash",{class:e.getAttribute("class")}),converterPriority:"high"}),e.conversion.for("downcast").elementToElement({model:{name:"inline-slash",attributes:["class"]},view:(e,{writer:t})=>t.createContainerElement("inline-slash",{class:e.getAttribute("class")})}),this.addPlaceholder(),this.addLoader(),this.addGptErrorToolTip(),e.ui.componentFactory.add("aiAgentButton",(s=>{ckeditor5.createDropdown(s,ckeditor5.SplitButtonView);const r=new ckeditor5.ButtonView(s);return r.set({label:t("Ai agent"),icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <path d="M4.00815 5.01816H19.3851V10.9145H21.1594V3.2439H2.23389V22.1694H12.3955V20.3951H4.00815V5.01816Z" fill="#222330"/>\n    <path d="M15.1908 20.046L20.9028 12.7065L22.9998 14.3385L17.2878 21.678L15.0341 22.755C14.8582 22.8391 14.6619 22.6862 14.7002 22.4951L15.1908 20.046Z" fill="#222330"/>\n    <path d="M16.1211 8.43794V15.7494H14.5753V8.43794H16.1211Z" fill="#222330"/>\n    <path fill-rule="evenodd" clip-rule="evenodd" d="M8.31458 15.7495H6.65807L9.18211 8.43804H11.1742L13.6947 15.7495H12.0382L11.4968 14.0823H8.85696L8.31458 15.7495ZM10.2067 10.1088L11.1051 12.8756H9.24951L10.1496 10.1088H10.2067Z" fill="#222330"/>\n</svg>',tooltip:!0}),r.on("execute",(()=>{this.editor.model.change((e=>{const t=this.editor.model.document.selection.getLastPosition();if(t){const n=e.createElement("inline-slash",{class:"ck-slash"});e.insertText("/",n),e.insert(n,t);const o=e.createPositionAt(n,"end");e.setSelection(o);}})),e.editing.view.focus();})),r})),e.model.schema.register("ai-tag",{inheritAllFrom:"$block",isInline:!0,isObject:!0,allowWhere:"$block",allowAttributes:["id"]}),e.model.schema.extend("$block",{allowIn:"ai-tag"}),this.addCustomTagConversions();}addCustomTagConversions(){const e=this.editor;e.conversion.for("upcast").elementToElement({view:{name:"ai-tag",attributes:["id"]},model:(e,{writer:t})=>t.createElement("ai-tag",{id:e.getAttribute("id")})}),e.conversion.for("dataDowncast").elementToElement({model:"ai-tag",view:(e,{writer:t})=>t.createContainerElement("ai-tag",{id:e.getAttribute("id")})}),e.conversion.for("editingDowncast").elementToElement({model:"ai-tag",view:(e,{writer:t})=>{const n=t.createContainerElement("ai-tag",{id:e.getAttribute("id")});return ckeditor5.toWidget(n,t)}});}initializeUILanguage(){const e=this.editor,t=e.t,n=e.locale.contentLanguage;d.includes(n)||this.showGptErrorToolTip(t("Unsupported language code"));}attachListener(){const e=this.editor,t=e.model;t.document.on("change:data",(()=>{setTimeout((()=>{this.applyPlaceholderToCurrentLine();}),10);})),t.document.selection.on("change:range",(()=>{setTimeout((()=>{this.applyPlaceholderToCurrentLine();}),10);const t=e.model.document.getRoot();if(t){const n=e.model.createRangeIn(t),o=[];for(const e of n.getItems())e.is("element","inline-slash")&&e.isEmpty&&o.push(e);e.model.change((e=>{for(const t of o)e.remove(t);}));}})),e.editing.view.document.on("scroll",(()=>{this.hidePlaceHolder();})),document.addEventListener("scroll",(()=>{this.hidePlaceHolder();}));}applyPlaceholderToCurrentLine(){var e;const t=null===(e=this.editor.model.document.selection.getFirstPosition())||void 0===e?void 0:e.parent;t&&t.isEmpty?(this.hidePlaceHolder(),setTimeout((async()=>{if(t.is("element")){const e=await this.getRectDomOfGivenModelElement(t);e&&this.showPlaceHolder(e);}}),100)):this.hidePlaceHolder();}async getRectDomOfGivenModelElement(e){const t=this.editor,n=t.editing.mapper,o=t.editing.view,i=n.toViewElement(e);if(i){const e=o.domConverter.mapViewToDom(i);if(e)return e.getBoundingClientRect()}return null}addPlaceholder(){const e=this.editor,t=e.t,n=document.createElement("p");n.id=this.PLACEHOLDER_TEXT_ID,n.onclick=()=>{e.focus();},n.classList.add("place-holder"),n.textContent=t("Type / to request AI content"),document.body.appendChild(n);}showPlaceHolder(e){const t=document.getElementById(this.PLACEHOLDER_TEXT_ID),n=this.editor.isReadOnly;t&&e&&!n?(t.classList.add("show-place-holder"),t.style.left=`${e.left}px`,t.style.top=`${e.top}px`):t&&t.classList.remove("show-place-holder");}hidePlaceHolder(){const e=document.getElementById(this.PLACEHOLDER_TEXT_ID);e&&e.classList.remove("show-place-holder");}addLoader(){const e=document.createElement("div");e.id=this.GPT_RESPONSE_LOADER_ID,e.classList.add("gpt-loader"),document.body.appendChild(e);}showLoader(e){const t=document.getElementById(this.GPT_RESPONSE_LOADER_ID);t&&e?(t.style.left=`${e.left+10}px`,t.style.top=`${e.top+10}px`,t.classList.add("show-gpt-loader")):t&&t.classList.remove("show-gpt-loader");}hideLoader(){const e=document.getElementById(this.GPT_RESPONSE_LOADER_ID);e&&e.classList.remove("show-gpt-loader");}addGptErrorToolTip(){const e=document.createElement("p");e.id=this.GPT_RESPONSE_ERROR_ID,e.classList.add("response-error"),document.body.appendChild(e);}showGptErrorToolTip(e){var t,n,o;console.log("Showing error message...",e);const i=this.editor,s=null===(o=null===(n=null===(t=null==i?void 0:i.editing)||void 0===t?void 0:t.view)||void 0===n?void 0:n.domRoots)||void 0===o?void 0:o.get("main"),r=document.getElementById(this.GPT_RESPONSE_ERROR_ID),a=null==s?void 0:s.getBoundingClientRect();r&&a&&(r.classList.add("show-response-error"),r.textContent=e,setTimeout((()=>{this.hideGptErrorToolTip();}),2e3));}hideGptErrorToolTip(){const e=document.getElementById(this.GPT_RESPONSE_ERROR_ID);e&&e.classList.remove("show-response-error");}}class u extends ckeditor5.Command{constructor(e,t){super(e),this.aiAgentService=t;}refresh(){this.isEnabled=!0;}async execute(){await this.aiAgentService.handleSlashCommand();}}var m,p={},g={endsWithChar:function(e,t){return t.length>1?t.indexOf(e.slice(-1))>-1:e.slice(-1)===t},endsWith:function(e,t){return e.slice(e.length-t.length)===t}},f={},v=["al","adj","assn","Ave","BSc","MSc","Cell","Ch","Co","cc","Corp","Dem","Dept","ed","eg","Eq","Eqs","est","est","etc","Ex","ext","Fig","fig","Figs","figs","i.e","ie","Inc","inc","Jan","Feb","Mar","Apr","Jun","Jul","Aug","Sep","Sept","Oct","Nov","Dec","jr","mi","Miss","Mrs","Mr","Ms","Mol","mt","mts","no","Nos","PhD","MD","BA","MA","MM","pl","pop","pp","Prof","Dr","pt","Ref","Refs","Rep","repr","rev","Sec","Secs","Sgt","Col","Gen","Rep","Sen","Gov","Lt","Maj","Capt","St","Sr","sr","Jr","jr","Rev","Sun","Mon","Tu","Tue","Tues","Wed","Th","Thu","Thur","Thurs","Fri","Sat","trans","Univ","Viz","Vol","vs","v"];f.setAbbreviations=function(e){m=e||v;};var w=f.isCapitalized=function(e){return /^[A-Z][a-z].*/.test(e)||b(e)};f.isSentenceStarter=function(e){return w(e)||/``|"|'/.test(e.substring(0,2))},f.isCommonAbbreviation=function(e){var t=e.replace(/[-'`~!@#$%^&*()_|+=?;:'",.<>\{\}\[\]\\\/]/gi,"");return ~m.indexOf(t)},f.isTimeAbbreviation=function(e,t){if(("a.m."===e||"p.m."===e)&&"day"===t.replace(/\W+/g,"").slice(-3).toLowerCase())return !0;return !1},f.isDottedAbbreviation=function(e){var t=e.replace(/[\(\)\[\]\{\}]/g,"").match(/(.\.)*/);return t&&t[0].length>0},f.isCustomAbbreviation=function(e){return e.length<=3||w(e)},f.isNameAbbreviation=function(e,t){return t.length>0&&(!!(e<5&&t[0].length<6&&w(t[0]))||t.filter((function(e){return /[A-Z]/.test(e.charAt(0))})).length>=3)};var b=f.isNumber=function(e,t){return t&&(e=e.slice(t-1,t+2)),!isNaN(e)};f.isPhoneNr=function(e){return e.match(/^(?:(?:\+?1\s*(?:[.-]\s*)?)?(?:\(\s*([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9])\s*\)|([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9]))\s*(?:[.-]\s*)?)?([2-9]1[02-9]|[2-9][02-9]1|[2-9][02-9]{2})\s*(?:[.-]\s*)?([0-9]{4})(?:\s*(?:#|x\.?|ext\.?|extension)\s*(\d+))?$/)},f.isURL=function(e){return e.match(/[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/)},f.isConcatenated=function(e){var t=0;if(((t=e.indexOf("."))>-1||(t=e.indexOf("!"))>-1||(t=e.indexOf("?"))>-1)&&e.charAt(t+1).match(/[a-zA-Z].*/))return [e.slice(0,t),e.slice(t+1)];return !1},f.isBoundaryChar=function(e){return "."===e||"!"===e||"?"===e};var T=function(e,t){if(("string"==typeof e||e instanceof String)&&"undefined"!=typeof document){var n=document.createElement("DIV");n.innerHTML=e,e=(n.textContent||"").trim();}else "object"==typeof e&&e.textContent&&(e=(e.textContent||"").trim());return e},E=g,y=f,A=" @~@ ",x=A.trim(),C=new RegExp("\\S",""),P=new RegExp("\\n+|[-#=_+*]{4,}","g"),L=new RegExp("\\S+|\\n","g");p.sentences=function(e,t){if(!e||"string"!=typeof e||!e.length)return [];if(!C.test(e))return [];var n,o,i={newline_boundaries:!1,html_boundaries:!1,html_boundaries_tags:["p","div","ul","ol"],sanitize:!1,allowed_tags:!1,preserve_whitespace:!1,abbreviations:null};if("boolean"==typeof t)i.newline_boundaries=!0;else for(var s in t)i[s]=t[s];if(y.setAbbreviations(i.abbreviations),i.newline_boundaries&&(e=e.replace(P,A)),i.html_boundaries){var r="(<br\\s*\\/?>|<\\/("+i.html_boundaries_tags.join("|")+")>)",a=new RegExp(r,"g");e=e.replace(a,"$1"+A);}(i.sanitize||i.allowed_tags)&&(i.allowed_tags||(i.allowed_tags=[""]),e=T(e,{allowedTags:i.allowed_tags}));var l=0,c=0,d=[],h=[],u=[];if(!(n=i.preserve_whitespace?(o=e.split(/(<br\s*\/?>|\S+|\n+)/)).filter((function(e,t){return t%2})):e.trim().match(L))||!n.length)return [];for(var m=0,p=n.length;m<p;m++)if(l++,u.push(n[m]),~n[m].indexOf(",")&&(l=0),y.isBoundaryChar(n[m])||E.endsWithChar(n[m],"?!")||n[m]===x)(i.newline_boundaries||i.html_boundaries)&&n[m]===x&&u.pop(),h.push(u),l=0,u=[];else if((E.endsWithChar(n[m],'"')||E.endsWithChar(n[m],"”"))&&(n[m]=n[m].slice(0,-1)),E.endsWithChar(n[m],".")){if(m+1<p){if(2===n[m].length&&isNaN(n[m].charAt(0)))continue;if(y.isCommonAbbreviation(n[m]))continue;if(y.isSentenceStarter(n[m+1])){if(y.isTimeAbbreviation(n[m],n[m+1]))continue;if(y.isNameAbbreviation(l,n.slice(m,6)))continue;if(y.isNumber(n[m+1])&&y.isCustomAbbreviation(n[m]))continue}else {if(E.endsWith(n[m],".."))continue;if(y.isDottedAbbreviation(n[m]))continue;if(y.isNameAbbreviation(l,n.slice(m,5)))continue}}h.push(u),u=[],l=0;}else {if((c=n[m].indexOf("."))>-1){if(y.isNumber(n[m],c))continue;if(y.isDottedAbbreviation(n[m]))continue;if(y.isURL(n[m])||y.isPhoneNr(n[m]))continue}(d=y.isConcatenated(n[m]))&&(u.pop(),u.push(d[0]),h.push(u),l=0,(u=[]).push(d[1]));}return u.length&&h.push(u),(h=h.filter((function(e){return e.length>0}))).slice(1).reduce((function(e,t){var n=e[e.length-1];return 1===n.length&&/^.{1,2}[.]$/.test(n[0])&&!/[.]/.test(t[0])?(e.pop(),e.push(n.concat(t)),e):(e.push(t),e)}),[h[0]]).map((function(e,t){if(i.preserve_whitespace&&!i.newline_boundaries&&!i.html_boundaries){var n=2*e.length;return 0===t&&(n+=1),o.splice(0,n).join("")}return e.join(" ")}))};class S{constructor(e){var t,n,o,i,s,r,a;this.editor=e;const l=e.config.get("aiAgent");this.contextSize=l.contextSize,this.responseOutputFormat=null!==(n=null===(t=l.promptSettings)||void 0===t?void 0:t.outputFormat)&&void 0!==n?n:[],this.responseContextData=null!==(i=null===(o=l.promptSettings)||void 0===o?void 0:o.contextData)&&void 0!==i?i:[],this.responseFilters=null!==(r=null===(s=l.promptSettings)||void 0===s?void 0:s.filters)&&void 0!==r?r:[],this.debugMode=null!==(a=l.debugMode)&&void 0!==a&&a;}getSystemPrompt(e=!1){const t=[];t.push('You will be provided with a partially written article with """@@@cursor@@@""" somewhere \n\t\t\tunder a CONTEXT section, user input under a TASK section, and sometimes there will be articles \n\t\t\t(delimited with marked-up language) separated by Starting Markdown Content ${ number } and \n\t\t\tEnding Markdown Content ${ index } with certain instructions to follow while generating a response \n\t\t\tunder an INSTRUCTION section'),t.push('If there is an article with """Stating Markdown Content""", your task is to \n\t\t\tuse that provided information solely to respond to the user request in the TASK section.'),t.push("Follow these step-by-step instructions to respond to user inputs:"),t.push("Step 1 - Summarize information under the CONTEXT section, set a tone for the article, and \n\t\t\tlater use that summarized information to generate a response"),t.push('Step 2: If there is an article with """Stating Markdown Content""", \n\t\t\tbreak it into derived sections and eliminate unnecessary information \n\t\t\tthat does not relate to the context and user prompt.'),t.push("Final Step - use all summarized information to respond to user input under the TASK section"),t.push("While generating the response, adhere to the following rules:"),t.push('1. Provide only the new text content that should replace "@@@cursor@@@" based on the context above, \n\t\t\tensuring that the response must primarily based on the request.'),t.push("2. Avoid including any part of the context in the output at any cost, \n\t\t\texcept for necessary glimpses that enhance the response."),t.push("3. Ensure response adheres to the specified tone or style, such as \n\t\t\tformal, informal, or technical, as appropriate for the context."),t.push("4. Do not use any markdown formatting in your response. (e.g., **, ##, ###, ---, ===, ____)."),t.push("5. Use a relaxed, formal or informal tone based on the summary of context with lots of personal touches. \n\t\t\tFeel free to include spontaneous thoughts, offhand comments, or quirky observations."),t.push("6. Vary sentence lengths and styles—include fragments, casual interjections, \n\t\t\tand minor grammar slips, but avoid spelling mistakes."),t.push("7. Add in personal anecdotes or emotional reactions to make it sound like a genuine conversation."),t.push("8. Avoid overly polished language or structured sentences, aim for a natural and solely human-like tone."),e&&t.push("9: Determine from the context, task, and the position of the @@@cursor@@@ whether the request \n\t\t\t\tinvolves list items, table cells, or inline content.\n\t\t\t\t- List items: Format each item as <li> within an <ol> or <ul> as appropriate.\n\t\t\t\t- Table cells: Present each item in plain text, wrapping it within <p> tags.\n\t\t\t\t- Inline content: Wrap entire response in a single <p> tag, ensuring it fits seamlessly within the existing paragraph or \n\t\t\t\tsentence structure where the @@@cursor@@@ is located.\n\t\t\t\tStrictly adherence to these rules is mandatory to avoid errors, based on where the @@@cursor@@@ is placed within content."),t.push("Above are the rules apply every time, but below will only be applied if markdown content is present"),t.push("1. Extract each content as plain text without any special formatting, emphasis, or markdown"),t.push("2. The response should synthesize information from both the editor content and the fetched sources, maintaining a balance between them."),t.push("3. Highlight key points from the fetched sources while ensuring that the context from the editor is acknowledged and integrated where relevant."),t.push("4. Clearly differentiate between the information derived from the editor content and that from the fetched sources to avoid confusion."),t.push("When generating content, adhere to the following HTML-specific rules:"),t.push("1. Generate an HTML snippet, not a full HTML document."),t.push("2. You are an HTML generator. When providing HTML code, ensure it follows standard HTML norms and best practices."),t.push("4. Block-level elements (e.g., <p>, <div>, <section>) must not contain other block-level elements."),t.push("5. Ensure valid nesting of elements."),t.push("6. Use the following allowed HTML tags:"),t.push(`${this.getAllowedHtmlTags().join(", ")}`),t.push("7. Do not include any HTML, HEAD, or BODY tags."),t.push("8. Ensure all HTML tags are properly closed and nested."),t.push("9. Do not include any HTML, HEAD, or BODY tags."),t.push("10. Avoid using inline styles or class attributes unless specifically requested."),t.push("11. Provide clean, valid HTML that adheres to best practices and is ready for use in web development."),t.push("12. Beginning word of response must be a valid html tag"),this.getAllowedHtmlTags().includes("img")&&(t.push("13. For image elements, follow these strict formatting rules:"),t.push("    a. Every <img> tag MUST include both src and alt attributes"),t.push("    b. Format the src URL exactly as: https://placehold.co/600x400?text=[alt_text]"),t.push("    c. The [alt_text] in the src URL must:"),t.push("       - Be identical to the alt attribute value"),t.push("       - Replace spaces with + characters"),t.push("       - Exclude any special characters"),t.push("    d. Example:"),t.push('       <img src="https://placehold.co/600x400?text=Beautiful+Sunset" alt="Beautiful Sunset">'));const n=t.join("\n");return this.debugMode&&(console.group("AiAgent System Prompt Debug"),console.log("System Prompt:"),console.log(n),console.groupEnd()),n}formatFinalPrompt(e,t,n,o){const i=this.editor.locale.contentLanguage,s=[];if(s.push("CONTEXT:"),s.push(`\n"""\n${t}\n"""\n`),s.push("\n\nTASK:\n\n"),s.push(`"""\n${e}\n"""\n`),n.length&&(s.push("Refer to following markdown content as a source of information, but generate new text that fits the given context & task."),n.forEach(((e,t)=>{s.push(`\n\n------------ Stating Markdown Content ${t+1} ------------\n\n`),s.push(e.content),s.push(`\n\n------------ Ending Markdown Content ${t+1} ------------\n\n`);}))),s.push("\n\nINSTRUCTIONS:\n\n"),s.push(`The response must follow the language code - ${i}.`),this.responseOutputFormat.length&&s.push(...this.responseOutputFormat),n.length&&(s.push("Use information from provided markdown content to generate new text, but do not copy it verbatim."),s.push("Ensure the new text flows naturally with the existing context and integrates smoothly."),s.push('Do not use any markdown formatting in your response. specially for title and list item like """**Performance**""" is not acceptable where as """performance""" is.'),s.push("consider whole markdown of single source as content and then generate % content requested")),this.responseFilters.length)s.push(...this.responseFilters);else {const e=["The response should directly follow the context, avoiding any awkward transitions or noticeable gaps."];s.push(...e);}if(!o){const e=["Ensure the inserted content maintains a seamless connection with the surrounding text,","making the transition smooth and natural.",'Do not modify the original text except to replace the "@@@cursor@@@" placeholder with the generated content.'];s.push(...e);}return this.responseContextData.length&&s.push(...this.responseContextData),this.debugMode&&(console.group("AiAgent Prompt Debug"),console.log("User Prompt:",e),console.log("Generated GPT Prompt:"),console.log(s.join("\n")),console.groupEnd()),s.join("\n")}trimContext(e,t=""){var n,o,i,s;let r="",a="";const l=null!=t?t:e,c=this.editor,d=null===(i=null===(o=null===(n=null==c?void 0:c.editing)||void 0===n?void 0:n.view)||void 0===o?void 0:o.domRoots)||void 0===i?void 0:i.get("main"),h=null!==(s=null==d?void 0:d.innerText)&&void 0!==s?s:"",u=h.indexOf(l),m=h.indexOf("\n",u),p=-1!==m?m:u+l.length,g=[h.substring(0,p),h.substring(p+1)],f=Math.floor(.3*this.contextSize);g.length>1&&(g[0].length<g[1].length?(r=this.extractEditorContent(g[0],f/2,!0),a=this.extractEditorContent(g[1],f-r.length/4)):(a=this.extractEditorContent(g[1],f/2),r=this.extractEditorContent(g[0],f-a.length/4,!0)));const v=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");r=r.trim().replace(new RegExp(v.slice(1)),"@@@cursor@@@");return `${r}\n${a}`.trim()}allocateTokensToFetchedContent(e,t){var n,o,i,s,r,a;const l=null!==(a=null===(r=null===(s=null===(i=null===(o=null===(n=this.editor)||void 0===n?void 0:n.editing)||void 0===o?void 0:o.view)||void 0===i?void 0:i.domRoots)||void 0===s?void 0:s.get("main"))||void 0===r?void 0:r.innerText)&&void 0!==a?a:"",c=Math.min(Math.floor(.3*this.contextSize),this.countTokens(l));let d=this.contextSize-c;t=t.map((e=>({...e,availableToken:this.countTokens(e.content)}))).sort(((e,t)=>{var n,o;return (null!==(n=e.availableToken)&&void 0!==n?n:0)-(null!==(o=t.availableToken)&&void 0!==o?o:0)}));let h=d/t.length;return t.map(((e,n)=>(e.availableToken&&e.availableToken<=h?(e.tokenToRequest=e.availableToken,d-=e.availableToken):e.availableToken&&(e.tokenToRequest=h,d-=h),h=d/(t.length-(n+1)),e.tokenToRequest&&(e.content=this.trimLLMContentByTokens(e.content,e.tokenToRequest)),e)))}async generateMarkDownForUrls(e){const t=this.editor.t;let n;const o=await Promise.all(e.map((async e=>({content:await this.fetchUrlContent(e),url:e})))),i=o.filter((e=>!(null==e?void 0:e.content)));if(i.length){throw n=t("Failed to fetch content of : %0",null==i?void 0:i.map((e=>null==e?void 0:e.url)).join(",")),n&&l.showError(n),new Error("Unable to fetch content for few urls")}return o.filter((e=>null!==e))}async fetchUrlContent(e){const t=e.trim();if(!/^(https?|ftp):\/\/[^\s/$.?#].[^\s]*$/i.test(t))throw new Error("Invalid URL");try{const e=`https://r.jina.ai/${t.replace(/[^\x20-\x7E]/g,"").trim()}`,n=await fetch(e.trim(),{headers:{"X-With-Generated-Alt":"true"}});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=await n.text();if(o.includes("Warning: Target URL returned error"))throw new Error(`Target URL (${t}) returned an error`);if(0===o.trim().length)throw new Error("Empty content received");return o.replace(/\(https?:\/\/[^\s]+\)/g,"").replace(/^\s*$/gm,"").trim()}catch(t){return console.error(`Failed to fetch content: ${e}`,t),""}}countTokens(e){if(!e||"string"!=typeof e)return 0;const t=e.trim().replace(/\s+/g," ").match(/\b\w+('\w+)?\b|[.,!?;:"(){}[\]]/g)||[];let n=0;return t.forEach((e=>{e.length>10?n+=Math.ceil(e.length/4):n+=1;})),n}trimLLMContentByTokens(e,t){const n=e.split("\n");let o=0,i="";for(const e of n){const n=this.countTokens(e);if(o+n>t)break;o+=n,i+=e+"\n";}return i}getAllowedHtmlTags(){const e=this.editor.model.schema.getDefinitions(),t=Object.keys(e).sort(),n={blockQuote:"blockquote",caption:"figcaption",codeBlock:"pre",heading1:"h1",heading2:"h2",heading3:"h3",imageBlock:"img",imageInline:"img",paragraph:"p",table:"table",tableCell:"td",tableRow:"tr",$listItem:"li",horizontalLine:"hr"},o={bold:"strong",italic:"em",code:"code",strikethrough:"s",subscript:"sub",superscript:"sup",underline:"u",linkHref:"a"},i=new Set;t.forEach((e=>{e in n&&i.add(n[e]);}));const s=e.$text;return s&&s.allowAttributes&&s.allowAttributes.forEach((e=>{e in o&&i.add(o[e]);})),i.has("li")&&(i.add("ul"),i.add("ol")),Array.from(i).sort()}extractEditorContent(e,t,n=!1){let o="",i=0;const s=p.sentences(e,{preserve_whitespace:!0,html_boundaries:!0,allowed_tags:["blockquote","figcaption","pre","h2","h1","h3","img","p","table","td","tr","li","hr","br"]}),r=n?s.reverse():s;for(const e of r){const s=e.length;if(!((i+s)/4<=t))break;o=n?e+o:o+e,i+=s;}return o.trim()}}class k{constructor(e){this.editor=e,this.model=e.model;}async insertSimpleHtml(e){var t;console.log("Attempting to insert simple HTML:",e);const n=this.editor.data.processor.toView(e),o=this.editor.data.toModel(n,"$root"),i=this.model.document.selection,s=this.model.document.getRoot();let r=i.getLastPosition();const a=o.getChild(o.childCount-1),l=null===(t=i.getLastPosition())||void 0===t?void 0:t.path[0],c=null==s?void 0:s.getChild(null!=l?l:0);this.model.change((e=>{if((null==c?void 0:c.is("element"))&&(r=c.isEmpty?e.createPositionAt(c,"end"):e.createPositionAfter(c)),r&&s){e.setSelection(r),this.model.insertContent(o,r);let t=null==a?void 0:a.getAttribute("listItemId");if((null==a?void 0:a.is("element"))&&(t=t||"table"===a.name),t&&a){const t=e.createElement("paragraph");e.insert(t,e.createPositionAfter(a)),e.setSelection(t,"in");}else a&&e.setSelection(e.createPositionAfter(a));}})),await new Promise((e=>setTimeout(e,100)));}async insertAsText(e,t,n=!1,o=!1){const i=this.editor.data.processor.toView(e.outerHTML),s=this.editor.data.toModel(i,"$root"),r=Array.from(s.getChildren()),a=this.model.document.getRoot();for(const[e,o]of r.entries())if(o.is("element")){const i=0===e?t:void 0;n?await this.insertElementAsStream(o,i):await this.batchInsertOfElement(o,i);}o&&this.model.change((e=>{const t=this.model.document.selection.getLastPosition(),n=null==t?void 0:t.path[0];if(a&&null!=n){const t=e.createElement("paragraph");e.insert(t,a,n+1),e.setSelection(t,"in");}}));}async batchInsertOfElement(e,t){var n;const o=this.model.document.selection,i=this.model.document.getRoot();let s=t;if(!t){const e=null===(n=o.getFirstPosition())||void 0===n?void 0:n.path[0],t=null==i?void 0:i.getChild(null!=e?e:0);(null==t?void 0:t.is("element"))&&(s=t.isEmpty?this.model.createPositionAt(t,"end"):this.model.createPositionAfter(t));}this.model.change((t=>{this.model.insertContent(e,s),t.setSelection(e,"end");}));}async insertElementAsStream(e,t){const n=this.model.document.selection,o=this.model.document.getRoot(),i=n.getLastPosition();let s,r=t;if(t){const e=null==i?void 0:i.parent;(null==e?void 0:e.is("element"))&&(s=e);}else {const t=null==i?void 0:i.path[0],n=null==o?void 0:o.getChild(null!=t?t:0);(null==n?void 0:n.is("element"))&&(r=n.isEmpty?this.model.createPositionAt(n,"end"):this.model.createPositionAfter(n)),this.model.change((t=>{s=t.createElement(e.name);for(const[t,n]of e.getAttributes())s._setAttribute(t,n);this.model.insertContent(s,r),r&&t.setSelection(s,"end");}));}const a=Array.from(e.getChildren()).filter((e=>e.is("$text")));for(const e of a){if(!e.is("$text"))continue;const t=Array.from(e.getAttributes()),n=e._data;for(const e of n)await new Promise((n=>{this.model.change((n=>{const o=this.editor.model.document.selection.getLastPosition(),i=o.getShiftedBy(1).offset===(null==o?void 0:o.parent.maxOffset);n.insertText(e,t,s,i?"end":null==o?void 0:o.offset),n.setSelection(this.editor.model.document.selection.getLastPosition());})),setTimeout(n,5);}));}t||this.model.change((e=>{e.setSelection(s,"end");}));}isCompleteHtmlChunk(e){if((e.match(/<[^/][^>]*>/g)||[]).length!==(e.match(/<\/[^>]+>/g)||[]).length)return !1;if(e.includes("<")&&!e.includes(">"))return !1;const t=e.trim();return !(!t.startsWith("<")||!t.endsWith(">"))}}class _{constructor(e){var t,n;this.aiAgentFeatureLockId=Symbol("ai-agent-feature"),this.buffer="",this.openTags=[],this.isInlineInsertion=!1,this.editor=e,this.promptHelper=new S(e),this.htmlParser=new k(e);const o=e.config.get("aiAgent");this.aiModel=o.model,this.apiKey=o.apiKey,this.endpointUrl=o.endpointUrl,this.temperature=o.temperature,this.timeOutDuration=null!==(t=o.timeOutDuration)&&void 0!==t?t:45e3,this.maxTokens=o.maxTokens,this.retryAttempts=o.retryAttempts,this.stopSequences=o.stopSequences,this.streamContent=null===(n=o.streamContent)||void 0===n||n;}async handleSlashCommand(){const e=this.editor,t=e.model,n=e.editing.mapper,o=e.editing.view,i=t.document.getRoot();let s,r,a;const c=t.document.selection.getLastPosition();if(c&&i){a=c.parent;const e="inline-slash"===a.name?a:void 0,l=n.toViewElement(a);if(r=l?o.domConverter.mapViewToDom(l):void 0,e){this.isInlineInsertion=!0;const n=e.getPath(),a=null==c?void 0:c.path,d=t.createPositionFromPath(i,n),h=t.createPositionFromPath(i,a),u=t.createRange(d,h);r=(null==l?void 0:l.parent)?o.domConverter.mapViewToDom(l.parent):void 0,s="";for(const e of u.getItems())e.is("$textProxy")&&(s+=e.data.trim());}else r&&(s=null==r?void 0:r.innerText);}try{const e=window.getSelection(),t=(null==e?void 0:e.getRangeAt(0)).getBoundingClientRect();l.showLoader(t);const n=await this.generateGptPromptBasedOnUserPrompt(null!=s?s:"",null==r?void 0:r.innerText);a&&n&&await this.fetchAndProcessGptResponse(n,a);}catch(e){throw console.error("Error handling slash command:",e),e}finally{this.isInlineInsertion=!1,l.hideLoader();}}async fetchAndProcessGptResponse(e,t,n=this.retryAttempts){var o,i,s;console.log("Starting fetchAndProcessGptResponse");const r=this.editor,a=r.t,c=new AbortController,d=setTimeout((()=>c.abort()),this.timeOutDuration);let h="",u="";const m=`ai-${(new Date).getTime()}`;try{const n=await fetch(this.endpointUrl,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.aiModel,messages:[{role:"system",content:this.promptHelper.getSystemPrompt(this.isInlineInsertion)},{role:"user",content:e}],temperature:this.temperature,max_tokens:this.maxTokens,stop:this.stopSequences,stream:!0}),signal:c.signal});if(clearTimeout(d),!n.ok)throw new Error("Fetch failed");l.hideLoader();const s=n.body.getReader(),a=new TextDecoder("utf-8");this.clearParentContent(t),this.editor.enableReadOnlyMode(this.aiAgentFeatureLockId);let p=!0;for(r.model.change((e=>{var t;const n=r.model.document.selection.getLastPosition();if(n){const o=e.createElement("ai-tag",{id:m}),i=n.parent;i&&("tableCell"===(null===(t=i.parent)||void 0===t?void 0:t.name)||"bulleted"===i.getAttribute("listType"))&&(p=!1);let s="";for(const e of i.getChildren())e.is("$text")&&(s+=e.data);const r=s?e.createPositionAfter(i):e.createPositionBefore(i);e.insert(o,p?r:n);const a=e.createPositionAt(o,"end");e.setSelection(a);}})),console.log("Starting to process response");;){const{done:e,value:t}=await s.read();if(e){console.log("Finished reading response");break}let n;for(h+=a.decode(t,{stream:!0});-1!==(n=h.indexOf("\n"));){const e=h.slice(0,n).trim();if(h=h.slice(n+1),e.startsWith("data: ")){const t=e.slice(5).trim();if("[DONE]"===t){console.log("Received [DONE] signal");break}try{const e=null===(i=null===(o=JSON.parse(t).choices[0])||void 0===o?void 0:o.delta)||void 0===i?void 0:i.content;null!=e&&(u+=e),await this.updateContent(u,m,p);}catch(e){console.warn("Error parsing JSON:",e);}}}}let g=r.getData().replace(`<ai-tag id="${m}">`,"");g=g.replace("</ai-tag>",""),r.setData(g);}catch(o){console.error("Error in fetchAndProcessGptResponse:",o);const i=((null==o?void 0:o.message)||"").trim()||((null==o?void 0:o.name)||"").trim(),r=["AbortError","ReadableStream not supported","AiAgent: Fetch failed"].includes(i);if(n>0&&r)return console.warn(`Retrying... (${n} attempts left)`),await this.fetchAndProcessGptResponse(e,t,n-1);let c;if("ReadableStream not supported"===((null==o?void 0:o.name)||(null===(s=null==o?void 0:o.message)||void 0===s?void 0:s.trim())))c=a("Browser does not support readable streams");else c=a("We couldn't connect to the AI. Please check your internet");l.showError(c);}finally{this.editor.disableReadOnlyMode(this.aiAgentFeatureLockId);}}async updateContent(e,t,n){const o=this.editor;o.model.change((i=>{const s=o.model.document.getRoot();let r=null;if(s){for(const e of s.getChildren()){const o=e;if(n){if(o.is("element","ai-tag")&&o.getAttribute("id")===t){r=o;break}}else for(const e of o.getChildren())if(e.is("element","ai-tag")&&e.getAttribute("id")===t){r=e;break}}if(r){const t=o.model.createRangeIn(r);i.remove(t);const n=o.data.processor.toView(e),s=o.data.toModel(n);i.insert(s,r,"end");}}})),await new Promise((e=>setTimeout(e)));}async processContent(e){try{if(console.log("--- Start of processContent ---"),console.log("Processing content:",e,this.isInlineInsertion),this.isInlineInsertion){const t=this.editor.model.document.selection.getLastPosition(),n=document.createElement("div");n.innerHTML=e,await this.htmlParser.insertAsText(n||"",null!=t?t:void 0,this.streamContent);}else this.streamContent?await this.proceedHtmlResponse(e):await this.htmlParser.insertSimpleHtml(e);console.log("--- End of processContent ---");}catch(e){console.error(e);}}async proceedHtmlResponse(e){const t=document.createElement("div");t.innerHTML=e;for(const e of Array.from(t.childNodes)){const t=e;if(t.nodeType===Node.ELEMENT_NODE){const e=t.tagName.toLowerCase();["table","blockquote","pre","img","form","figure"].includes(e)?await this.htmlParser.insertSimpleHtml(t.outerHTML):"ul"===e||"ol"===e?await this.htmlParser.insertAsText(t,void 0,!0,!0):await this.htmlParser.insertAsText(t,void 0,!0);}else if(t.nodeType===Node.TEXT_NODE&&t.textContent){const e=document.createElement("div");e.innerText=t.textContent,await this.htmlParser.insertAsText(e,void 0,!0);}}}clearParentContent(e){const t=this.editor,n=t.model,o=n.document.getRoot(),i=n.document.selection.getLastPosition(),s=Array.from(e.getChildren()).find((e=>"inline-slash"===e.name));o&&i&&t.model.change((t=>{const r=(null==s?void 0:s.getPath())||e.getPath(),a=n.createRange(n.createPositionFromPath(o,r),n.createPositionFromPath(o,i.path));t.remove(a),t.setSelection(n.createPositionFromPath(o,r));}));}async generateGptPromptBasedOnUserPrompt(e,t){try{const n=this.promptHelper.trimContext(e,t),o=e.slice(1);let i=[];const s=/https?:\/\/[^\s/$.?#].[^\s]*/g,r=e.match(s);if(Array.isArray(r)&&r.length){const t=r.map((e=>e.replace(/[,.]$/,"")));i=await this.promptHelper.generateMarkDownForUrls(t),i=this.promptHelper.allocateTokensToFetchedContent(e,i);}const a='"@@@cursor@@@"'===n;return this.promptHelper.formatFinalPrompt(o,n,i,a)}catch(e){return console.error(e),null}}}class R extends ckeditor5.Plugin{static get pluginName(){return "AiAgentEditing"}init(){const e=this.editor,t=new _(e);e.commands.add("aiAgent",new u(e,t)),this.setupEnterKeyHandling();}setupEnterKeyHandling(){const e=this.editor,t=e.model,n=e.editing.mapper,o=e.editing.view;e.keystrokes.set("enter",(async(i,s)=>{var r;const a=t.document.selection.getFirstPosition();if(a){const t=a.parent,i=Array.from(t.getChildren()).find((e=>"inline-slash"===e.name)),l=n.toViewElement(t);let c;l&&(c=null===(r=o.domConverter.mapViewToDom(l))||void 0===r?void 0:r.innerText),("string"==typeof c&&c.startsWith("/")||i)&&(s(),await e.execute("aiAgent"));}}));}}class D extends ckeditor5.Plugin{constructor(e){super(e),this.DEFAULT_GPT_MODEL="gpt-4o",this.DEFAULT_AI_END_POINT="https://api.openai.com/v1/chat/completions";const t=e.config.get("aiAgent")||{},n={...{model:this.DEFAULT_GPT_MODEL,apiKey:"",endpointUrl:this.DEFAULT_AI_END_POINT,temperature:void 0,timeOutDuration:45e3,maxTokens:c[this.DEFAULT_GPT_MODEL].max,retryAttempts:1,contextSize:.75*c[this.DEFAULT_GPT_MODEL].context,stopSequences:[],promptSettings:{outputFormat:[],contextData:[],filters:[]},debugMode:!1,streamContent:!0},...t};e.config.set("aiAgent",n),this.validateConfiguration(n);}static get requires(){return [h,R]}static get pluginName(){return "AiAgent"}validateConfiguration(e){if(!e.apiKey)throw new Error("AiAgent: apiKey is required.");if(e.temperature&&(e.temperature<0||e.temperature>2))throw new Error("AiAgent: Temperature must be a number between 0 and 2.");const{min:t,max:n}=c[e.model];if(e.maxTokens<t||e.maxTokens>n)throw new Error(`AiAgent: maxTokens must be a number between ${t} and ${n}.`)}init(){}}const M={ckeditor:"<svg width='68' height='64' viewBox='0 0 68 64' xmlns='http://www.w3.org/2000/svg'><g fill='none' fill-rule='evenodd'><path d='M43.71 11.025a11.508 11.508 0 0 0-1.213 5.159c0 6.42 5.244 11.625 11.713 11.625.083 0 .167 0 .25-.002v16.282a5.464 5.464 0 0 1-2.756 4.739L30.986 60.7a5.548 5.548 0 0 1-5.512 0L4.756 48.828A5.464 5.464 0 0 1 2 44.089V20.344c0-1.955 1.05-3.76 2.756-4.738L25.474 3.733a5.548 5.548 0 0 1 5.512 0l12.724 7.292z' fill='#FFF'/><path d='M45.684 8.79a12.604 12.604 0 0 0-1.329 5.65c0 7.032 5.744 12.733 12.829 12.733.091 0 .183-.001.274-.003v17.834a5.987 5.987 0 0 1-3.019 5.19L31.747 63.196a6.076 6.076 0 0 1-6.037 0L3.02 50.193A5.984 5.984 0 0 1 0 45.003V18.997c0-2.14 1.15-4.119 3.019-5.19L25.71.804a6.076 6.076 0 0 1 6.037 0L45.684 8.79zm-29.44 11.89c-.834 0-1.51.671-1.51 1.498v.715c0 .828.676 1.498 1.51 1.498h25.489c.833 0 1.51-.67 1.51-1.498v-.715c0-.827-.677-1.498-1.51-1.498h-25.49.001zm0 9.227c-.834 0-1.51.671-1.51 1.498v.715c0 .828.676 1.498 1.51 1.498h18.479c.833 0 1.509-.67 1.509-1.498v-.715c0-.827-.676-1.498-1.51-1.498H16.244zm0 9.227c-.834 0-1.51.671-1.51 1.498v.715c0 .828.676 1.498 1.51 1.498h25.489c.833 0 1.51-.67 1.51-1.498v-.715c0-.827-.677-1.498-1.51-1.498h-25.49.001zm41.191-14.459c-5.835 0-10.565-4.695-10.565-10.486 0-5.792 4.73-10.487 10.565-10.487C63.27 3.703 68 8.398 68 14.19c0 5.791-4.73 10.486-10.565 10.486v-.001z' fill='#1EBC61' fill-rule='nonzero'/><path d='M60.857 15.995c0-.467-.084-.875-.251-1.225a2.547 2.547 0 0 0-.686-.88 2.888 2.888 0 0 0-1.026-.531 4.418 4.418 0 0 0-1.259-.175c-.134 0-.283.006-.447.018-.15.01-.3.034-.446.07l.075-1.4h3.587v-1.8h-5.462l-.214 5.06c.319-.116.682-.21 1.089-.28.406-.071.77-.107 1.088-.107.218 0 .437.021.655.063.218.041.413.114.585.218s.313.244.422.419c.109.175.163.391.163.65 0 .424-.132.745-.396.961a1.434 1.434 0 0 1-.938.325c-.352 0-.656-.1-.912-.3-.256-.2-.43-.453-.523-.762l-1.925.588c.1.35.258.664.472.943.214.279.47.514.767.706.298.191.63.339.995.443.365.104.749.156 1.151.156.437 0 .86-.064 1.272-.193.41-.13.778-.323 1.1-.581a2.8 2.8 0 0 0 .775-.981c.193-.396.29-.864.29-1.405h-.001z' fill='#FFF' fill-rule='nonzero'/></g></svg>\n"};

	exports.AiAgent = D;
	exports.icons = M;

}));
//# sourceMappingURL=index.umd.js.map
